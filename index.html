<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Ann & Lawrence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Favicon - Golden Intertwined Hearts (Intimate Feel) -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='gold' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23facc15'/%3E%3Cstop offset='50%25' stop-color='%23f5d76e'/%3E%3Cstop offset='100%25' stop-color='%23facc15'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M35 30 C30 20 20 20 15 30 C15 40 25 50 35 70 C45 50 55 40 55 30 C50 20 40 20 35 30 Z' fill='url(%23gold)'/%3E%3Cpath d='M65 30 C60 20 50 20 45 30 C45 40 55 50 65 70 C75 50 85 40 85 30 C80 20 70 20 65 30 Z' fill='url(%23gold)'/%3E%3Cpath d='M50 50 C48 45 45 45 42 50 C42 55 46 60 50 65 C54 60 58 55 58 50 C55 45 52 45 50 50 Z' fill='%23facc15' opacity='0.8'/%3E%3C/svg%3E" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='gold' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23facc15'/%3E%3Cstop offset='50%25' stop-color='%23f5d76e'/%3E%3Cstop offset='100%25' stop-color='%23facc15'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M35 30 C30 20 20 20 15 30 C15 40 25 50 35 70 C45 50 55 40 55 30 C50 20 40 20 35 30 Z' fill='url(%23gold)'/%3E%3Cpath d='M65 30 C60 20 50 20 45 30 C45 40 55 50 65 70 C75 50 85 40 85 30 C80 20 70 20 65 30 Z' fill='url(%23gold)'/%3E%3Cpath d='M50 50 C48 45 45 45 42 50 C42 55 46 60 50 65 C54 60 58 55 58 50 C55 45 52 45 50 50 Z' fill='%23facc15' opacity='0.8'/%3E%3C/svg%3E" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Noto Sans TC", system-ui, sans-serif;
    }

    :root {
      --bg-black: #020617;
      --card-black: #020617;
      --panel-black: #050816;
      --border-gold: #facc15;
      --gold: #facc15;
      --gold-soft: #f5d76e;
      --text-main: #facc15;
      --text-sub: #e5e7eb;
      --text-muted: #9ca3af;
      --gray-border: #4b5563;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at top, rgba(250, 204, 21, 0.12), transparent 55%),
        radial-gradient(circle at bottom, rgba(148, 163, 184, 0.18), transparent 60%),
        var(--bg-black);
      color: var(--text-main);
      padding: 0;
      overflow-x: hidden;
    }

    /* Navigation Tabs */
    .nav-container {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(2, 6, 23, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(250, 204, 21, 0.3);
      padding: 12px 16px;
    }

    .nav-tabs {
      display: flex;
      gap: 8px;
      max-width: 600px;
      margin: 0 auto;
      justify-content: center;
    }

    .nav-tab {
      flex: 1;
      padding: 10px 16px;
      background: transparent;
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      min-width: 0;
    }

    .nav-tab:hover {
      border-color: rgba(250, 204, 21, 0.5);
      color: var(--text-sub);
    }

    .nav-tab.active {
      background: linear-gradient(135deg, rgba(250, 204, 21, 0.2), rgba(250, 204, 21, 0.1));
      border-color: var(--gold);
      color: var(--gold);
      box-shadow: 0 0 12px rgba(250, 204, 21, 0.3);
    }

    /* Page Container */
    .page-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px 16px;
      min-height: calc(100vh - 80px);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Story Plots Page Container - Full Width */
    .page-container.story-plots-active {
      max-width: 100%;
      padding: 20px;
      align-items: flex-start;
    }

    /* Hero Story Page Container - Full Width, No Padding */
    .page-container:has(#hero-story-page.active) {
      max-width: 100%;
      padding: 0;
      margin: 0;
      min-height: 100vh;
    }

    /* Fallback for browsers that don't support :has() */
    .page-container.hero-story-active {
      max-width: 100%;
      padding: 0;
      margin: 0;
      min-height: 100vh;
    }

    .page {
      display: none;
      animation: fadeIn 0.3s ease-in;
      width: 100%;
    }

    .page.active {
      display: block;
    }

    #role-draw-page.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* App Card Style */
    .app {
      background: radial-gradient(circle at top left, #030712, #020617 55%, #000000);
      border-radius: 20px;
      box-shadow:
        0 20px 55px rgba(0, 0, 0, 0.85),
        0 0 0 1px rgba(148, 163, 184, 0.3);
      padding: 22px 20px 26px;
      width: 100%;
      color: var(--text-main);
    }

    .app-header {
      text-align: center;
      margin-bottom: 16px;
    }

    .app-title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--gold);
    }

    .app-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    /* Card Styles */
    .card-wrapper {
      display: flex;
      justify-content: center;
      margin-top: 18px;
      margin-bottom: 8px;
    }

    .card {
      width: 100%;
      max-width: 280px;
      aspect-ratio: 16 / 9;
      border-radius: 18px;
      background:
        radial-gradient(circle at top left, rgba(250, 204, 21, 0.32), transparent 52%),
        radial-gradient(circle at bottom right, rgba(148, 163, 184, 0.22), transparent 55%),
        var(--card-black);
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(250, 204, 21, 0.4);
      color: var(--text-sub);
      padding: 14px 18px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(
        135deg,
        rgba(250, 204, 21, 0.3),
        transparent 40%,
        rgba(148, 163, 184, 0.10),
        transparent 75%
      );
      mix-blend-mode: screen;
      opacity: 0.7;
      pointer-events: none;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow:
        0 22px 46px rgba(0, 0, 0, 0.98),
        0 0 0 1px rgba(250, 204, 21, 0.65);
    }

    .card:active {
      transform: translateY(1px) scale(0.99);
      box-shadow:
        0 12px 26px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(250, 204, 21, 0.65);
    }

    .card-title {
      font-size: 11px;
      letter-spacing: 0.24em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 4px;
      position: relative;
      z-index: 1;
    }

    .card-main {
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      position: relative;
      z-index: 1;
      color: var(--gold-soft);
    }

    .card-hint {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-muted);
      position: relative;
      z-index: 1;
    }

    /* Story Plots Page - Full Width */
    #story-plots-page .app {
      max-width: 100%;
      width: 100%;
    }

    /* Story Cards Grid */
    .story-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 16px;
      margin-top: 20px;
      width: 100%;
    }

    .story-card {
      background:
        radial-gradient(circle at top left, rgba(250, 204, 21, 0.2), transparent 50%),
        var(--card-black);
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .story-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold), transparent);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .story-card:hover {
      transform: translateY(-4px);
      border-color: var(--gold);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
    }

    .story-card:hover::before {
      opacity: 1;
    }

    .story-card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .story-card-preview {
      font-size: 14px;
      color: var(--text-sub);
      line-height: 1.6;
      margin-bottom: 12px;
      position: relative;
      z-index: 1;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .story-card-meta {
      font-size: 12px;
      color: var(--text-muted);
      position: relative;
      z-index: 1;
    }

    /* Life Planning Page - Articles List */
    #life-planning-page .app {
      max-width: 100%;
      width: 100%;
    }

    /* Calendar Styles */
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 0;
      margin-top: 20px;
      border-bottom: 1px solid rgba(250, 204, 21, 0.2);
    }

    .calendar-nav-btn {
      width: 40px;
      height: 40px;
      background: rgba(250, 204, 21, 0.1);
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 8px;
      color: var(--gold);
      font-size: 24px;
      font-weight: 300;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .calendar-nav-btn:hover {
      background: rgba(250, 204, 21, 0.2);
      border-color: var(--gold);
      transform: scale(1.1);
    }

    .calendar-date-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      justify-content: center;
    }

    .date-selector-btn {
      background: rgba(250, 204, 21, 0.1);
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 8px;
      padding: 8px 16px;
      color: var(--gold);
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 60px;
    }

    .date-selector-btn:hover {
      background: rgba(250, 204, 21, 0.2);
      border-color: var(--gold);
      transform: translateY(-2px);
    }

    .date-separator {
      color: var(--text-muted);
      font-size: 16px;
    }

    .calendar-container {
      margin-top: 20px;
      position: relative;
      z-index: 1;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .weekday {
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      padding: 8px 0;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      position: relative;
      z-index: 1;
    }

    .calendar-day {
      aspect-ratio: 1;
      background: rgba(2, 6, 23, 0.4);
      border: 1px solid rgba(250, 204, 21, 0.2);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 8px 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      min-height: 60px;
      z-index: 1;
      pointer-events: auto !important;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    .calendar-day * {
      pointer-events: none;
    }

    .calendar-day:hover {
      background: rgba(250, 204, 21, 0.1);
      border-color: var(--gold);
      transform: translateY(-2px);
    }

    .calendar-day.other-month {
      opacity: 0.3;
      background: rgba(2, 6, 23, 0.2);
    }

    .calendar-day.today {
      border-color: var(--gold);
      background: rgba(250, 204, 21, 0.15);
      box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.3);
    }

    .calendar-day.has-articles {
      border-color: var(--gold);
      background: rgba(250, 204, 21, 0.2);
    }

    .calendar-day-number {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    .calendar-day.today .calendar-day-number {
      color: var(--gold);
      font-weight: 700;
    }

    .calendar-day-articles-count {
      font-size: 10px;
      color: var(--gold);
      background: rgba(250, 204, 21, 0.3);
      border-radius: 10px;
      padding: 2px 6px;
      margin-top: 4px;
    }

    /* Year/Month Selector Modal */
    .year-month-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
    }

    .year-month-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .year-month-modal-content {
      background: radial-gradient(circle at top left, #030712, #020617 55%, #000000);
      border: 1px solid rgba(250, 204, 21, 0.4);
      border-radius: 20px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .year-month-modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: 1px solid rgba(250, 204, 21, 0.4);
      color: var(--gold);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.2s ease;
    }

    .year-month-modal-close:hover {
      background: rgba(250, 204, 21, 0.1);
      border-color: var(--gold);
    }

    .year-month-modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 20px;
      text-align: center;
    }

    .year-month-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      max-height: 400px;
      overflow-y: auto;
    }

    .year-month-item {
      padding: 12px;
      background: rgba(250, 204, 21, 0.1);
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 8px;
      color: var(--text-sub);
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .year-month-item:hover {
      background: rgba(250, 204, 21, 0.2);
      border-color: var(--gold);
      color: var(--gold);
      transform: translateY(-2px);
    }

    .year-month-item.selected {
      background: linear-gradient(135deg, rgba(250, 204, 21, 0.3), rgba(250, 204, 21, 0.2));
      border-color: var(--gold);
      color: var(--gold);
      font-weight: 600;
    }

    /* Date Articles Container */
    .date-articles-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }
    
    .date-articles-container .date-articles-inner {
      max-width: 1200px;
      margin: 0 auto;
      background: radial-gradient(circle at top left, #030712, #020617 55%, #000000);
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 12px;
      padding: 24px;
      margin-top: 40px;
      margin-bottom: 40px;
    }

    .date-articles-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(250, 204, 21, 0.2);
    }

    .selected-date-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--gold);
      margin: 0;
    }

    .btn-close-articles {
      width: 32px;
      height: 32px;
      background: transparent;
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 50%;
      color: var(--gold);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .btn-close-articles:hover {
      background: rgba(250, 204, 21, 0.1);
      border-color: var(--gold);
    }

    .date-articles-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Schedule Section Styles */
    .schedule-section {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid rgba(250, 204, 21, 0.2);
    }

    .schedule-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .schedule-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gold);
      margin: 0;
    }

    .btn-add-schedule {
      background: rgba(250, 204, 21, 0.1);
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 8px;
      color: var(--gold);
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-add-schedule:hover {
      background: rgba(250, 204, 21, 0.2);
      border-color: var(--gold);
      transform: translateY(-2px);
    }

    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .schedule-item {
      background: rgba(2, 6, 23, 0.6);
      border: 1px solid rgba(250, 204, 21, 0.2);
      border-radius: 8px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      transition: all 0.2s ease;
    }

    .schedule-item:hover {
      border-color: rgba(250, 204, 21, 0.4);
      background: rgba(2, 6, 23, 0.8);
    }

    .schedule-item-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .schedule-item-time {
      font-size: 14px;
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 4px;
    }

    .schedule-item-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-sub);
      margin: 0;
    }

    .schedule-item-description {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.5;
      margin: 0;
    }

    .schedule-item-actions {
      display: flex;
      gap: 8px;
    }

    .schedule-item-btn {
      width: 32px;
      height: 32px;
      background: transparent;
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 6px;
      color: var(--gold);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .schedule-item-btn:hover {
      background: rgba(250, 204, 21, 0.1);
      border-color: var(--gold);
    }

    .schedule-item-btn.delete-btn {
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.3);
    }

    .schedule-item-btn.delete-btn:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
    }

    .articles-section {
      margin-top: 24px;
    }

    .articles-section-header {
      margin-bottom: 16px;
    }

    .articles-section-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gold);
      margin: 0;
    }

    /* Schedule Edit Modal */
    .schedule-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
    }

    .schedule-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .schedule-modal-content {
      background: radial-gradient(circle at top left, #030712, #020617 55%, #000000);
      border: 1px solid rgba(250, 204, 21, 0.4);
      border-radius: 20px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .schedule-modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: 1px solid rgba(250, 204, 21, 0.4);
      color: var(--gold);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.2s ease;
    }

    .schedule-modal-close:hover {
      background: rgba(250, 204, 21, 0.1);
      border-color: var(--gold);
    }

    .schedule-modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 20px;
      padding-right: 40px;
    }

    .schedule-form-group {
      margin-bottom: 16px;
    }

    .schedule-form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-sub);
      margin-bottom: 8px;
    }

    .schedule-form-input {
      width: 100%;
      padding: 12px 14px;
      background: rgba(2, 6, 23, 0.6);
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 8px;
      color: var(--text-sub);
      font-size: 14px;
      transition: all 0.2s ease;
      box-sizing: border-box;
    }

    .schedule-form-input:focus {
      outline: none;
      border-color: var(--gold);
      background: rgba(2, 6, 23, 0.8);
    }

    .schedule-form-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .schedule-btn-cancel,
    .schedule-btn-save {
      flex: 1;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .schedule-btn-cancel {
      background: transparent;
      border: 1px solid rgba(250, 204, 21, 0.3);
      color: var(--text-sub);
    }

    .schedule-btn-cancel:hover {
      background: rgba(250, 204, 21, 0.1);
      border-color: var(--gold);
      color: var(--gold);
    }

    .schedule-btn-save {
      background: linear-gradient(135deg, rgba(250, 204, 21, 0.3), rgba(250, 204, 21, 0.2));
      border: 1px solid var(--gold);
      color: var(--gold);
    }

    .schedule-btn-save:hover {
      background: linear-gradient(135deg, rgba(250, 204, 21, 0.4), rgba(250, 204, 21, 0.3));
      transform: translateY(-2px);
    }

    /* Hero Story Page - Full Width */
    #hero-story-page {
      width: 100%;
      max-width: 100%;
      padding: 0;
      margin: 0;
    }

    #hero-story-page.active {
      display: block;
    }

    /* Hero Section Layout */
    .hero-section {
      position: relative;
      width: 100%;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    /* Background Visuals Placeholder */
    .hero-background {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(circle at 20% 30%, rgba(250, 204, 21, 0.15), transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(250, 204, 21, 0.12), transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(148, 163, 184, 0.08), transparent 60%),
        var(--bg-black);
      z-index: 0;
    }

    /* Hero Content Block - Centered */
    .hero-content {
      position: relative;
      z-index: 1;
      max-width: 900px;
      width: 100%;
      padding: 60px 40px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
    }

    /* Hero Header */
    .hero-header {
      width: 100%;
    }

    /* Large Title */
    .hero-title {
      font-size: 42px;
      font-weight: 700;
      color: var(--gold);
      margin: 0 0 24px 0;
      letter-spacing: 0.05em;
      line-height: 1.3;
    }

    /* Medium Subtitle Paragraph */
    .hero-subtitle {
      font-size: 18px;
      color: var(--text-sub);
      line-height: 1.8;
      margin: 0;
      letter-spacing: 0.02em;
    }

    /* Hero Actions */
    .hero-actions {
      margin-top: 8px;
    }

    /* Primary CTA Button */
    .hero-cta-primary {
      padding: 16px 40px;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(135deg, #facc15, #f5d76e);
      color: #111827;
      border: 2px solid rgba(250, 204, 21, 0.5);
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(250, 204, 21, 0.3);
      letter-spacing: 0.05em;
    }

    .hero-cta-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(250, 204, 21, 0.4), 0 0 0 1px rgba(250, 204, 21, 0.5);
      background: linear-gradient(135deg, #f5d76e, #facc15);
    }

    .hero-cta-primary:active {
      transform: translateY(0);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    /* Hero Footer - Optional Small Secondary Text */
    .hero-footer {
      margin-top: 8px;
    }

    .hero-description {
      font-size: 14px;
      color: var(--text-muted);
      margin: 0;
      font-style: italic;
      letter-spacing: 0.01em;
    }

    /* Optional: Cover Illustration Placeholder */
    .hero-illustration {
      margin-top: 24px;
      width: 100%;
      max-width: 600px;
      height: 300px;
      /* Placeholder for cover illustration */
      background: radial-gradient(circle at center, rgba(250, 204, 21, 0.1), transparent 70%);
      border-radius: 16px;
      border: 1px dashed rgba(250, 204, 21, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 14px;
    }

    /* Lovense Interactive Game Page */
    #lovense-game-page .app {
      max-width: 100%;
      width: 100%;
    }

    .lovense-game-container {
      margin-top: 24px;
      width: 100%;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Connection Status */
    .connection-status {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: rgba(2, 6, 23, 0.6);
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: all 0.3s ease;
    }

    .status-indicator.connected {
      background: #10b981;
      box-shadow: 0 0 12px rgba(16, 185, 129, 0.5);
    }

    .status-indicator.connecting {
      background: var(--gold);
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    #status-text {
      color: var(--text-sub);
      font-size: 14px;
      font-weight: 500;
    }

    /* Connection Panel */
    .connection-panel {
      background: rgba(2, 6, 23, 0.4);
      border: 1px solid rgba(250, 204, 21, 0.2);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .btn-connect {
      width: 100%;
      padding: 12px 24px;
      background: linear-gradient(135deg, #facc15, #f5d76e);
      color: #111827;
      border: 1px solid rgba(250, 204, 21, 0.5);
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 16px;
    }

    .btn-connect:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(250, 204, 21, 0.3);
    }

    .btn-connect:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Control Panel */
    .control-panel {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .control-section {
      background: rgba(2, 6, 23, 0.4);
      border: 1px solid rgba(250, 204, 21, 0.2);
      border-radius: 12px;
      padding: 24px;
    }

    .control-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--gold);
      margin: 0 0 20px 0;
    }

    .control-group {
      margin-bottom: 20px;
    }

    .control-group label {
      display: block;
      font-size: 14px;
      color: var(--text-sub);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(148, 163, 184, 0.2);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--gold);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(250, 204, 21, 0.4);
      transition: all 0.2s ease;
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 4px 12px rgba(250, 204, 21, 0.6);
    }

    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--gold);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(250, 204, 21, 0.4);
    }

    .control-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .btn-control {
      flex: 1;
      padding: 12px 24px;
      background: rgba(250, 204, 21, 0.1);
      border: 1px solid rgba(250, 204, 21, 0.4);
      border-radius: 8px;
      color: var(--gold);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-control:hover {
      background: rgba(250, 204, 21, 0.2);
      border-color: var(--gold);
      transform: translateY(-2px);
    }

    .btn-control:active {
      transform: translateY(0);
    }

    .btn-control.active {
      background: linear-gradient(135deg, #facc15, #f5d76e);
      color: #111827;
      border-color: var(--gold);
    }

    /* Pattern Grid */
    .pattern-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .pattern-btn {
      padding: 12px 16px;
      background: rgba(250, 204, 21, 0.1);
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 8px;
      color: var(--text-sub);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .pattern-btn:hover {
      background: rgba(250, 204, 21, 0.2);
      border-color: var(--gold);
      color: var(--gold);
      transform: translateY(-2px);
    }

    .pattern-btn.active {
      background: linear-gradient(135deg, rgba(250, 204, 21, 0.3), rgba(250, 204, 21, 0.2));
      border-color: var(--gold);
      color: var(--gold);
    }

    /* Game Buttons */
    .game-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .game-btn {
      padding: 14px 24px;
      background: rgba(250, 204, 21, 0.1);
      border: 1px solid rgba(250, 204, 21, 0.4);
      border-radius: 8px;
      color: var(--gold);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .game-btn:hover {
      background: rgba(250, 204, 21, 0.2);
      border-color: var(--gold);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(250, 204, 21, 0.2);
    }

    .articles-container {
      margin-top: 24px;
      width: 100%;
    }

    .article-item {
      background: radial-gradient(circle at top left, rgba(250, 204, 21, 0.15), transparent 50%),
        var(--card-black);
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .article-item:hover {
      transform: translateY(-2px);
      border-color: var(--gold);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .article-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      gap: 16px;
    }

    .article-item-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gold);
      flex: 1;
      margin: 0;
    }

    .article-item-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .article-item-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid rgba(250, 204, 21, 0.4);
      background: rgba(2, 6, 23, 0.8);
      color: var(--gold);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.2s ease;
      backdrop-filter: blur(4px);
    }

    .article-item-btn:hover {
      background: rgba(250, 204, 21, 0.2);
      border-color: var(--gold);
      transform: scale(1.1);
    }

    .article-item-btn.delete-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
      color: #ef4444;
    }

    .article-item-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .article-item-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .article-item-meta-label {
      color: var(--text-muted);
      font-weight: 500;
    }

    .article-item-meta-value {
      color: var(--text-sub);
    }

    .article-item-content {
      font-size: 14px;
      color: var(--text-sub);
      line-height: 1.7;
      margin-top: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .add-article-btn {
      background: linear-gradient(135deg, rgba(250, 204, 21, 0.2), rgba(250, 204, 21, 0.1));
      border: 2px dashed rgba(250, 204, 21, 0.5);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--gold);
      font-size: 16px;
      font-weight: 600;
      margin-top: 20px;
    }

    .add-article-btn:hover {
      border-color: var(--gold);
      background: rgba(250, 204, 21, 0.15);
      transform: translateY(-2px);
    }

    .add-article-btn::before {
      content: "+";
      display: block;
      font-size: 32px;
      margin-bottom: 8px;
      font-weight: 300;
    }

    .story-card-actions {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .story-card-edit-btn,
    .story-card-delete-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid rgba(250, 204, 21, 0.4);
      background: rgba(2, 6, 23, 0.8);
      color: var(--gold);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.2s ease;
      backdrop-filter: blur(4px);
    }

    .story-card-edit-btn:hover {
      background: rgba(250, 204, 21, 0.2);
      border-color: var(--gold);
      transform: scale(1.1);
    }

    .story-card-delete-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
      color: #ef4444;
      transform: scale(1.1);
    }

    /* Floating Action Button for Add Story */
    .add-story-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #facc15, #f5d76e);
      border: 2px solid rgba(250, 204, 21, 0.5);
      color: #111827;
      font-size: 36px;
      font-weight: 300;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(250, 204, 21, 0.3);
      transition: all 0.3s ease;
      z-index: 999;
      line-height: 1;
    }

    .add-story-btn:hover {
      transform: scale(1.1) translateY(-2px);
      box-shadow: 0 12px 32px rgba(250, 204, 21, 0.4), 0 0 0 1px rgba(250, 204, 21, 0.5);
      background: linear-gradient(135deg, #f5d76e, #facc15);
    }

    .add-story-btn:active {
      transform: scale(0.95);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    /* Edit Modal Styles */
    .edit-form {
      padding: 24px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-group label {
      display: block;
      font-size: 15px;
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 10px;
      letter-spacing: 0.02em;
    }

    .form-input,
    .form-textarea {
      width: 100%;
      padding: 14px 16px;
      background: rgba(2, 6, 23, 0.7);
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 10px;
      color: var(--text-sub);
      font-size: 16px;
      font-family: inherit;
      transition: all 0.2s ease;
      line-height: 1.6;
      box-sizing: border-box;
    }

    .form-input::placeholder,
    .form-textarea::placeholder {
      color: var(--text-muted);
      opacity: 0.6;
    }

    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--gold);
      background: rgba(2, 6, 23, 0.85);
      box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.1);
    }

    .form-input {
      min-height: 48px;
    }

    .form-textarea {
      min-height: 300px;
      resize: vertical;
      line-height: 1.7;
      letter-spacing: 0.01em;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .btn-cancel,
    .btn-save {
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid;
    }

    .btn-cancel {
      background: transparent;
      border-color: rgba(148, 163, 184, 0.4);
      color: var(--text-muted);
    }

    .btn-cancel:hover {
      border-color: var(--text-muted);
      color: var(--text-sub);
    }

    .btn-save {
      background: linear-gradient(135deg, #facc15, #f5d76e);
      border-color: rgba(250, 204, 21, 0.7);
      color: #111827;
    }

    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(250, 204, 21, 0.3);
    }

    /* Modal for Story Details */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      z-index: 1000;
      padding: 0;
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
    }

    .modal.active {
      display: block;
    }

    .modal-content {
      background: radial-gradient(circle at top left, #030712, #020617 55%, #000000);
      border: none;
      border-radius: 0;
      padding: 0;
      min-height: 100vh;
      width: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .modal-close {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(2, 6, 23, 0.9);
      border: 1px solid rgba(250, 204, 21, 0.5);
      color: var(--gold);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.2s ease;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    .modal-close:hover {
      background: rgba(250, 204, 21, 0.2);
      border-color: var(--gold);
      transform: scale(1.1);
    }

    .modal-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--gold);
      margin: 0;
      padding: 80px 20px 30px;
      text-align: center;
      border-bottom: 1px solid rgba(250, 204, 21, 0.2);
      background: rgba(250, 204, 21, 0.05);
    }

    .modal-body {
      font-size: 16px;
      color: var(--text-sub);
      line-height: 1.9;
      white-space: pre-line;
      padding: 40px 20px;
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
      letter-spacing: 0.02em;
    }

    /* 文章内容样式 - 大标题 */
    .modal-body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Noto Sans TC", system-ui, sans-serif;
    }

    /* 使用CSS来样式化文本内容 */
    .modal-body {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    /* 通过JavaScript处理的样式类 */
    .article-main-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--gold);
      margin: 32px 0 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid rgba(250, 204, 21, 0.3);
      letter-spacing: 0.05em;
      text-align: center;
    }

    .article-main-title:first-child {
      margin-top: 0;
    }

    .article-chapter-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--gold-soft);
      margin: 32px 0 16px;
      padding: 12px 0 12px 12px;
      border-left: 4px solid rgba(250, 204, 21, 0.6);
      background: rgba(250, 204, 21, 0.05);
      letter-spacing: 0.03em;
    }

    .article-theme {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-muted);
      margin: 20px 0 16px;
      padding: 8px 0 8px 16px;
      border-left: 2px solid rgba(250, 204, 21, 0.3);
      font-style: italic;
      background: rgba(148, 163, 184, 0.05);
    }

    .article-content {
      font-size: 16px;
      color: var(--text-sub);
      line-height: 1.9;
      margin: 12px 0;
      padding: 0 4px;
      letter-spacing: 0.01em;
    }

    .article-role {
      font-size: 17px;
      font-weight: 600;
      color: var(--gold-soft);
      margin: 24px 0 12px;
      padding: 8px 12px;
      background: rgba(250, 204, 21, 0.08);
      border-radius: 6px;
      display: inline-block;
    }

    /* Shuffle Animation */
    @keyframes shuffle {
      0%   { transform: translateX(0) rotate(0deg); }
      25%  { transform: translateX(-6px) rotate(-2deg); }
      50%  { transform: translateX(6px) rotate(2deg); }
      75%  { transform: translateX(-3px) rotate(-1deg); }
      100% { transform: translateX(0) rotate(0deg); }
    }

    .card.shuffling {
      animation: shuffle 0.26s ease-in-out infinite;
    }

    /* Controls */
    .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }

    #draw-btn {
      border: 1px solid rgba(250, 204, 21, 0.7);
      outline: none;
      padding: 9px 26px;
      border-radius: 999px;
      background: linear-gradient(135deg, #facc15, #f5d76e);
      color: #111827;
      font-weight: 600;
      letter-spacing: 0.16em;
      cursor: pointer;
      font-size: 12px;
      box-shadow:
        0 10px 22px rgba(0, 0, 0, 0.95),
        0 0 0 1px rgba(250, 204, 21, 0.3);
      transition:
        transform 0.08s ease-out,
        box-shadow 0.08s ease-out,
        filter 0.08s ease-out;
      text-transform: uppercase;
    }

    #draw-btn:active {
      transform: translateY(2px);
      box-shadow:
        0 6px 14px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(250, 204, 21, 0.4);
      filter: brightness(0.95);
    }

    #draw-btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow:
        0 4px 10px rgba(0, 0, 0, 0.85),
        0 0 0 1px rgba(148, 163, 184, 0.6);
      background: linear-gradient(135deg, #facc15, #e5e7eb);
    }

    .result {
      margin-top: 4px;
      text-align: center;
      font-size: 14px;
      color: var(--text-muted);
    }

    .result-highlight {
      margin-top: 4px;
      font-size: 18px;
      font-weight: 700;
      color: var(--gold-soft);
      text-align: center;
    }

    .history {
      margin-top: 18px;
      padding-top: 12px;
      border-top: 1px solid rgba(148, 163, 184, 0.4);
    }

    .history-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 140px;
      overflow-y: auto;
      font-size: 13px;
      color: var(--text-sub);
    }

    .history-list li {
      padding: 4px 0;
      border-bottom: 1px dashed rgba(55, 65, 81, 0.7);
    }

    .history-list li:last-child {
      border-bottom: none;
    }

    /* Mobile Responsive */
    @media (max-width: 480px) {
      .page-container {
        padding: 16px 12px;
      }

      .page-container.story-plots-active {
        padding: 12px 8px;
      }

      .app {
        margin: 0;
        border-radius: 18px;
        padding: 18px 16px 22px;
      }

      .app-title {
        font-size: 20px;
        letter-spacing: 0.14em;
      }

      .card {
        max-width: 100%;
        padding: 14px;
      }

      .card-main {
        font-size: 18px;
      }

      #draw-btn {
        width: 100%;
        max-width: 260px;
      }

      .nav-tabs {
        gap: 6px;
      }

      .nav-tab {
        padding: 8px 12px;
        font-size: 13px;
      }

      .story-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .story-card {
        padding: 16px;
      }

      .story-card-title {
        font-size: 16px;
      }

      .article-item {
        padding: 16px;
        margin-bottom: 12px;
      }

      .article-item-title {
        font-size: 16px;
      }

      .article-item-header {
        flex-direction: column;
        gap: 12px;
      }

      .article-item-actions {
        align-self: flex-end;
      }

      .article-item-meta {
        flex-direction: column;
        gap: 8px;
        font-size: 12px;
      }

      .article-item-content {
        font-size: 13px;
        margin-top: 10px;
      }

      .add-article-btn {
        padding: 20px;
        font-size: 14px;
      }

      /* Schedule responsive styles */
      .schedule-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .btn-add-schedule {
        width: 100%;
        padding: 10px;
      }

      .schedule-item {
        flex-direction: column;
        gap: 12px;
      }

      .schedule-item-actions {
        align-self: flex-end;
      }

      .schedule-modal-content {
        max-width: 90%;
        padding: 20px;
      }

      .add-story-btn {
        width: 56px;
        height: 56px;
        bottom: 20px;
        right: 20px;
        font-size: 32px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(250, 204, 21, 0.3);
      }

      .add-story-btn:hover {
        transform: scale(1.05) translateY(-2px);
      }

      .hero-content {
        padding: 40px 20px;
        gap: 24px;
      }

      .hero-title {
        font-size: 28px;
        margin-bottom: 20px;
      }

      .hero-subtitle {
        font-size: 16px;
        line-height: 1.7;
      }

      .hero-cta-primary {
        padding: 14px 32px;
        font-size: 15px;
      }

      .hero-description {
        font-size: 13px;
      }

      .hero-illustration {
        height: 200px;
        margin-top: 20px;
      }

      /* Calendar responsive styles for mobile */
      .calendar-header {
        padding: 12px 0;
      }

      .calendar-nav-btn {
        width: 32px;
        height: 32px;
        font-size: 18px;
      }

      .date-selector-btn {
        padding: 6px 10px;
        font-size: 14px;
        min-width: 45px;
      }

      .date-separator {
        font-size: 14px;
      }

      .calendar-day {
        min-height: 45px;
        padding: 4px 2px;
      }

      .calendar-day-number {
        font-size: 11px;
      }

      .calendar-day-articles-count {
        font-size: 8px;
        padding: 1px 3px;
      }

      .year-month-grid {
        grid-template-columns: repeat(3, 1fr);
      }

      .year-month-item {
        padding: 10px;
        font-size: 13px;
      }

      /* Date Articles Container - Mobile */
      .date-articles-container {
        padding: 12px;
      }

      .date-articles-container .date-articles-inner {
        padding: 16px;
        margin-top: 20px;
        margin-bottom: 20px;
      }

      .selected-date-title {
        font-size: 20px;
      }

      .btn-close-articles {
        width: 28px;
        height: 28px;
        font-size: 18px;
      }

      .lovense-game-container {
        padding: 0 8px;
      }

      .connection-panel,
      .control-section {
        padding: 20px 16px;
      }

      .control-title {
        font-size: 16px;
        margin-bottom: 16px;
      }

      .pattern-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .pattern-btn {
        padding: 10px 12px;
        font-size: 13px;
      }

      .control-buttons {
        flex-direction: column;
      }

      .btn-control {
        width: 100%;
      }

      .modal-content {
        padding: 0;
        margin: 0;
        border-radius: 0;
      }

      .modal-title {
        font-size: 22px;
        padding: 70px 16px 24px;
      }

      .modal-body {
        font-size: 15px;
        padding: 24px 16px;
        line-height: 1.8;
      }

      .modal-close {
        top: 12px;
        right: 12px;
        width: 40px;
        height: 40px;
        font-size: 20px;
      }

      .article-main-title {
        font-size: 20px;
        margin: 24px 0 16px;
        padding-bottom: 12px;
      }

      .article-chapter-title {
        font-size: 18px;
        margin: 28px 0 12px;
        padding: 10px 0 10px 10px;
        border-left-width: 3px;
      }

      .article-theme {
        font-size: 14px;
        margin: 16px 0 12px;
        padding: 6px 0 6px 12px;
      }

      .article-content {
        font-size: 15px;
        line-height: 1.8;
        margin: 10px 0;
      }

      .article-role {
        font-size: 16px;
        margin: 20px 0 10px;
        padding: 6px 10px;
      }

      .story-card-actions {
        top: 8px;
        right: 8px;
        gap: 6px;
      }

      .story-card-edit-btn,
      .story-card-delete-btn {
        width: 28px;
        height: 28px;
        font-size: 12px;
      }

      .edit-form {
        padding: 20px 16px;
        max-width: 100%;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        font-size: 14px;
        margin-bottom: 8px;
      }

      .form-input,
      .form-textarea {
        padding: 12px 14px;
        font-size: 16px;
        border-radius: 8px;
        line-height: 1.6;
      }

      .form-input {
        min-height: 44px;
      }

      .form-textarea {
        min-height: 250px;
        line-height: 1.7;
      }

      .form-actions {
        flex-direction: column-reverse;
        gap: 8px;
      }

      .btn-cancel,
      .btn-save {
        width: 100%;
        padding: 12px;
      }
    }

    /* Tablet and Medium Screens */
    @media (min-width: 481px) and (max-width: 768px) {
      .story-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 14px;
      }

      .modal-body {
        max-width: 700px;
        padding: 40px 24px;
      }

      .modal-title {
        font-size: 26px;
        padding: 80px 24px 30px;
      }

      .edit-form {
        padding: 24px 20px;
        max-width: 100%;
      }

      .form-input,
      .form-textarea {
        font-size: 16px;
        padding: 13px 15px;
      }

      .form-textarea {
        min-height: 280px;
      }

      /* Date Articles Container - Tablet */
      .date-articles-container {
        padding: 16px;
      }

      .date-articles-container .date-articles-inner {
        padding: 20px;
        margin-top: 30px;
        margin-bottom: 30px;
      }

      .selected-date-title {
        font-size: 22px;
      }

      /* Calendar responsive styles */
      .calendar-header {
        padding: 16px 0;
      }

      .calendar-nav-btn {
        width: 36px;
        height: 36px;
        font-size: 20px;
      }

      .date-selector-btn {
        padding: 6px 12px;
        font-size: 16px;
        min-width: 50px;
      }

      .calendar-day {
        min-height: 50px;
        padding: 6px 2px;
      }

      .calendar-day-number {
        font-size: 12px;
      }

      .calendar-day-articles-count {
        font-size: 9px;
        padding: 1px 4px;
      }
    }

    /* Large Screens */
    @media (min-width: 769px) {
      .story-grid {
        grid-template-columns: repeat(6, 1fr);
        gap: 16px;
        width: 100%;
      }

      .modal-body {
        max-width: 800px;
        padding: 40px 32px;
      }

      .modal-title {
        font-size: 28px;
        padding: 80px 32px 30px;
      }

      .edit-form {
        padding: 32px;
        max-width: 900px;
      }

      .form-input,
      .form-textarea {
        font-size: 16px;
        padding: 14px 16px;
      }

      .form-textarea {
        min-height: 320px;
      }
    }

    /* Scrollbar Styling */
    .history-list::-webkit-scrollbar,
    .modal-content::-webkit-scrollbar {
      width: 6px;
    }

    .history-list::-webkit-scrollbar-track,
    .modal-content::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 3px;
    }

    .history-list::-webkit-scrollbar-thumb,
    .modal-content::-webkit-scrollbar-thumb {
      background: rgba(250, 204, 21, 0.4);
      border-radius: 3px;
    }

    .history-list::-webkit-scrollbar-thumb:hover,
    .modal-content::-webkit-scrollbar-thumb:hover {
      background: rgba(250, 204, 21, 0.6);
    }
  </style>
</head>
<body>
  <!-- Navigation Tabs -->
  <div class="nav-container">
    <div class="nav-tabs">
      <button class="nav-tab active" data-page="role-draw">角色抽籤</button>
      <button class="nav-tab" data-page="story-plots">故事劇情</button>
      <button class="nav-tab" data-page="life-planning">人生未來規劃</button>
      <button class="nav-tab" data-page="hero-story">關於</button>
      <button class="nav-tab" data-page="lovense-game">互動遊戲</button>
    </div>
  </div>

  <!-- Page Container -->
  <div class="page-container">
    <!-- Role Draw Page -->
    <div class="page active" id="role-draw-page">
      <div class="app">
        <div class="app-header">
          <div class="app-title">角色抽籤</div>
          <div class="app-subtitle">抽出今天要扮演的身分與傾向，其餘自己設計劇本</div>
        </div>
        <div class="card-wrapper">
          <div class="card" id="card">
            <div class="card-title">TAP TO DRAW</div>
            <div class="card-main" id="card-main">？</div>
            <div class="card-hint" id="card-hint">點擊卡牌或下方按鈕開始洗牌</div>
          </div>
        </div>
        <div class="controls">
          <button id="draw-btn">開始抽卡</button>
          <div class="result">抽到的角色：</div>
          <div class="result-highlight" id="result">尚未抽籤</div>
        </div>
        <div class="history">
          <div class="history-title">歷史紀錄</div>
          <ul class="history-list" id="history-list"></ul>
        </div>
      </div>
    </div>

    <!-- Story Plots Page -->
    <div class="page" id="story-plots-page">
      <div class="app">
        <div class="app-header">
          <div class="app-title">STORY PLOTS</div>
          <div class="app-subtitle">點擊卡片查看完整劇情內容</div>
        </div>
        <div class="story-grid" id="story-grid">
          <!-- Story cards will be generated here -->
        </div>
      </div>
    </div>

    <!-- Life Planning Page -->
    <div class="page" id="life-planning-page">
      <div class="app">
        <div class="app-header">
          <div class="app-title">人生未來規劃</div>
          <div class="app-subtitle">點擊日期新增或查看文章</div>
        </div>
        
        <!-- Calendar Header - Year and Month Selector -->
        <div class="calendar-header">
          <button class="calendar-nav-btn" id="prev-month-btn">‹</button>
          <div class="calendar-date-selector">
            <button class="date-selector-btn" id="year-selector-btn">
              <span id="current-year">2024</span>
            </button>
            <span class="date-separator">年</span>
            <button class="date-selector-btn" id="month-selector-btn">
              <span id="current-month">1</span>
            </button>
            <span class="date-separator">月</span>
          </div>
          <button class="calendar-nav-btn" id="next-month-btn">›</button>
        </div>

        <!-- Calendar Grid -->
        <div class="calendar-container">
          <div class="calendar-weekdays">
            <div class="weekday">日</div>
            <div class="weekday">一</div>
            <div class="weekday">二</div>
            <div class="weekday">三</div>
            <div class="weekday">四</div>
            <div class="weekday">五</div>
            <div class="weekday">六</div>
          </div>
          <div class="calendar-grid" id="calendar-grid">
            <!-- Calendar days will be generated here -->
          </div>
        </div>

        <!-- Articles List for Selected Date -->
        <div class="date-articles-container" id="date-articles-container" style="display: none;">
          <div class="date-articles-inner">
            <div class="date-articles-header">
              <h3 class="selected-date-title" id="selected-date-title"></h3>
              <button class="btn-close-articles" id="btn-close-articles">×</button>
            </div>
            
            <!-- Schedule Section -->
            <div class="schedule-section">
              <div class="schedule-header">
                <h4 class="schedule-title">時程安排</h4>
                <button class="btn-add-schedule" id="btn-add-schedule">+ 新增行程</button>
              </div>
              <div class="schedule-list" id="schedule-list">
                <!-- Schedule items will be generated here -->
              </div>
            </div>
            
            <!-- Articles Section -->
            <div class="articles-section">
              <div class="articles-section-header">
                <h4 class="articles-section-title">文章</h4>
              </div>
              <div class="date-articles-list" id="date-articles-list">
                <!-- Articles for selected date will be shown here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hero Story Page -->
    <div class="page" id="hero-story-page">
      <section class="hero-section">
        <!-- Background visuals placeholder - apply dynamic, cinematic gradient background with energetic flowing particles, soft motion trails, subtle depth, futuristic but warm atmosphere, symbolizing renewal and intertwined life paths -->
        <div class="hero-background"></div>
        
        <div class="hero-content">
          <header class="hero-header">
            <h1 class="hero-title">Ann & Lawrence</h1>
            <p class="hero-subtitle">
              這是 Ann & Lawrence 的人生規劃書。<br>
              在各自經歷六年的曲折感情歷練後，<br>
              Ann & Lawrence 終於重新邂逅，<br>
              在這裡重新出發，展開新的愛情與人生。
            </p>
          </header>
          
          <div class="hero-actions">
            <button class="hero-cta-primary" id="hero-start-reading-btn">開始閱讀</button>
          </div>
          
          <footer class="hero-footer">
            <p class="hero-description">一段重新開始的愛情故事，記錄著兩人的成長與未來規劃</p>
          </footer>
          
          <!-- Optional: Cover illustration placeholder -->
          <div class="hero-illustration">
            <!-- Placeholder for cover illustration -->
          </div>
        </div>
      </section>
    </div>

    <!-- Lovense Interactive Game Page -->
    <div class="page" id="lovense-game-page">
      <div class="app">
        <div class="app-header">
          <div class="app-title">互動遊戲</div>
          <div class="app-subtitle">連接 Lovense 設備進行互動控制</div>
        </div>
        
        <div class="lovense-game-container">
          <!-- Connection Status -->
          <div class="connection-status" id="connection-status">
            <div class="status-indicator" id="status-indicator"></div>
            <span id="status-text">未連接</span>
          </div>

          <!-- Connection Settings -->
          <div class="connection-panel">
            <div class="form-group">
              <label for="webhook-url">Webhook URL</label>
              <input type="text" id="webhook-url" class="form-input" placeholder="輸入你的 Webhook 端點 URL">
            </div>
            <div class="form-group">
              <label for="device-token">設備 Token (可選)</label>
              <input type="text" id="device-token" class="form-input" placeholder="Lovense 設備 Token">
            </div>
            <button class="btn-connect" id="btn-connect">連接設備</button>
          </div>

          <!-- Control Panel -->
          <div class="control-panel" id="control-panel" style="display: none;">
            <div class="control-section">
              <h3 class="control-title">振動控制</h3>
              
              <div class="control-group">
                <label for="vibration-intensity">強度: <span id="intensity-value">50</span>%</label>
                <input type="range" id="vibration-intensity" min="0" max="100" value="50" class="slider">
              </div>

              <div class="control-group">
                <label for="vibration-duration">持續時間: <span id="duration-value">3</span> 秒</label>
                <input type="range" id="vibration-duration" min="1" max="30" value="3" class="slider">
              </div>

              <div class="control-buttons">
                <button class="btn-control" id="btn-start">開始振動</button>
                <button class="btn-control" id="btn-stop">停止</button>
              </div>
            </div>

            <div class="control-section">
              <h3 class="control-title">預設模式</h3>
              <div class="pattern-grid">
                <button class="pattern-btn" data-pattern="gentle">輕柔</button>
                <button class="pattern-btn" data-pattern="medium">中等</button>
                <button class="pattern-btn" data-pattern="strong">強烈</button>
                <button class="pattern-btn" data-pattern="wave">波浪</button>
                <button class="pattern-btn" data-pattern="pulse">脈衝</button>
                <button class="pattern-btn" data-pattern="random">隨機</button>
              </div>
            </div>

            <div class="control-section">
              <h3 class="control-title">互動遊戲</h3>
              <div class="game-buttons">
                <button class="game-btn" id="btn-game-1">節奏遊戲</button>
                <button class="game-btn" id="btn-game-2">反應測試</button>
                <button class="game-btn" id="btn-game-3">隨機刺激</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Story Detail Modal -->
  <div class="modal" id="story-modal">
    <div class="modal-content">
      <button class="modal-close" id="modal-close">&times;</button>
      <div class="modal-title" id="modal-title"></div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <!-- Edit/Add Story Modal -->
  <div class="modal" id="edit-story-modal">
    <div class="modal-content">
      <button class="modal-close" id="edit-modal-close">&times;</button>
      <div class="modal-title" id="edit-modal-title">新增故事</div>
      <div class="edit-form">
        <div class="form-group">
          <label for="edit-story-title">標題</label>
          <input type="text" id="edit-story-title" class="form-input" placeholder="輸入故事標題">
        </div>
        <div class="form-group">
          <label for="edit-story-preview">預覽文字</label>
          <textarea id="edit-story-preview" class="form-textarea" rows="2" placeholder="輸入預覽文字（會顯示在卡片上）"></textarea>
        </div>
        <div class="form-group">
          <label for="edit-story-content">完整內容</label>
          <textarea id="edit-story-content" class="form-textarea" rows="15" placeholder="輸入完整故事內容"></textarea>
        </div>
        <div class="form-actions">
          <button class="btn-cancel" id="btn-cancel">取消</button>
          <button class="btn-save" id="btn-save">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button for Add Story -->
  <button class="add-story-btn" id="floating-add-story-btn" title="新增故事">+</button>

  <!-- Edit/Add Article Modal -->
  <div class="modal" id="edit-article-modal">
    <div class="modal-content">
      <button class="modal-close" id="edit-article-modal-close">&times;</button>
      <div class="modal-title" id="edit-article-modal-title">新增文章</div>
      <div class="edit-form">
        <div class="form-group">
          <label for="edit-article-title">標題</label>
          <input type="text" id="edit-article-title" class="form-input" placeholder="輸入文章標題">
        </div>
        <div class="form-group">
          <label for="edit-article-author">作者</label>
          <input type="text" id="edit-article-author" class="form-input" placeholder="輸入作者名稱">
        </div>
        <div class="form-group">
          <label for="edit-article-content">內容</label>
          <textarea id="edit-article-content" class="form-textarea" rows="15" placeholder="輸入文章內容"></textarea>
        </div>
        <div class="form-actions">
          <button class="btn-cancel" id="btn-article-cancel">取消</button>
          <button class="btn-save" id="btn-article-save">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Year/Month Selector Modal -->
  <div class="year-month-modal" id="year-month-modal">
    <div class="year-month-modal-content">
      <button class="year-month-modal-close" id="year-month-modal-close">&times;</button>
      <div class="year-month-modal-title" id="year-month-modal-title">選擇年份</div>
      <div class="year-month-grid" id="year-month-grid">
        <!-- Year/Month items will be generated here -->
      </div>
    </div>
  </div>

  <!-- Schedule Edit/Add Modal -->
  <div class="schedule-modal" id="schedule-modal">
    <div class="schedule-modal-content">
      <button class="schedule-modal-close" id="schedule-modal-close">&times;</button>
      <div class="schedule-modal-title" id="schedule-modal-title">新增行程</div>
      <div class="schedule-form">
        <div class="schedule-form-group">
          <label for="schedule-time">時間</label>
          <input type="time" id="schedule-time" class="schedule-form-input" required>
        </div>
        <div class="schedule-form-group">
          <label for="schedule-title">標題</label>
          <input type="text" id="schedule-title" class="schedule-form-input" placeholder="輸入行程標題" required>
        </div>
        <div class="schedule-form-group">
          <label for="schedule-description">描述</label>
          <textarea id="schedule-description" class="schedule-form-input" rows="4" placeholder="輸入行程描述（選填）"></textarea>
        </div>
        <div class="schedule-form-actions">
          <button class="schedule-btn-cancel" id="schedule-btn-cancel">取消</button>
          <button class="schedule-btn-save" id="schedule-btn-save">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize Supabase
    const SUPABASE_URL = 'https://olqgjmuadoohbkplvhhd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9scWdqbXVhZG9vaGJrcGx2aGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MDgxNDcsImV4cCI6MjA4MDQ4NDE0N30.QOVguUcqG_h7l-ZTE6U9qOT9DejGOr6pdnEMBoBqxbo';
    
    let supabase = null;
    try {
      if (window.supabase) {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase 连接成功');
      } else {
        console.error('Supabase 库未加载');
      }
    } catch (error) {
      console.error('Supabase 初始化失败:', error);
    }

    // Navigation System
    const navTabs = document.querySelectorAll('.nav-tab');
    const pages = document.querySelectorAll('.page');

    const pageContainer = document.querySelector('.page-container');
    
    navTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const targetPage = tab.getAttribute('data-page');
        
        // Update active tab
        navTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update active page
        pages.forEach(p => p.classList.remove('active'));
        document.getElementById(`${targetPage}-page`).classList.add('active');
        
        // Update page container for story-plots, life-planning, hero-story, and lovense-game pages (full width)
        if (targetPage === 'story-plots' || targetPage === 'life-planning' || targetPage === 'hero-story' || targetPage === 'lovense-game') {
          pageContainer.classList.add('story-plots-active');
        } else {
          pageContainer.classList.remove('story-plots-active');
        }
        
        // Special handling for hero-story page (no padding)
        if (targetPage === 'hero-story') {
          pageContainer.classList.add('hero-story-active');
        } else {
          pageContainer.classList.remove('hero-story-active');
        }
        
        // Initialize articles when switching to life-planning page
        if (targetPage === 'life-planning') {
          // Wait a bit for the page to be visible, then render calendar
          setTimeout(async () => {
            // Check if calendar grid exists
            const calendarGrid = document.getElementById('calendar-grid');
            if (calendarGrid) {
              // Load data and render
              await initArticles();
              // Force re-render to ensure events are bound
              renderCalendar();
            } else {
              console.error('Calendar grid not found when switching to life-planning page');
              // Try again after longer delay
              setTimeout(async () => {
                await initArticles();
                renderCalendar();
              }, 200);
            }
          }, 100);
        }
        
        // Initialize Lovense game when switching to lovense-game page
        if (targetPage === 'lovense-game') {
          initLovenseGame();
        }
        
        // Show/hide floating add story button
        const floatingBtn = document.getElementById('floating-add-story-btn');
        if (floatingBtn) {
          if (targetPage === 'story-plots') {
            floatingBtn.style.display = 'flex';
          } else {
            floatingBtn.style.display = 'none';
          }
        }
      });
    });

    // Role Draw System
    const jobs = [
      "廚師", "調酒師", "咖啡師", "餐廳服務生", "外送員", "飲料店店員", "烘焙師",
      "造型師", "美髮師", "化妝師", "美甲師", "服飾店員", "模特兒",
      "建築師", "室內設計師", "房仲業務", "水電工", "清潔人員",
      "計程車司機", "公車司機", "客運司機", "鐵路員工", "飛行員", "空服員", "物流／倉儲人員",
      "小學生", "國中生", "高中生", "大學生",
      "幼教老師", "小學老師", "國中老師", "高中老師", "大學教授", "補習班老師", "家教", "教練",
      "演員", "攝影師", "導演",
      "工程師",
      "行銷人員", "業務", "客服", "人資", "財務／會計", "行政助理", "公關", "企劃",
      "超商店員", "超市員工", "百貨專櫃", "書店店員", "電影院員工",
      "飯店櫃檯", "房務員", "導遊", "領隊", "觀光接待",
      "社工",
      "醫生", "護士", "心理諮商師"
    ];

    const roles = ["S", "M"];
    const card = document.getElementById("card");
    const cardMain = document.getElementById("card-main");
    const cardHint = document.getElementById("card-hint");
    const drawBtn = document.getElementById("draw-btn");
    const resultEl = document.getElementById("result");
    const historyList = document.getElementById("history-list");
    let isDrawing = false;

    function randomSM() {
      return roles[Math.floor(Math.random() * roles.length)];
    }

    function drawCard() {
      if (isDrawing) return;
      isDrawing = true;
      drawBtn.disabled = true;
      card.classList.add("shuffling");
      cardMain.textContent = "…";
      cardHint.textContent = "洗牌中";

      const shuffleDuration = 900;
      const intervalTime = 90;
      let elapsed = 0;

      const shuffleTimer = setInterval(() => {
        const randomJob = jobs[Math.floor(Math.random() * jobs.length)];
        const tempRole = randomSM();
        cardMain.textContent = `${randomJob}（${tempRole}）`;
        elapsed += intervalTime;

        if (elapsed >= shuffleDuration) {
          clearInterval(shuffleTimer);
          const chosenJob = jobs[Math.floor(Math.random() * jobs.length)];
          const chosenRole = randomSM();
          const displayText = `${chosenJob}（${chosenRole}）`;

          setTimeout(() => {
            card.classList.remove("shuffling");
            cardMain.textContent = displayText;
            cardHint.textContent = "今天抽到的角色";
            resultEl.textContent = displayText;
            
            const li = document.createElement("li");
            li.textContent = displayText;
            historyList.prepend(li);
            
            isDrawing = false;
            drawBtn.disabled = false;
          }, 130);
        }
      }, intervalTime);
    }

    card.addEventListener("click", drawCard);
    drawBtn.addEventListener("click", drawCard);

    // Story Plots System
    // Stories array - will be loaded from Supabase
    let stories = [];

    // Supabase CRUD Functions
    async function loadStories() {
      if (!supabase) {
        console.warn('Supabase 未初始化，返回空数组');
        return [];
      }
      
      try {
        const { data, error } = await supabase
          .from('stories')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('加载故事失败:', error);
          // Don't show error alert, just log it
          return [];
        }
        return data || [];
      } catch (error) {
        console.error('加载故事异常:', error);
        return [];
      }
    }

    async function addStory(title, preview, content) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法新增故事');
        return null;
      }
      
      try {
        const { data, error } = await supabase
          .from('stories')
          .insert([
            { title, preview, content }
          ])
          .select();
        
        if (error) {
          console.error('新增故事失败:', error);
          return null;
        }
        return data[0];
      } catch (error) {
        console.error('新增故事异常:', error);
        return null;
      }
    }

    async function updateStory(id, title, preview, content) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法更新故事');
        return null;
      }
      
      try {
        const { data, error } = await supabase
          .from('stories')
          .update({ 
            title, 
            preview, 
            content, 
            updated_at: new Date().toISOString() 
          })
          .eq('id', id)
          .select();
        
        if (error) {
          console.error('更新故事失败:', error);
          return null;
        }
        return data[0];
      } catch (error) {
        console.error('更新故事异常:', error);
        return null;
      }
    }

    async function deleteStory(id) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法删除故事');
        return false;
      }
      
      try {
        const { error } = await supabase
          .from('stories')
          .delete()
          .eq('id', id);
        
        if (error) {
          console.error('删除故事失败:', error);
          return false;
        }
        return true;
      } catch (error) {
        console.error('删除故事异常:', error);
        return false;
      }
    }

    function showError(message) {
      alert('错误: ' + message);
      // 可以替换为更美观的提示组件
    }

    // Life Planning Articles CRUD Functions
    let articles = [];
    
    // Schedules CRUD Functions
    let schedules = [];

    async function loadArticles() {
      if (!supabase) {
        console.warn('Supabase 未初始化，返回空数组');
        return [];
      }
      
      try {
        const { data, error } = await supabase
          .from('life_planning_articles')
          .select('*')
          .order('updated_at', { ascending: false });
        
        if (error) {
          console.error('加载文章失败:', error);
          return [];
        }
        return data || [];
      } catch (error) {
        console.error('加载文章异常:', error);
        return [];
      }
    }

    async function addArticle(title, author, content, date) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法新增文章');
        return null;
      }
      
      try {
        // Convert date string (YYYY-MM-DD) to ISO string
        const dateISO = date ? new Date(date + 'T00:00:00').toISOString() : new Date().toISOString();
        
        const { data, error } = await supabase
          .from('life_planning_articles')
          .insert([
            { title, author, content, date: dateISO }
          ])
          .select();
        
        if (error) {
          console.error('新增文章失败:', error);
          return null;
        }
        return data[0];
      } catch (error) {
        console.error('新增文章异常:', error);
        return null;
      }
    }

    async function updateArticle(id, title, author, content, date) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法更新文章');
        return null;
      }
      
      try {
        // Convert date string (YYYY-MM-DD) to ISO string
        const dateISO = date ? new Date(date + 'T00:00:00').toISOString() : new Date().toISOString();
        
        const { data, error } = await supabase
          .from('life_planning_articles')
          .update({ 
            title, 
            author,
            content,
            date: dateISO,
            updated_at: new Date().toISOString() 
          })
          .eq('id', id)
          .select();
        
        if (error) {
          console.error('更新文章失败:', error);
          return null;
        }
        return data[0];
      } catch (error) {
        console.error('更新文章异常:', error);
        return null;
      }
    }

    async function deleteArticle(id) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法删除文章');
        return false;
      }
      
      try {
        const { error } = await supabase
          .from('life_planning_articles')
          .delete()
          .eq('id', id);
        
        if (error) {
          console.error('删除文章失败:', error);
          return false;
        }
        return true;
      } catch (error) {
        console.error('删除文章异常:', error);
        return false;
      }
    }

    function formatDateTime(dateString) {
      if (!dateString) return '未知';
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    // Schedules CRUD Functions
    async function loadSchedules() {
      if (!supabase) {
        console.warn('Supabase 未初始化，返回空数组');
        return [];
      }
      
      try {
        const { data, error } = await supabase
          .from('life_planning_schedules')
          .select('*')
          .order('time', { ascending: true });
        
        if (error) {
          console.error('加载时程安排失败:', error);
          return [];
        }
        return data || [];
      } catch (error) {
        console.error('加载时程安排异常:', error);
        return [];
      }
    }

    async function addSchedule(date, time, title, description) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法新增时程安排');
        return null;
      }
      
      try {
        // Convert date string (YYYY-MM-DD) to ISO string
        const dateISO = date ? new Date(date + 'T00:00:00').toISOString() : new Date().toISOString();
        
        const { data, error } = await supabase
          .from('life_planning_schedules')
          .insert([
            { date: dateISO, time, title, description: description || '' }
          ])
          .select();
        
        if (error) {
          console.error('新增时程安排失败:', error);
          return null;
        }
        return data[0];
      } catch (error) {
        console.error('新增时程安排异常:', error);
        return null;
      }
    }

    async function updateSchedule(id, date, time, title, description) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法更新时程安排');
        return null;
      }
      
      try {
        // Convert date string (YYYY-MM-DD) to ISO string
        const dateISO = date ? new Date(date + 'T00:00:00').toISOString() : new Date().toISOString();
        
        const { data, error } = await supabase
          .from('life_planning_schedules')
          .update({ 
            date: dateISO,
            time,
            title,
            description: description || '',
            updated_at: new Date().toISOString() 
          })
          .eq('id', id)
          .select();
        
        if (error) {
          console.error('更新时程安排失败:', error);
          return null;
        }
        return data[0];
      } catch (error) {
        console.error('更新时程安排异常:', error);
        return null;
      }
    }

    async function deleteSchedule(id) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法删除时程安排');
        return false;
      }
      
      try {
        const { error } = await supabase
          .from('life_planning_schedules')
          .delete()
          .eq('id', id);
        
        if (error) {
          console.error('删除时程安排失败:', error);
          return false;
        }
        return true;
      } catch (error) {
        console.error('删除时程安排异常:', error);
        return false;
      }
    }

    // Calendar state
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1; // 1-12
    let selectedDate = null;

    // Calendar functions
    function renderCalendar() {
      const calendarGrid = document.getElementById('calendar-grid');
      if (!calendarGrid) {
        console.warn('Calendar grid not found, calendar may not be visible yet');
        // Try again after a short delay
        setTimeout(() => {
          const retryGrid = document.getElementById('calendar-grid');
          if (retryGrid) {
            console.log('Retrying calendar render...');
            renderCalendar();
          }
        }, 100);
        return;
      }
      
      console.log('Rendering calendar for', currentYear, '年', currentMonth, '月');
      
      calendarGrid.innerHTML = '';
      
      // Update header
      document.getElementById('current-year').textContent = currentYear;
      document.getElementById('current-month').textContent = currentMonth;
      
      // Get first day of month and number of days
      const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
      const daysInPrevMonth = new Date(currentYear, currentMonth - 1, 0).getDate();
      
      // Get today's date
      const today = new Date();
      const isCurrentMonth = today.getFullYear() === currentYear && today.getMonth() + 1 === currentMonth;
      const todayDate = today.getDate();
      
      // Group articles by date
      const articlesByDate = {};
      articles.forEach(article => {
        const articleDate = new Date(article.date || article.created_at);
        const dateKey = `${articleDate.getFullYear()}-${String(articleDate.getMonth() + 1).padStart(2, '0')}-${String(articleDate.getDate()).padStart(2, '0')}`;
        if (!articlesByDate[dateKey]) {
          articlesByDate[dateKey] = [];
        }
        articlesByDate[dateKey].push(article);
      });
      
      // Previous month days
      for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        const dayElement = createCalendarDay(day, true, null, currentYear, currentMonth - 1);
        calendarGrid.appendChild(dayElement);
      }
      
      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayArticles = articlesByDate[dateKey] || [];
        const isToday = isCurrentMonth && day === todayDate;
        const dayElement = createCalendarDay(day, false, dayArticles, currentYear, currentMonth);
        if (isToday) {
          dayElement.classList.add('today');
        }
        if (dayArticles.length > 0) {
          dayElement.classList.add('has-articles');
        }
        calendarGrid.appendChild(dayElement);
      }
      
      // Next month days (fill remaining cells)
      const totalCells = calendarGrid.children.length;
      const remainingCells = 42 - totalCells; // 6 rows * 7 days
      for (let day = 1; day <= remainingCells; day++) {
        const dayElement = createCalendarDay(day, true, null, currentYear, currentMonth + 1);
        calendarGrid.appendChild(dayElement);
      }
      
      // Debug: Log calendar rendering status
      const clickableDays = calendarGrid.querySelectorAll('.calendar-day:not(.other-month)');
      console.log(`Calendar rendered: ${clickableDays.length} clickable days created`);
      
      // Test: Verify event listeners are attached
      if (clickableDays.length > 0) {
        const firstDay = clickableDays[0];
        const dateAttr = firstDay.getAttribute('data-date');
        console.log('First clickable day:', dateAttr, 'Has click handler:', firstDay.onclick !== null || firstDay.hasAttribute('data-date'));
      }
    }
    
    function createCalendarDay(day, isOtherMonth, dayArticles, year, month) {
      const dayElement = document.createElement('div');
      dayElement.className = 'calendar-day';
      if (isOtherMonth) {
        dayElement.classList.add('other-month');
      }
      
      // 创建内部元素
      const dayNumber = document.createElement('div');
      dayNumber.className = 'calendar-day-number';
      dayNumber.textContent = day;
      dayElement.appendChild(dayNumber);
      
      if (dayArticles && dayArticles.length > 0) {
        const articlesCount = document.createElement('div');
        articlesCount.className = 'calendar-day-articles-count';
        articlesCount.textContent = dayArticles.length;
        dayElement.appendChild(articlesCount);
      }
      
      if (!isOtherMonth) {
        const dateKey = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // 确保可以点击 - 设置样式
        dayElement.style.cursor = 'pointer';
        dayElement.style.pointerEvents = 'auto';
        dayElement.style.userSelect = 'none';
        dayElement.setAttribute('data-date', dateKey);
        dayElement.setAttribute('role', 'button');
        dayElement.setAttribute('tabindex', '0');
        
        // 点击事件
        const clickHandler = (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('Date clicked:', dateKey, 'Element:', dayElement);
          handleDateClick(dateKey, dayArticles || []);
        };
        
        dayElement.addEventListener('click', clickHandler);
        
        // 键盘事件支持
        dayElement.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            clickHandler(e);
          }
        });
        
        // 触摸事件支持（移动设备）
        dayElement.addEventListener('touchend', (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('Date touched:', dateKey);
          handleDateClick(dateKey, dayArticles || []);
        });
        
        // 防止内部元素阻止点击
        dayNumber.style.pointerEvents = 'none';
        if (dayElement.querySelector('.calendar-day-articles-count')) {
          dayElement.querySelector('.calendar-day-articles-count').style.pointerEvents = 'none';
        }
      }
      
      return dayElement;
    }
    
    function handleDateClick(dateKey, dateArticles) {
      try {
        console.log('handleDateClick called with:', dateKey);
        selectedDate = dateKey;
        const [year, month, day] = dateKey.split('-');
        const dateTitle = `${year}年${parseInt(month)}月${parseInt(day)}日`;
        
        // Re-filter articles for this date to ensure we have the latest list
        const filteredArticles = (articles || []).filter(article => {
          try {
            const articleDate = new Date(article.date || article.created_at);
            const articleDateKey = `${articleDate.getFullYear()}-${String(articleDate.getMonth() + 1).padStart(2, '0')}-${String(articleDate.getDate()).padStart(2, '0')}`;
            return articleDateKey === dateKey;
          } catch (e) {
            console.error('Error filtering article:', e);
            return false;
          }
        });
        
        // Filter schedules for this date
        const filteredSchedules = (schedules || []).filter(schedule => {
          try {
            if (!schedule || !schedule.date) return false;
            const scheduleDate = new Date(schedule.date);
            const scheduleDateKey = `${scheduleDate.getFullYear()}-${String(scheduleDate.getMonth() + 1).padStart(2, '0')}-${String(scheduleDate.getDate()).padStart(2, '0')}`;
            return scheduleDateKey === dateKey;
          } catch (e) {
            console.error('Error filtering schedule:', e);
            return false;
          }
        });
        
        const dateTitleEl = document.getElementById('selected-date-title');
        const dateContainerEl = document.getElementById('date-articles-container');
        
        if (!dateTitleEl || !dateContainerEl) {
          console.error('Required elements not found:', { dateTitleEl, dateContainerEl });
          alert('無法找到必要的元素，請刷新頁面重試');
          return;
        }
        
        dateTitleEl.textContent = dateTitle;
        renderSchedules(filteredSchedules);
        renderDateArticles(filteredArticles);
        dateContainerEl.style.display = 'block';
        
        // Scroll to the container
        dateContainerEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        console.log('Date clicked successfully:', dateTitle);
      } catch (error) {
        console.error('Error in handleDateClick:', error);
        alert('點擊日期時發生錯誤：' + error.message);
      }
    }
    
    function renderSchedules(dateSchedules) {
      const scheduleList = document.getElementById('schedule-list');
      if (!scheduleList) return;
      
      scheduleList.innerHTML = '';
      
      if (dateSchedules.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.style.textAlign = 'center';
        emptyMsg.style.color = 'var(--text-muted)';
        emptyMsg.style.padding = '20px';
        emptyMsg.textContent = '尚無時程安排';
        scheduleList.appendChild(emptyMsg);
      } else {
        // Sort schedules by time
        const sortedSchedules = [...dateSchedules].sort((a, b) => {
          if (a.time < b.time) return -1;
          if (a.time > b.time) return 1;
          return 0;
        });
        
        sortedSchedules.forEach((schedule) => {
          const scheduleIndex = schedules.findIndex(s => s.id === schedule.id);
          const scheduleItem = document.createElement('div');
          scheduleItem.className = 'schedule-item';
          
          scheduleItem.innerHTML = `
            <div class="schedule-item-content">
              <div class="schedule-item-time">${schedule.time || '未設定'}</div>
              <h5 class="schedule-item-title">${schedule.title || '無標題'}</h5>
              ${schedule.description ? `<p class="schedule-item-description">${schedule.description}</p>` : ''}
            </div>
            <div class="schedule-item-actions">
              <button class="schedule-item-btn edit-schedule-btn" data-index="${scheduleIndex}" title="編輯">✎</button>
              <button class="schedule-item-btn delete-schedule-btn delete-btn" data-index="${scheduleIndex}" title="刪除">×</button>
            </div>
          `;
          
          // Edit button
          const editBtn = scheduleItem.querySelector('.edit-schedule-btn');
          editBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openEditScheduleModal(scheduleIndex);
          });
          
          // Delete button
          const deleteBtn = scheduleItem.querySelector('.delete-schedule-btn');
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm(`確定要刪除「${schedule.title}」嗎？`)) {
              deleteScheduleById(schedule.id, scheduleIndex);
            }
          });
          
          scheduleList.appendChild(scheduleItem);
        });
      }
    }
    
    function renderDateArticles(dateArticles) {
      const articlesList = document.getElementById('date-articles-list');
      if (!articlesList) return;
      
      articlesList.innerHTML = '';
      
      if (dateArticles.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.style.textAlign = 'center';
        emptyMsg.style.color = 'var(--text-muted)';
        emptyMsg.style.padding = '20px';
        emptyMsg.innerHTML = '<p>此日期尚無文章</p><button class="btn-save" style="margin-top: 12px;" id="btn-add-article-to-date">新增文章</button>';
        articlesList.appendChild(emptyMsg);
        
        const addBtn = document.getElementById('btn-add-article-to-date');
        if (addBtn) {
          addBtn.addEventListener('click', () => {
            openEditArticleModal(-1, selectedDate);
          });
        }
      } else {
        dateArticles.forEach((article, index) => {
          const articleIndex = articles.findIndex(a => a.id === article.id);
          const articleItem = document.createElement('div');
          articleItem.className = 'article-item';
          
          const updatedAt = formatDateTime(article.updated_at || article.created_at);
          
          articleItem.innerHTML = `
            <div class="article-item-header">
              <h3 class="article-item-title">${article.title || '無標題'}</h3>
              <div class="article-item-actions">
                <button class="article-item-btn edit-article-btn" data-index="${articleIndex}" title="編輯">✎</button>
                <button class="article-item-btn delete-article-btn delete-btn" data-index="${articleIndex}" title="刪除">×</button>
              </div>
            </div>
            <div class="article-item-meta">
              <div class="article-item-meta-item">
                <span class="article-item-meta-label">作者：</span>
                <span class="article-item-meta-value">${article.author || '未知'}</span>
              </div>
              <div class="article-item-meta-item">
                <span class="article-item-meta-label">最後修改：</span>
                <span class="article-item-meta-value">${updatedAt}</span>
              </div>
            </div>
            <div class="article-item-content">${article.content || ''}</div>
          `;
          
          // 編輯按鈕
          const editBtn = articleItem.querySelector('.edit-article-btn');
          editBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openEditArticleModal(articleIndex);
          });
          
          // 刪除按鈕
          const deleteBtn = articleItem.querySelector('.delete-article-btn');
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm(`確定要刪除「${article.title}」嗎？`)) {
              deleteArticleById(article.id, articleIndex);
            }
          });
          
          articlesList.appendChild(articleItem);
        });
        
        // Add button to add more articles
        const addBtn = document.createElement('div');
        addBtn.className = 'add-article-btn';
        addBtn.textContent = '新增文章';
        addBtn.addEventListener('click', () => openEditArticleModal(-1, selectedDate));
        articlesList.appendChild(addBtn);
      }
    }
    
    // Schedule Edit Modal Functions
    let currentScheduleEditIndex = -1;

    function openEditScheduleModal(index) {
      currentScheduleEditIndex = index;
      const modal = document.getElementById('schedule-modal');
      const title = document.getElementById('schedule-modal-title');
      const timeInput = document.getElementById('schedule-time');
      const titleInput = document.getElementById('schedule-title');
      const descriptionInput = document.getElementById('schedule-description');
      
      if (index === -1) {
        // 新增模式
        title.textContent = '新增行程';
        timeInput.value = '';
        timeInput.disabled = false;
        titleInput.value = '';
        descriptionInput.value = '';
      } else {
        // 編輯模式
        title.textContent = '編輯行程';
        const schedule = schedules[index];
        
        // 确保时间字段可以编辑
        timeInput.disabled = false;
        
        // 处理时间格式 - HTML time input需要HH:MM格式
        let timeValue = schedule.time || '';
        // 如果时间格式不是HH:MM，尝试转换
        if (timeValue && !/^\d{2}:\d{2}$/.test(timeValue)) {
          // 尝试从其他格式转换
          if (timeValue.includes(':')) {
            const parts = timeValue.split(':');
            if (parts.length >= 2) {
              timeValue = `${String(parts[0]).padStart(2, '0')}:${String(parts[1]).padStart(2, '0')}`;
            }
          } else if (timeValue.length === 4) {
            // 假设是HHMM格式
            timeValue = `${timeValue.substring(0, 2)}:${timeValue.substring(2, 4)}`;
          }
        }
        
        timeInput.value = timeValue;
        titleInput.value = schedule.title || '';
        descriptionInput.value = schedule.description || '';
        
        console.log('Editing schedule:', schedule, 'Time value:', timeValue);
      }
      
      modal.classList.add('active');
      // 聚焦到时间输入框，方便用户直接修改
      setTimeout(() => {
        timeInput.focus();
        timeInput.select();
      }, 100);
    }

    function closeEditScheduleModal() {
      const modal = document.getElementById('schedule-modal');
      const timeInput = document.getElementById('schedule-time');
      const titleInput = document.getElementById('schedule-title');
      const descriptionInput = document.getElementById('schedule-description');
      
      // 确保所有字段都可用
      if (timeInput) {
        timeInput.disabled = false;
      }
      
      modal.classList.remove('active');
      currentScheduleEditIndex = -1;
      
      // 清空表单（可选，根据需求决定）
      // if (timeInput) timeInput.value = '';
      // if (titleInput) titleInput.value = '';
      // if (descriptionInput) descriptionInput.value = '';
    }

    async function saveSchedule() {
      const timeInput = document.getElementById('schedule-time');
      const titleInput = document.getElementById('schedule-title');
      const descriptionInput = document.getElementById('schedule-description');
      
      if (!timeInput || !titleInput) {
        console.error('Schedule form inputs not found');
        alert('表單元素未找到，請刷新頁面重試');
        return;
      }
      
      // 确保时间输入框没有被禁用
      if (timeInput.disabled) {
        timeInput.disabled = false;
      }
      
      const time = timeInput.value.trim();
      const title = titleInput.value.trim();
      const description = descriptionInput.value.trim();
      
      console.log('Saving schedule:', { time, title, description, isEdit: currentScheduleEditIndex !== -1 });
      
      if (!time || !title) {
        alert('請填寫時間和標題');
        return;
      }
      
      // 验证时间格式 (HH:MM)
      if (!/^\d{2}:\d{2}$/.test(time)) {
        alert('時間格式不正確，請使用 HH:MM 格式（例如：14:30）');
        timeInput.focus();
        return;
      }
      
      // Use selected date or current date
      let scheduleDate = selectedDate;
      if (!scheduleDate) {
        const today = new Date();
        scheduleDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      }
      
      if (currentScheduleEditIndex === -1) {
        // 新增
        const newSchedule = await addSchedule(scheduleDate, time, title, description);
        if (newSchedule) {
          schedules.push(newSchedule);
          if (selectedDate) {
            const filteredSchedules = schedules.filter(schedule => {
              const scheduleDate = new Date(schedule.date);
              const scheduleDateKey = `${scheduleDate.getFullYear()}-${String(scheduleDate.getMonth() + 1).padStart(2, '0')}-${String(scheduleDate.getDate()).padStart(2, '0')}`;
              return scheduleDateKey === selectedDate;
            });
            renderSchedules(filteredSchedules);
          }
          closeEditScheduleModal();
        }
      } else {
        // 編輯
        const schedule = schedules[currentScheduleEditIndex];
        console.log('Updating schedule:', schedule.id, 'with time:', time);
        const updated = await updateSchedule(schedule.id, scheduleDate, time, title, description);
        if (updated) {
          console.log('Schedule updated successfully:', updated);
          schedules[currentScheduleEditIndex] = updated;
          if (selectedDate) {
            const filteredSchedules = schedules.filter(schedule => {
              const scheduleDate = new Date(schedule.date);
              const scheduleDateKey = `${scheduleDate.getFullYear()}-${String(scheduleDate.getMonth() + 1).padStart(2, '0')}-${String(scheduleDate.getDate()).padStart(2, '0')}`;
              return scheduleDateKey === selectedDate;
            });
            renderSchedules(filteredSchedules);
          }
          closeEditScheduleModal();
        } else {
          alert('更新失敗，請檢查控制台錯誤信息');
        }
      }
    }

    async function deleteScheduleById(id, index) {
      const success = await deleteSchedule(id);
      if (success) {
        schedules.splice(index, 1);
        if (selectedDate) {
          const filteredSchedules = schedules.filter(schedule => {
            const scheduleDate = new Date(schedule.date);
            const scheduleDateKey = `${scheduleDate.getFullYear()}-${String(scheduleDate.getMonth() + 1).padStart(2, '0')}-${String(scheduleDate.getDate()).padStart(2, '0')}`;
            return scheduleDateKey === selectedDate;
          });
          renderSchedules(filteredSchedules);
        }
      }
    }
    
    function prevMonth() {
      currentMonth--;
      if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
      }
      renderCalendar();
    }
    
    function nextMonth() {
      currentMonth++;
      if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
      }
      renderCalendar();
    }
    
    function openYearMonthSelector(type) {
      const modal = document.getElementById('year-month-modal');
      const title = document.getElementById('year-month-modal-title');
      const grid = document.getElementById('year-month-grid');
      
      if (type === 'year') {
        title.textContent = '選擇年份';
        grid.innerHTML = '';
        const currentYearValue = currentYear;
        const startYear = currentYearValue - 10;
        const endYear = currentYearValue + 10;
        
        for (let year = startYear; year <= endYear; year++) {
          const item = document.createElement('div');
          item.className = 'year-month-item';
          if (year === currentYearValue) {
            item.classList.add('selected');
          }
          item.textContent = year;
          item.addEventListener('click', () => {
            currentYear = year;
            renderCalendar();
            closeYearMonthSelector();
          });
          grid.appendChild(item);
        }
      } else if (type === 'month') {
        title.textContent = '選擇月份';
        grid.innerHTML = '';
        const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
        
        monthNames.forEach((monthName, index) => {
          const item = document.createElement('div');
          item.className = 'year-month-item';
          if (index + 1 === currentMonth) {
            item.classList.add('selected');
          }
          item.textContent = monthName;
          item.addEventListener('click', () => {
            currentMonth = index + 1;
            renderCalendar();
            closeYearMonthSelector();
          });
          grid.appendChild(item);
        });
      }
      
      modal.classList.add('active');
    }
    
    function closeYearMonthSelector() {
      const modal = document.getElementById('year-month-modal');
      modal.classList.remove('active');
    }

    async function deleteArticleById(id, index) {
      const success = await deleteArticle(id);
      if (success) {
        articles.splice(index, 1);
        renderCalendar();
        if (selectedDate) {
          const dateArticles = articles.filter(a => {
            const aDate = new Date(a.date || a.created_at);
            const dateKey = `${aDate.getFullYear()}-${String(aDate.getMonth() + 1).padStart(2, '0')}-${String(aDate.getDate()).padStart(2, '0')}`;
            return dateKey === selectedDate;
          });
          renderDateArticles(dateArticles);
        }
      }
    }

    async function initArticles() {
      articles = await loadArticles();
      schedules = await loadSchedules();
      renderCalendar();
    }

    // Article Edit Modal Functions
    let currentArticleEditIndex = -1;
    let currentArticleDate = null;

    function openEditArticleModal(index, date = null) {
      currentArticleEditIndex = index;
      currentArticleDate = date || selectedDate;
      const editModal = document.getElementById('edit-article-modal');
      const editTitle = document.getElementById('edit-article-modal-title');
      const titleInput = document.getElementById('edit-article-title');
      const authorInput = document.getElementById('edit-article-author');
      const contentInput = document.getElementById('edit-article-content');
      
      if (index === -1) {
        // 新增模式
        editTitle.textContent = currentArticleDate ? `新增文章 - ${currentArticleDate}` : '新增文章';
        titleInput.value = '';
        authorInput.value = '';
        contentInput.value = '';
      } else {
        // 編輯模式
        editTitle.textContent = '編輯文章';
        const article = articles[index];
        titleInput.value = article.title || '';
        authorInput.value = article.author || '';
        contentInput.value = article.content || '';
        currentArticleDate = article.date || currentArticleDate;
      }
      
      editModal.classList.add('active');
      titleInput.focus();
    }

    function closeEditArticleModal() {
      const editModal = document.getElementById('edit-article-modal');
      editModal.classList.remove('active');
      currentArticleEditIndex = -1;
      currentArticleDate = null;
    }

    async function saveArticle() {
      const titleInput = document.getElementById('edit-article-title');
      const authorInput = document.getElementById('edit-article-author');
      const contentInput = document.getElementById('edit-article-content');
      
      const title = titleInput.value.trim();
      const author = authorInput.value.trim();
      const content = contentInput.value.trim();
      
      if (!title || !content) {
        alert('請填寫標題和內容');
        return;
      }
      
      // Use selected date or current date
      let articleDate = currentArticleDate;
      if (!articleDate) {
        const today = new Date();
        articleDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      }
      
      if (currentArticleEditIndex === -1) {
        // 新增
        const newArticle = await addArticle(title, author, content, articleDate);
        if (newArticle) {
          articles.push(newArticle);
          renderCalendar();
          if (selectedDate === articleDate) {
            const dateArticles = articles.filter(a => {
              const aDate = new Date(a.date || a.created_at);
              const dateKey = `${aDate.getFullYear()}-${String(aDate.getMonth() + 1).padStart(2, '0')}-${String(aDate.getDate()).padStart(2, '0')}`;
              return dateKey === articleDate;
            });
            renderDateArticles(dateArticles);
          }
          closeEditArticleModal();
        }
      } else {
        // 編輯
        const article = articles[currentArticleEditIndex];
        const updated = await updateArticle(article.id, title, author, content, articleDate);
        if (updated) {
          articles[currentArticleEditIndex] = updated;
          renderCalendar();
          if (selectedDate === articleDate) {
            const dateArticles = articles.filter(a => {
              const aDate = new Date(a.date || a.created_at);
              const dateKey = `${aDate.getFullYear()}-${String(aDate.getMonth() + 1).padStart(2, '0')}-${String(aDate.getDate()).padStart(2, '0')}`;
              return dateKey === articleDate;
            });
            renderDateArticles(dateArticles);
          }
          closeEditArticleModal();
        }
      }
    }

    // Initial stories data (for migration - can be removed after importing to Supabase)
    const initialStories = [
      {
        title: "健康教育課",
        preview: "程老師來到學生家中進行一對一家教，但今天的課程內容並非一般學科。她將以專業冷靜的態度，教導學生關於性交與自慰的知識與實作...",
        content: `[角色扮演遊戲]

程老師:專業冷靜的家教老師
瑄瑄:需要健康教育的學生

第一章｜基礎知識教學

主題：性教育的理論基礎

程老師來到瑄瑄家中，拿出準備好的教材。她態度冷靜專業，如同教授任何一門學科般開始講解。

她讓瑄瑄詳細了解身體構造、生理反應、敏感區域與基本的性知識。

在她的筆記本上，「健康教育」四個字被劃下粗黑線。

程老師以毫無情緒的口吻說明每個部位的功能、反應機制與注意事項。

第二章｜自我探索實作

主題：自慰技巧的實作教學

程老師開始對瑄瑄進行「自我探索實作訓練」。

瑄瑄必須在老師的監督下，對自己進行身體敏感區域的探索與刺激。

每一段探索都有時間限制、強度限制，並強制「不得過度」。

程老師在旁以專業教學的口吻記錄他的生理變化、呼吸節奏、肌肉反射、意識狀態。

當瑄瑄接近臨界點時，老師會立刻喊停，讓他學習控制與延遲的技巧。

這整個訓練的目的，就是讓瑄瑄對自己的身體產生清楚的認知與控制能力。

久而久之，瑄瑄對自己的身體反應產生一種理性的理解。

第三章｜互動式性交教學

主題：他人互動模式下的實作觀察

程老師允許瑄瑄使用她的身體進行實際的性交教學。

她全程保持冷靜與專業距離感，像在進行教學示範，不帶任何情緒。

瑄瑄的反應變得比第一階段更強烈，他逐漸理解理論與實作之間的差異。

程老師一邊讓他「接近臨界」，一邊記錄其中的生理反應模式，例如：

被刺激後的身體變化
實際接觸他人後，慾望與反應的強度
對老師本人的信任感與依賴感上升

教學過程中，程老師會在瑄瑄最無法控制的瞬間停止動作，使他再次學習自我控制。

第四章｜合：完整實作測驗

主題：完整流程的實踐與驗收

最終測驗分成兩段：

完整自慰：讓瑄瑄完整進行自慰流程，展示所學技巧。

完整性交：進行完整的性交過程，從開始到結束，必須全程保持理性與控制，直到完全結束教學才完成。`
      },
      {
        title: "新婚夫妻",
        preview: "程小姐與瑄瑄剛結婚，興奮地討論未來的生活規劃。他們談論國內外旅遊、理想的生活方式，過程中持續不斷地進行性接觸...",
        content: `[角色扮演遊戲]

程小姐:剛結婚的新娘
瑄瑄:剛結婚的新郎

第一章｜未來生活的規劃討論

主題：興奮地討論理想生活

程小姐與瑄瑄剛結婚，兩人興奮地躺在床上討論未來的生活規劃。

程小姐態度興奮而充滿期待，她讓瑄瑄詳細描述他想要的生活、理想的居住環境、以及最想一起做的事情。

在她的心中，「未來」兩個字充滿無限可能。

她以充滿興奮的口吻詢問他的夢想、旅遊計劃、生活方式與最期待的時刻。

過程中，兩人的手不斷在彼此身上游移，輕撫、擁抱、親吻，性接觸持續不斷。

第二章｜國內外旅遊的夢想清單

主題：規劃旅行中的持續親密

程小姐開始與瑄瑄討論「國內外旅遊計劃」。

瑄瑄必須在討論的同時，持續撫摸妻子的身體，探索她身體的每一個敏感區域。

每一段討論都伴隨著持續的性接觸、溫柔的觸碰，並強制「不得停止」。

程小姐在討論旅遊地點時，一邊感受他的觸碰、呼吸節奏、身體反應、意識狀態。

當瑄瑄提到特別興奮的旅遊計劃時，妻子會更加熱情地回應，讓性接觸變得更加激烈。

這整個討論的目的，就是讓兩人在規劃未來的同時，持續享受彼此的親密接觸。

久而久之，兩人對未來生活的期待與當下的性愛產生一種完美的融合。

第三章｜理想生活方式的深入交流

主題：討論與性愛的完美結合

程小姐與瑄瑄進行更深層的生活規劃討論，包括居住環境、工作安排、家庭計劃。

她全程保持興奮與親密感，像在共同創造未來，充滿期待與愛意。

瑄瑄的反應變得比第一階段更強烈，他逐漸理解討論未來與享受當下之間的完美平衡。

程小姐一邊讓他「接近臨界」，一邊繼續討論理想生活，例如：

討論居住環境時，持續撫摸與親吻
規劃工作安排時，身體接觸不斷加深
談論家庭計劃時，性愛交流達到高峰

交流過程中，程小姐會在瑄瑄最興奮的瞬間更加熱情地配合，使討論與性愛完美結合。

第四章｜合：未來與當下的完整融合

主題：完整規劃與完整釋放

最終討論分成兩段：

完整規劃：讓瑄瑄完整討論所有未來計劃，從旅遊到生活，過程中持續不斷的性接觸。

完整釋放：進行完整的性愛過程，從開始到結束，必須全程保持對未來的討論與興奮，直到完全釋放並確認彼此對未來的承諾才完成。`
      },
      {
        title: "花藝研究學院",
        preview: "程小姐與瑄瑄是花藝研究學院的學生，兩人一起研究花藝的學問、手法與各種花的知識。在研究過程中，持續不斷地進行性接觸...",
        content: `[角色扮演遊戲]

程小姐:花藝研究學院的學生
瑄瑄:花藝研究學院的學生

第一章｜花藝學問的深入研究

主題：學習花藝理論中的持續親密

程小姐與瑄瑄是花藝研究學院的學生，兩人一起在工作室中研究花藝的學問。

程小姐態度認真而充滿熱情，她讓瑄瑄詳細描述各種花的特性、花語、生長環境、以及插花的基本理論。

在她的筆記本上，「花藝研究」四個字被劃下重點標記。

她以充滿求知慾的口吻詢問他對花藝的理解、各種花材的知識、插花技巧與最想學習的領域。

過程中，兩人的手不斷在彼此身上游移，輕撫、擁抱、親吻，性接觸持續不斷，同時繼續討論花藝知識。

第二章｜插花手法的實作練習

主題：練習技巧中的身體接觸

程小姐開始與瑄瑄進行「插花手法實作練習」。

瑄瑄必須在練習插花的同時，持續撫摸程小姐的身體，探索她身體的每一個敏感區域。

每一段練習都伴隨著持續的性接觸、溫柔的觸碰，並強制「不得停止」。

程小姐在示範插花技巧時，一邊感受他的觸碰、呼吸節奏、身體反應、意識狀態。

當瑄瑄掌握特別難的插花技巧時，程小姐會更加熱情地回應，讓性接觸變得更加激烈。

這整個練習的目的，就是讓兩人在學習花藝技巧的同時，持續享受彼此的親密接觸。

久而久之，兩人對花藝的熱愛與當下的性愛產生一種完美的融合。

第三章｜各種花材知識的深入探討

主題：花材研究與性愛的完美結合

程小姐與瑄瑄進行更深層的花材知識探討，包括玫瑰、百合、鬱金香、向日葵等各種花的特性與應用。

她全程保持專注與親密感，像在共同探索花的世界，充滿熱情與求知慾。

瑄瑄的反應變得比第一階段更強烈，他逐漸理解學習花藝與享受當下之間的完美平衡。

程小姐一邊讓他「接近臨界」，一邊繼續討論各種花材，例如：

討論玫瑰的品種時，持續撫摸與親吻
研究百合的插法時，身體接觸不斷加深
探討鬱金香的特性時，性愛交流達到高峰

探討過程中，程小姐會在瑄瑄最興奮的瞬間更加熱情地配合，使花藝研究與性愛完美結合。

第四章｜合：花藝知識與身體的完整融合

主題：完整學習與完整釋放

最終研究分成兩段：

完整學習：讓瑄瑄完整學習所有花藝知識，從理論到實作，過程中持續不斷的性接觸。

完整釋放：進行完整的性愛過程，從開始到結束，必須全程保持對花藝的討論與學習，直到完全釋放並確認彼此對花藝的熱愛才完成。`
      },
      {
        title: "特殊職缺面試",
        preview: "程小姐來到面試現場，原本以為是一般秘書職務，然而瑄瑄翻到下一頁後，空氣變得不尋常。超出常規的職缺說明，包含特殊的情緒管理與身心調節服務...",
        content: `[角色扮演遊戲]

程小姐：冷靜理性的求職者
瑄瑄：制度離譜的老闆

第一章｜奇特的職缺說明

主題：超出常規的秘書需求

程小姐來到面試現場時，先看到的是一般秘書職務內容：行程管理、文件整理、客戶協調。然而瑄瑄翻到下一頁後，空氣變得不尋常。

他平靜、像在念公司手冊般說明：「本職缺包含主管情緒管理、壓力緩衝與身心調節服務，是本公司的重要績效項目。」

薪資制度：

個人「高潮」達成一次，加薪 2000。

協助主管達成「高潮」一次，加薪 1000。

程小姐看著這段描述，卻沒有露出驚訝，像是早習慣這種隱晦制度的地下行業。她只是點頭，示意繼續。

瑄瑄在履歷上寫下一句重點：「需具備高承受度與高開放度。」

第二章｜情慾開放度測試

主題：針對性開放尺度的問題

Q:接受隨時被撫摸乳房嗎?

Q:接受隨時被玩弄小穴嗎?

Q:接受隨時帶著玩具被控制嗎?

Q:自己跟主管報告時可以自己自慰並且高潮嗎?

Q:能否在高壓的同時，接受身體被玩弄?

Q:在被玩弄時，能否保持專業形象跟語氣，持續認真工作?

第三章｜互動感測實作

主題：身體敏感度測試還有性開放測試

程小姐在接受瑄瑄對於她身體的各種玩弄表現出從容不迫的樣子

第四章｜最終確認：制度是否能被承受

主題：認可與宣示

接下來是宣示測試，必須念出以下文字，評斷程小姐是否有熱情並且願意完全付出於工作上

1.我願意隨時被玩弄，我的身體是宣宣的。

2.性慾是理所當然的事情，我願意隨時隨地發生性愛。

3.瑄瑄口渴時，我必須用我小穴的水來幫瑄瑄止渴。

4.在辦公室被玩弄時，我仍然會保持專業形象，進行工作。

最後內射做為結束。`
      },
      {
        title: "性慾成癮的治療",
        preview: "瑄瑄因為性慾過度影響生活、工作、專注力，來到程醫生診間。程醫生态度冷靜，問診如同分析機械故障。開始進行一系列自我刺激抑制訓練...",
        content: `[角色扮演遊戲]

程醫生:專業冷靜的醫生
瑄瑄:性慾成癮的病人

第一章｜過度旺盛的病人

主題：慾望失控的自白

瑄瑄因為性慾過度影響生活、工作、專注力，來到程醫生診間。程醫生态度冷靜，問診如同分析機械故障。她讓瑄瑄詳細描述發作頻率、慾望狀態、身體反應與最痛苦的時段。

在她的筆記本上，「性慾成癮」四個字被劃下粗黑線。

第二章｜自我刺激抑制訓練

主題：慾望壓抑的自我控制技術

程醫生開始對瑄瑄進行「自我刺激抑制訓練」。

瑄瑄必須在醫生的監督下，對自己進行高度敏感區域的刺激測試。

每一段刺激都有時間限制、強度限制，並強制「不得越界」。

程醫生在旁以毫無情緒的口吻記錄他的生理變化、呼吸節奏、肌肉反射、意識模糊程度。

當瑄瑄接近臨界點時，醫生會立刻喊停，讓他經歷最痛苦的「被卡住」狀態。

這整個訓練的目的，就是讓瑄瑄的慾望高度被反覆升起→掐斷→升起→掐斷。

久而久之，瑄瑄對自己的欲望產生一種扭曲的清醒。

第三章｜醫生介入的高階刺激治療

主題：他人刺激模式下的心理失衡觀察

程醫生允許瑄瑄使用她的身體部分接觸來替代自我刺激。

她全程保持冷靜與距離感，像在做醫學實驗，不帶任何情緒。

瑄瑄的反應變得比第一階段更失控，他逐漸分不清刺激與壓抑之間的心理落差。

程醫生一邊讓他「接近失控」，一邊記錄其中的變態衝動模式，例如：

被壓抑後反而更興奮被准許接觸他人後，慾望幾乎瞬間暴衝

對醫生本人的依附感上升

治療過程中，程醫生會在瑄瑄最無法忍耐的瞬間抽離刺激，使他再次被迫壓抑。

第四章｜合：最後一次療程

主題：峰值與釋放

最終療程分成兩段：

最大誘發：讓瑄瑄發狂的使用自己的肉體。

完整釋放：射精完成後不准停止刺激，必續持續射精到完全沒力療程才結束`
      }
    ];

    // Lovense Interactive Game Functions
    let lovenseWebhookUrl = '';
    let lovenseToken = '';
    let isConnected = false;
    let currentVibration = null;

    // Update connection status
    function updateConnectionStatus(connected, connecting = false) {
      const statusIndicator = document.getElementById('status-indicator');
      const statusText = document.getElementById('status-text');
      const controlPanel = document.getElementById('control-panel');
      
      if (statusIndicator && statusText) {
        statusIndicator.className = 'status-indicator';
        if (connected) {
          statusIndicator.classList.add('connected');
          statusText.textContent = '已連接';
          isConnected = true;
          if (controlPanel) controlPanel.style.display = 'flex';
        } else if (connecting) {
          statusIndicator.classList.add('connecting');
          statusText.textContent = '連接中...';
          isConnected = false;
        } else {
          statusText.textContent = '未連接';
          isConnected = false;
          if (controlPanel) controlPanel.style.display = 'none';
        }
      }
    }

    // Send vibration command via webhook
    async function sendVibrationCommand(command) {
      if (!lovenseWebhookUrl) {
        alert('請先設定 Webhook URL');
        return false;
      }

      try {
        const payload = {
          action: 'vibrate',
          intensity: command.intensity || 50,
          duration: command.duration || 3,
          pattern: command.pattern || 'constant',
          token: lovenseToken || undefined,
          timestamp: new Date().toISOString()
        };

        const response = await fetch(lovenseWebhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Vibration command sent:', data);
        return true;
      } catch (error) {
        console.error('Failed to send vibration command:', error);
        alert('發送振動命令失敗: ' + error.message);
        return false;
      }
    }

    // Connect to Lovense
    function connectLovense() {
      const webhookUrl = document.getElementById('webhook-url')?.value.trim();
      const token = document.getElementById('device-token')?.value.trim();

      if (!webhookUrl) {
        alert('請輸入 Webhook URL');
        return;
      }

      lovenseWebhookUrl = webhookUrl;
      lovenseToken = token || '';

      updateConnectionStatus(false, true);

      // Test connection
      setTimeout(() => {
        // Simulate connection test
        updateConnectionStatus(true);
      }, 1000);
    }

    // Stop vibration
    async function stopVibration() {
      if (!isConnected) return;

      try {
        const payload = {
          action: 'stop',
          token: lovenseToken || undefined,
          timestamp: new Date().toISOString()
        };

        await fetch(lovenseWebhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        if (currentVibration) {
          clearInterval(currentVibration);
          currentVibration = null;
        }
      } catch (error) {
        console.error('Failed to stop vibration:', error);
      }
    }

    // Start vibration
    async function startVibration() {
      if (!isConnected) {
        alert('請先連接設備');
        return;
      }

      const intensity = parseInt(document.getElementById('vibration-intensity')?.value || 50);
      const duration = parseInt(document.getElementById('vibration-duration')?.value || 3);

      await sendVibrationCommand({
        intensity: intensity,
        duration: duration,
        pattern: 'constant'
      });
    }

    // Pattern functions
    const patterns = {
      gentle: { intensity: 20, duration: 5, pattern: 'wave' },
      medium: { intensity: 50, duration: 5, pattern: 'wave' },
      strong: { intensity: 80, duration: 5, pattern: 'constant' },
      wave: { intensity: 60, duration: 10, pattern: 'wave' },
      pulse: { intensity: 70, duration: 8, pattern: 'pulse' },
      random: { intensity: Math.floor(Math.random() * 100), duration: 5, pattern: 'random' }
    };

    // Game functions
    function startRhythmGame() {
      if (!isConnected) {
        alert('請先連接設備');
        return;
      }

      let beatCount = 0;
      const rhythm = setInterval(() => {
        beatCount++;
        const intensity = 30 + (beatCount % 4) * 20;
        sendVibrationCommand({
          intensity: intensity,
          duration: 0.5,
          pattern: 'pulse'
        });

        if (beatCount >= 20) {
          clearInterval(rhythm);
          alert('節奏遊戲結束！');
        }
      }, 1000);
    }

    function startReactionTest() {
      if (!isConnected) {
        alert('請先連接設備');
        return;
      }

      const randomDelay = Math.random() * 3000 + 2000; // 2-5 seconds
      
      setTimeout(() => {
        sendVibrationCommand({
          intensity: 80,
          duration: 1,
          pattern: 'constant'
        });
        alert('反應測試開始！');
      }, randomDelay);
    }

    function startRandomStimulation() {
      if (!isConnected) {
        alert('請先連接設備');
        return;
      }

      const randomInterval = setInterval(() => {
        const intensity = Math.floor(Math.random() * 100);
        const duration = Math.random() * 3 + 1;
        
        sendVibrationCommand({
          intensity: intensity,
          duration: duration,
          pattern: 'random'
        });
      }, 3000);

      // Stop after 30 seconds
      setTimeout(() => {
        clearInterval(randomInterval);
        stopVibration();
      }, 30000);
    }

    // Initialize Lovense controls
    function initLovenseGame() {
      // Connection button
      const btnConnect = document.getElementById('btn-connect');
      if (btnConnect) {
        btnConnect.addEventListener('click', connectLovense);
      }

      // Control buttons
      const btnStart = document.getElementById('btn-start');
      const btnStop = document.getElementById('btn-stop');
      
      if (btnStart) {
        btnStart.addEventListener('click', startVibration);
      }
      
      if (btnStop) {
        btnStop.addEventListener('click', stopVibration);
      }

      // Sliders
      const intensitySlider = document.getElementById('vibration-intensity');
      const durationSlider = document.getElementById('vibration-duration');
      const intensityValue = document.getElementById('intensity-value');
      const durationValue = document.getElementById('duration-value');

      if (intensitySlider && intensityValue) {
        intensitySlider.addEventListener('input', (e) => {
          intensityValue.textContent = e.target.value;
        });
      }

      if (durationSlider && durationValue) {
        durationSlider.addEventListener('input', (e) => {
          durationValue.textContent = e.target.value;
        });
      }

      // Pattern buttons
      const patternButtons = document.querySelectorAll('.pattern-btn');
      patternButtons.forEach(btn => {
        btn.addEventListener('click', async (e) => {
          patternButtons.forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          
          const pattern = e.target.getAttribute('data-pattern');
          if (pattern && patterns[pattern]) {
            await sendVibrationCommand(patterns[pattern]);
          }
        });
      });

      // Game buttons
      const btnGame1 = document.getElementById('btn-game-1');
      const btnGame2 = document.getElementById('btn-game-2');
      const btnGame3 = document.getElementById('btn-game-3');

      if (btnGame1) {
        btnGame1.addEventListener('click', startRhythmGame);
      }
      if (btnGame2) {
        btnGame2.addEventListener('click', startReactionTest);
      }
      if (btnGame3) {
        btnGame3.addEventListener('click', startRandomStimulation);
      }
    }

    // Load stories from Supabase on page load
    async function initStories() {
      try {
        const loadedStories = await loadStories();
        if (loadedStories.length > 0) {
          // Database has stories, use them
          stories = loadedStories;
          renderStories();
        } else {
          // Database is empty, import initial stories
          console.log('数据库为空，正在导入初始故事...');
          stories = [];
          renderStories(); // Show empty state first
          
          // Import all initial stories to Supabase
          let importSuccess = true;
          for (const story of initialStories) {
            const newStory = await addStory(story.title, story.preview, story.content);
            if (!newStory) {
              importSuccess = false;
              console.warn('导入故事失败:', story.title);
            }
            // Small delay to avoid rate limiting
            await new Promise(resolve => setTimeout(resolve, 100));
          }
          
          if (importSuccess) {
            // Reload from database to get all stories with IDs
            const reloadedStories = await loadStories();
            if (reloadedStories.length > 0) {
              stories = reloadedStories;
            }
            console.log('初始故事导入完成！');
          } else {
            // If import failed, use initial stories as fallback
            console.warn('部分故事导入失败，使用本地数据');
            stories = initialStories;
          }
          renderStories();
        }
      } catch (error) {
        // If Supabase connection fails, use initial stories as fallback
        console.error('加载故事时发生错误，使用本地数据:', error);
        stories = initialStories;
        renderStories();
      }
    }

    const storyGrid = document.getElementById("story-grid");

    function renderStories() {
      storyGrid.innerHTML = "";
      stories.forEach((story, index) => {
        const storyCard = document.createElement("div");
        storyCard.className = "story-card";
        storyCard.innerHTML = `
          <div class="story-card-actions">
            <button class="story-card-edit-btn" data-index="${index}" title="編輯">✎</button>
            <button class="story-card-delete-btn" data-index="${index}" title="刪除">×</button>
          </div>
          <div class="story-card-title">${story.title}</div>
          <div class="story-card-preview">${story.preview}</div>
          <div class="story-card-meta">點擊查看完整劇情 →</div>
        `;
        
        // 點擊卡片查看內容
        storyCard.addEventListener("click", (e) => {
          if (!e.target.closest('.story-card-actions')) {
            openStoryModal(story);
          }
        });
        
        // 編輯按鈕
        const editBtn = storyCard.querySelector('.story-card-edit-btn');
        editBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          openEditModal(index);
        });
        
        // 刪除按鈕
        const deleteBtn = storyCard.querySelector('.story-card-delete-btn');
        deleteBtn.addEventListener("click", async (e) => {
          e.stopPropagation();
          if (confirm(`確定要刪除「${story.title}」嗎？`)) {
            const success = await deleteStory(story.id);
            if (success) {
              stories.splice(index, 1);
              renderStories();
            }
          }
        });
        
        storyGrid.appendChild(storyCard);
      });
    }

    function parseStoryContent(content) {
      const lines = content.split('\n');
      let html = '';
      let prevWasMainTitle = false;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        if (!line) {
          html += '<br>';
          continue;
        }
        
        // 主标题 [角色扮演遊戲]
        if (line.startsWith('[') && line.endsWith(']')) {
          html += `<div class="article-main-title">${line}</div>`;
          prevWasMainTitle = true;
        }
        // 角色设定行（紧跟在主标题后，包含冒号的短行）
        else if (prevWasMainTitle && line.includes(':') && line.length < 30) {
          html += `<div class="article-role">${line}</div>`;
          prevWasMainTitle = false;
        }
        // 章节标题（包含"第X章｜"或"第四章｜合："）
        else if (/第[一二三四五六七八九十\d]+章｜/.test(line) || /第四章｜合：/.test(line)) {
          html += `<div class="article-chapter-title">${line}</div>`;
          prevWasMainTitle = false;
        }
        // 主题行（包含"主題："）
        else if (line.includes('主題：')) {
          html += `<div class="article-theme">${line}</div>`;
          prevWasMainTitle = false;
        }
        // 普通正文
        else {
          html += `<div class="article-content">${line}</div>`;
          prevWasMainTitle = false;
        }
      }
      
      return html;
    }

    function openStoryModal(story) {
      const modal = document.getElementById("story-modal");
      const modalTitle = document.getElementById("modal-title");
      const modalBody = document.getElementById("modal-body");
      
      modalTitle.textContent = story.title;
      modalBody.innerHTML = parseStoryContent(story.content);
      modal.classList.add("active");
    }

    function closeStoryModal() {
      const modal = document.getElementById("story-modal");
      modal.classList.remove("active");
    }

    // Edit Modal Functions
    let currentEditIndex = -1;

    function openEditModal(index) {
      currentEditIndex = index;
      const editModal = document.getElementById("edit-story-modal");
      const editTitle = document.getElementById("edit-modal-title");
      const titleInput = document.getElementById("edit-story-title");
      const previewInput = document.getElementById("edit-story-preview");
      const contentInput = document.getElementById("edit-story-content");
      
      if (index === -1) {
        // 新增模式
        editTitle.textContent = "新增故事";
        titleInput.value = "";
        previewInput.value = "";
        contentInput.value = "";
      } else {
        // 編輯模式
        editTitle.textContent = "編輯故事";
        const story = stories[index];
        titleInput.value = story.title;
        previewInput.value = story.preview;
        contentInput.value = story.content;
      }
      
      editModal.classList.add("active");
      titleInput.focus();
    }

    function closeEditModal() {
      const editModal = document.getElementById("edit-story-modal");
      editModal.classList.remove("active");
      currentEditIndex = -1;
    }

    async function saveStory() {
      const titleInput = document.getElementById("edit-story-title");
      const previewInput = document.getElementById("edit-story-preview");
      const contentInput = document.getElementById("edit-story-content");
      
      const title = titleInput.value.trim();
      const preview = previewInput.value.trim();
      const content = contentInput.value.trim();
      
      if (!title || !preview || !content) {
        alert("請填寫所有欄位");
        return;
      }
      
      if (currentEditIndex === -1) {
        // 新增
        const newStory = await addStory(title, preview, content);
        if (newStory) {
          stories.push(newStory);
          renderStories();
          closeEditModal();
        }
      } else {
        // 編輯
        const story = stories[currentEditIndex];
        const updated = await updateStory(story.id, title, preview, content);
        if (updated) {
          stories[currentEditIndex] = updated;
          renderStories();
          closeEditModal();
        }
      }
    }

    // Modal Controls
    document.getElementById("modal-close").addEventListener("click", closeStoryModal);
    document.getElementById("story-modal").addEventListener("click", (e) => {
      if (e.target.id === "story-modal") {
        closeStoryModal();
      }
    });

    // Edit Modal Controls
    document.getElementById("edit-modal-close").addEventListener("click", closeEditModal);
    document.getElementById("edit-story-modal").addEventListener("click", (e) => {
      if (e.target.id === "edit-story-modal") {
        closeEditModal();
      }
    });
    document.getElementById("btn-cancel").addEventListener("click", closeEditModal);
    document.getElementById("btn-save").addEventListener("click", saveStory);

    // Article Edit Modal Controls
    document.getElementById("edit-article-modal-close").addEventListener("click", closeEditArticleModal);
    document.getElementById("edit-article-modal").addEventListener("click", (e) => {
      if (e.target.id === "edit-article-modal") {
        closeEditArticleModal();
      }
    });
    document.getElementById("btn-article-cancel").addEventListener("click", closeEditArticleModal);
    document.getElementById("btn-article-save").addEventListener("click", saveArticle);

    // Calendar Controls
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');
    const yearSelectorBtn = document.getElementById('year-selector-btn');
    const monthSelectorBtn = document.getElementById('month-selector-btn');
    const yearMonthModal = document.getElementById('year-month-modal');
    const yearMonthModalClose = document.getElementById('year-month-modal-close');
    const btnCloseArticles = document.getElementById('btn-close-articles');
    
    if (prevMonthBtn) {
      prevMonthBtn.addEventListener('click', prevMonth);
    }
    if (nextMonthBtn) {
      nextMonthBtn.addEventListener('click', nextMonth);
    }
    if (yearSelectorBtn) {
      yearSelectorBtn.addEventListener('click', () => openYearMonthSelector('year'));
    }
    if (monthSelectorBtn) {
      monthSelectorBtn.addEventListener('click', () => openYearMonthSelector('month'));
    }
    if (yearMonthModalClose) {
      yearMonthModalClose.addEventListener('click', closeYearMonthSelector);
    }
    if (yearMonthModal) {
      yearMonthModal.addEventListener('click', (e) => {
        if (e.target.id === 'year-month-modal') {
          closeYearMonthSelector();
        }
      });
    }
    if (btnCloseArticles) {
      btnCloseArticles.addEventListener('click', () => {
        document.getElementById('date-articles-container').style.display = 'none';
        selectedDate = null;
      });
    }
    
    // Close date articles container when clicking on background
    const dateArticlesContainer = document.getElementById('date-articles-container');
    if (dateArticlesContainer) {
      dateArticlesContainer.addEventListener('click', (e) => {
        // Only close if clicking directly on the container background, not on inner content
        if (e.target === dateArticlesContainer || e.target.classList.contains('date-articles-container')) {
          dateArticlesContainer.style.display = 'none';
          selectedDate = null;
        }
      });
      
      // Prevent closing when clicking on inner content
      const dateArticlesInner = dateArticlesContainer.querySelector('.date-articles-inner');
      if (dateArticlesInner) {
        dateArticlesInner.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }
    }

    // Schedule Controls
    const btnAddSchedule = document.getElementById('btn-add-schedule');
    const scheduleModal = document.getElementById('schedule-modal');
    const scheduleModalClose = document.getElementById('schedule-modal-close');
    const scheduleBtnCancel = document.getElementById('schedule-btn-cancel');
    const scheduleBtnSave = document.getElementById('schedule-btn-save');
    
    if (btnAddSchedule) {
      btnAddSchedule.addEventListener('click', () => {
        if (!selectedDate) {
          alert('請先選擇日期');
          return;
        }
        openEditScheduleModal(-1);
      });
    }
    
    if (scheduleModalClose) {
      scheduleModalClose.addEventListener('click', closeEditScheduleModal);
    }
    
    if (scheduleModal) {
      scheduleModal.addEventListener('click', (e) => {
        if (e.target.id === 'schedule-modal') {
          closeEditScheduleModal();
        }
      });
    }
    
    if (scheduleBtnCancel) {
      scheduleBtnCancel.addEventListener('click', closeEditScheduleModal);
    }
    
    if (scheduleBtnSave) {
      scheduleBtnSave.addEventListener('click', saveSchedule);
    }

    // Keyboard support for modals (ESC key)
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const storyModal = document.getElementById("story-modal");
        const editModal = document.getElementById("edit-story-modal");
        const articleModal = document.getElementById("edit-article-modal");
        const yearMonthModal = document.getElementById("year-month-modal");
        const scheduleModal = document.getElementById("schedule-modal");
        const dateArticlesContainer = document.getElementById("date-articles-container");
        
        if (storyModal && storyModal.classList.contains("active")) {
          closeStoryModal();
        } else if (editModal && editModal.classList.contains("active")) {
          closeEditModal();
        } else if (articleModal && articleModal.classList.contains("active")) {
          closeEditArticleModal();
        } else if (yearMonthModal && yearMonthModal.classList.contains("active")) {
          closeYearMonthSelector();
        } else if (scheduleModal && scheduleModal.classList.contains("active")) {
          closeEditScheduleModal();
        } else if (dateArticlesContainer && dateArticlesContainer.style.display !== 'none') {
          dateArticlesContainer.style.display = 'none';
          selectedDate = null;
        }
      }
    });

    // Floating Add Story Button
    const floatingAddBtn = document.getElementById('floating-add-story-btn');
    if (floatingAddBtn) {
      floatingAddBtn.addEventListener('click', () => {
        openEditModal(-1);
      });
      
      // Check initial page state
      const storyPlotsPage = document.getElementById('story-plots-page');
      if (storyPlotsPage && storyPlotsPage.classList.contains('active')) {
        floatingAddBtn.style.display = 'flex';
      } else {
        floatingAddBtn.style.display = 'none';
      }
    }

    // Hero Start Reading Button
    const heroStartBtn = document.getElementById('hero-start-reading-btn');
    if (heroStartBtn) {
      heroStartBtn.addEventListener('click', () => {
        // Switch to story-plots page
        const storyPlotsTab = document.querySelector('[data-page="story-plots"]');
        if (storyPlotsTab) {
          storyPlotsTab.click();
        }
      });
    }

    // Initialize - Load stories from Supabase
    // Wait for DOM and Supabase library to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        // Wait a bit for Supabase library to load
        setTimeout(() => {
          if (!supabase && window.supabase) {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase 连接成功（延迟初始化）');
          }
          initStories();
          initArticles();
        }, 100);
      });
    } else {
      // DOM already loaded
      setTimeout(() => {
        if (!supabase && window.supabase) {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log('Supabase 连接成功（延迟初始化）');
        }
        initStories();
        initArticles();
      }, 100);
    }
  </script>
</body>
</html>
