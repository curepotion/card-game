<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>人生伴侶成長營</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Favicon - Golden Intertwined Hearts (Intimate Feel) -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='gold' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23facc15'/%3E%3Cstop offset='50%25' stop-color='%23f5d76e'/%3E%3Cstop offset='100%25' stop-color='%23facc15'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M35 30 C30 20 20 20 15 30 C15 40 25 50 35 70 C45 50 55 40 55 30 C50 20 40 20 35 30 Z' fill='url(%23gold)'/%3E%3Cpath d='M65 30 C60 20 50 20 45 30 C45 40 55 50 65 70 C75 50 85 40 85 30 C80 20 70 20 65 30 Z' fill='url(%23gold)'/%3E%3Cpath d='M50 50 C48 45 45 45 42 50 C42 55 46 60 50 65 C54 60 58 55 58 50 C55 45 52 45 50 50 Z' fill='%23facc15' opacity='0.8'/%3E%3C/svg%3E" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='gold' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23facc15'/%3E%3Cstop offset='50%25' stop-color='%23f5d76e'/%3E%3Cstop offset='100%25' stop-color='%23facc15'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M35 30 C30 20 20 20 15 30 C15 40 25 50 35 70 C45 50 55 40 55 30 C50 20 40 20 35 30 Z' fill='url(%23gold)'/%3E%3Cpath d='M65 30 C60 20 50 20 45 30 C45 40 55 50 65 70 C75 50 85 40 85 30 C80 20 70 20 65 30 Z' fill='url(%23gold)'/%3E%3Cpath d='M50 50 C48 45 45 45 42 50 C42 55 46 60 50 65 C54 60 58 55 58 50 C55 45 52 45 50 50 Z' fill='%23facc15' opacity='0.8'/%3E%3C/svg%3E" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Noto Serif SC", "Noto Serif TC", "Source Han Serif SC", "Source Han Serif TC", serif, system-ui, sans-serif;
    }

    :root {
      --bg-black: #1C1C1C;
      --card-black: #252525;
      --panel-black: #2F2F2F;
      --border-gold: #c59e6b;
      --gold: #c59e6b;
      --gold-bright: #D4AF37;
      --gold-soft: #d4ac6e;
      --gold-bronze: #A08334;
      --gold-dark: #8b6a46;
      --text-main: #c59e6b;
      --text-sub: #CCCCCC;
      --text-muted: #888888;
      --gray-border: #444444;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at top, rgba(197, 158, 107, 0.15), transparent 55%),
        radial-gradient(circle at bottom, rgba(139, 106, 70, 0.12), transparent 60%),
        var(--bg-black);
      color: var(--text-main);
      padding: 0;
      overflow-x: hidden;
    }

    /* Navigation Tabs */
    .nav-container {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(28, 28, 28, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(197, 158, 107, 0.3);
      padding: 12px 16px;
    }

    .nav-tabs {
      display: flex;
      gap: 8px;
      max-width: 600px;
      margin: 0 auto;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    .nav-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 8px;
      margin: 0 16px;
      transition: all 0.2s ease;
      border-radius: 8px;
      flex-shrink: 0;
    }

    .nav-logo:hover {
      background: rgba(197, 158, 107, 0.1);
      transform: scale(1.05);
    }

    .nav-logo svg {
      width: 32px;
      height: 32px;
      display: block;
    }

    .nav-tab {
      flex: 1;
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-radius: 0;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      text-align: center;
      min-width: 0;
      position: relative;
      transition: color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      outline: none;
    }

    .nav-tab::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 2px;
      background: var(--gold);
      transform: translateX(-50%);
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                  opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
    }

    .nav-tab:hover {
      color: var(--text-sub);
    }

    .nav-tab:hover::after {
      width: 80%;
      opacity: 0.8;
    }

    .nav-tab:focus,
    .nav-tab:focus-visible {
      color: var(--gold);
      outline: none;
    }

    .nav-tab:focus::after,
    .nav-tab:focus-visible::after {
      width: 100%;
      opacity: 1;
    }

    .nav-tab.active {
      color: var(--gold);
      background: transparent;
      border: none;
      box-shadow: none;
    }

    .nav-tab.active::after {
      width: 100%;
      opacity: 1;
    }

    /* Page Container */
    .page-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px 16px;
      min-height: calc(100vh - 80px);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Games Page - Align content to top */
    .page-container.games-active {
      align-items: flex-start;
      justify-content: center;
      padding-top: 20px;
    }
    
    .page-container:has(#games-page.active) {
      align-items: flex-start;
      justify-content: center;
      padding-top: 20px;
    }

    /* Story Plots Content - Full Width Layout */
    .page-container.story-plots-fullwidth {
      max-width: 100%;
      width: 100%;
      padding: 20px 16px;
    }

    #story-plots-content {
      width: 100%;
      max-width: 100%;
    }

    #story-plots-content .app-header {
      width: 100%;
      max-width: 100%;
      position: relative;
    }

    #story-plots-content .story-grid {
      width: 100%;
      max-width: 100%;
      padding: 0;
    }

    /* Story Plots Add Button */
    .story-plots-add-btn {
      margin-top: 16px;
      padding: 10px 20px;
      background: linear-gradient(135deg, rgba(197, 158, 107, 0.2), rgba(197, 158, 107, 0.15));
      border: 1px solid rgba(197, 158, 107, 0.4);
      border-radius: 8px;
      color: var(--gold);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .story-plots-add-btn:hover {
      background: linear-gradient(135deg, rgba(197, 158, 107, 0.3), rgba(197, 158, 107, 0.25));
      border-color: var(--gold);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(197, 158, 107, 0.2);
    }

    .story-plots-add-btn:active {
      transform: translateY(0);
    }

    /* Story Plots Page Container - Full Width */
    .page-container.story-plots-active {
      max-width: 100%;
      padding: 0;
      align-items: flex-start;
    }

    /* Hero Story Page Container - Full Width, No Padding */
    .page-container:has(#hero-story-page.active) {
      max-width: 100%;
      padding: 0;
      margin: 0;
      min-height: 100vh;
    }

    /* Fallback for browsers that don't support :has() */
    .page-container.hero-story-active {
      max-width: 100%;
      padding: 0;
      margin: 0;
      min-height: 100vh;
    }

    .page {
      display: none;
      animation: fadeIn 0.3s ease-in;
      width: 100%;
    }

    .page.active {
      display: block;
    }

    #role-draw-page.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Games Page with Tabs */
    #games-page.active {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      width: 100%;
    }

    .game-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      padding: 0 40px;
      justify-content: center;
    }

    .game-tab {
      padding: 10px 24px;
      background: rgba(68, 68, 68, 0.3);
      border: 1px solid rgba(68, 68, 68, 0.4);
      border-radius: 12px;
      color: var(--text-sub);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .game-tab:hover {
      background: rgba(68, 68, 68, 0.4);
      border-color: rgba(197, 158, 107, 0.4);
    }

    .game-tab.active {
      background: rgba(197, 158, 107, 0.2);
      border-color: rgba(197, 158, 107, 0.6);
      color: var(--text-main);
    }

    .game-content {
      display: none;
      width: 100%;
      max-width: 100%;
    }

    .game-content.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 100%;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* App Card Style */
    .app {
      background: radial-gradient(circle at top left, #2F2F2F, #252525 55%, #1C1C1C);
      border-radius: 20px;
      box-shadow:
        0 20px 55px rgba(0, 0, 0, 0.85),
        0 0 0 1px rgba(197, 158, 107, 0.3);
      padding: 22px 20px 26px;
      width: 100%;
      color: var(--text-main);
    }

    .app-header {
      text-align: center;
      margin-bottom: 16px;
    }

    .app-title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--gold);
    }

    .app-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    /* Card Styles */
    .card-wrapper {
      display: flex;
      flex-direction: row !important;
      justify-content: center;
      align-items: stretch;
      margin-top: 24px;
      margin-bottom: 16px;
      padding: 20px 40px;
      gap: 20px;
      flex-wrap: nowrap !important;
    }

    .card {
      width: 300px !important;
      height: 420px;
      flex-shrink: 0;
      flex-grow: 0;
      border-radius: 16px;
      background:
        radial-gradient(circle at 20% 30%, rgba(197, 158, 107, 0.18), transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(139, 106, 70, 0.15), transparent 50%),
        linear-gradient(135deg, rgba(37, 37, 37, 0.95), rgba(28, 28, 28, 0.98));
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.8),
        0 0 0 2px rgba(197, 158, 107, 0.4),
        0 0 0 4px rgba(0, 0, 0, 0.3),
        inset 0 2px 4px rgba(197, 158, 107, 0.1),
        inset 0 -2px 4px rgba(0, 0, 0, 0.3);
      color: var(--text-sub);
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(197, 158, 107, 0.2);
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(
        135deg,
        rgba(197, 158, 107, 0.1) 0%,
        transparent 30%,
        transparent 70%,
        rgba(139, 106, 70, 0.08) 100%
      );
      pointer-events: none;
      z-index: 0;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: 1px;
      border-radius: inherit;
      background: linear-gradient(
        180deg,
        rgba(197, 158, 107, 0.12) 0%,
        transparent 50%,
        transparent 100%
      );
      mix-blend-mode: overlay;
      opacity: 0.6;
      pointer-events: none;
      z-index: 0;
    }

    .card:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow:
        0 28px 60px rgba(0, 0, 0, 0.98),
        0 0 0 1px rgba(197, 158, 107, 0.45),
        inset 0 1px 0 rgba(197, 158, 107, 0.2);
      background:
        radial-gradient(circle at 20% 30%, rgba(197, 158, 107, 0.25), transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(139, 106, 70, 0.2), transparent 50%),
        linear-gradient(135deg, rgba(37, 37, 37, 0.95), rgba(28, 28, 28, 0.98));
    }

    .card:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow:
        0 12px 40px rgba(0, 0, 0, 0.9),
        0 0 0 2px rgba(197, 158, 107, 0.5),
        0 0 0 4px rgba(0, 0, 0, 0.4),
        inset 0 2px 4px rgba(197, 158, 107, 0.15),
        inset 0 -2px 4px rgba(0, 0, 0, 0.4);
    }

    .card:active {
      transform: translateY(0px) scale(0.99);
      box-shadow:
        0 6px 20px rgba(0, 0, 0, 0.85),
        0 0 0 2px rgba(197, 158, 107, 0.4),
        0 0 0 4px rgba(0, 0, 0, 0.3),
        inset 0 2px 4px rgba(197, 158, 107, 0.1),
        inset 0 -2px 4px rgba(0, 0, 0, 0.3);
    }

    .card-title {
      font-size: 10px;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: rgba(136, 136, 136, 0.7);
      margin-bottom: 16px;
      position: relative;
      z-index: 1;
      font-weight: 600;
      text-align: center;
    }

    .card-main {
      font-size: 22px;
      font-weight: 700;
      text-align: center;
      position: relative;
      z-index: 1;
      color: rgba(197, 158, 107, 0.95);
      line-height: 1.5;
      letter-spacing: 0.02em;
      margin: 0;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
    }

    .card-role-info {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .card-attitude {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 500;
      color: rgba(197, 158, 107, 0.9);
      margin: 0;
      padding: 8px 16px;
      background: rgba(197, 158, 107, 0.12);
      border-radius: 12px;
      border: 1px solid rgba(197, 158, 107, 0.25);
      width: fit-content;
      position: relative;
      z-index: 1;
    }

    .card-attitude::before {
      content: "態度";
      font-size: 10px;
      letter-spacing: 0.1em;
      color: rgba(197, 158, 107, 0.6);
      margin-right: 8px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .card-scene {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 500;
      color: rgba(204, 204, 204, 0.9);
      margin: 0;
      padding: 8px 16px;
      background: rgba(68, 68, 68, 0.3);
      border-radius: 12px;
      border: 1px solid rgba(68, 68, 68, 0.4);
      width: fit-content;
      position: relative;
      z-index: 1;
      gap: 4px;
    }

    .card-scene::before {
      content: "地點";
      font-size: 10px;
      letter-spacing: 0.1em;
      color: rgba(136, 136, 136, 0.6);
      margin-bottom: 4px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .card-scene .korean-text {
      font-size: 14px;
      font-weight: 500;
      color: rgba(204, 204, 204, 0.9);
      line-height: 1.4;
      text-align: center;
    }

    .card-scene .korean-roman {
      font-size: 10px;
      font-weight: 400;
      color: rgba(136, 136, 136, 0.7);
      font-style: italic;
      margin-top: 4px;
      padding: 0;
      background: transparent;
      border: none;
      width: auto;
      line-height: 1.3;
      text-align: center;
    }

    .result-attitude {
      display: inline-flex;
      align-items: center;
      font-size: 13px;
      font-weight: 500;
      color: rgba(197, 158, 107, 0.9);
      margin-top: 8px;
      padding: 6px 12px;
      background: rgba(197, 158, 107, 0.12);
      border-radius: 8px;
      border: 1px solid rgba(197, 158, 107, 0.25);
    }

    .result-attitude::before {
      content: "態度";
      font-size: 9px;
      letter-spacing: 0.1em;
      color: rgba(197, 158, 107, 0.6);
      margin-right: 6px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .result-scene {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      font-size: 13px;
      font-weight: 500;
      color: rgba(204, 204, 204, 0.9);
      margin-top: 8px;
      padding: 6px 12px;
      background: rgba(68, 68, 68, 0.3);
      border-radius: 8px;
      border: 1px solid rgba(68, 68, 68, 0.4);
      gap: 3px;
    }

    .result-scene::before {
      content: "地點";
      font-size: 9px;
      letter-spacing: 0.1em;
      color: rgba(136, 136, 136, 0.6);
      margin-bottom: 3px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .result-scene .korean-text {
      font-size: 13px;
      font-weight: 500;
      color: rgba(204, 204, 204, 0.9);
      line-height: 1.4;
      text-align: center;
    }

    .result-scene .korean-roman {
      font-size: 9px;
      font-weight: 400;
      color: rgba(136, 136, 136, 0.7);
      font-style: italic;
      margin-top: 3px;
      padding: 0;
      background: transparent;
      border: none;
      width: auto;
      line-height: 1.3;
      text-align: center;
    }

    .card-hint {
      margin-top: 16px;
      font-size: 11px;
      color: rgba(136, 136, 136, 0.6);
      position: relative;
      z-index: 1;
      text-align: center;
      font-weight: 500;
      letter-spacing: 0.05em;
    }

    /* Story Plots Page - Full Width */
    #story-plots-page .app {
      max-width: 100%;
      width: 100%;
      background: transparent;
      border-radius: 0;
      box-shadow: none;
      border: none;
      padding: 0;
    }

    /* Games Page - Remove Background Card */
    #games-page .app {
      background: transparent;
      border-radius: 0;
      box-shadow: none;
      border: none;
      padding: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      margin-top: 0;
    }

    /* Story Cards Grid */
    .story-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 20px;
      width: 100%;
      padding: 0;
    }

    /* Dream Grid - 3 columns layout */
    #husband-dream-grid,
    #wife-dream-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 20px;
      width: 100%;
      padding: 0;
    }

    .story-card {
      background:
        radial-gradient(circle at top left, rgba(197, 158, 107, 0.25), transparent 50%),
        var(--card-black);
      border: 1px solid rgba(197, 158, 107, 0.3);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .story-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, rgba(197, 158, 107, 0.8), transparent);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .story-card:hover {
      transform: translateY(-4px);
      border-color: var(--gold);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
    }

    .story-card:hover::before {
      opacity: 1;
    }

    .story-card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .story-card-preview {
      font-size: 14px;
      color: var(--text-sub);
      line-height: 1.6;
      margin-bottom: 12px;
      position: relative;
      z-index: 1;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .story-card-meta {
      font-size: 12px;
      color: var(--text-muted);
      position: relative;
      z-index: 1;
    }

    /* Life Planning Page - Articles List */
    #life-planning-page .app {
      max-width: 100%;
      width: 100%;
      background: transparent;
      border-radius: 0;
      box-shadow: none;
      border: none;
      padding: 0;
    }

    /* Calendar Styles */
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 0;
      margin-top: 20px;
      border-bottom: 1px solid rgba(197, 158, 107, 0.25);
    }

    .calendar-nav-btn {
      width: 40px;
      height: 40px;
      background: rgba(197, 158, 107, 0.15);
      border: 1px solid rgba(197, 158, 107, 0.3);
      border-radius: 8px;
      color: var(--gold);
      font-size: 24px;
      font-weight: 300;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .calendar-nav-btn:hover {
      background: rgba(197, 158, 107, 0.25);
      border-color: var(--gold);
      transform: scale(1.1);
    }

    .calendar-date-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      justify-content: center;
    }

    .date-selector-btn {
      background: rgba(197, 158, 107, 0.15);
      border: 1px solid rgba(197, 158, 107, 0.3);
      border-radius: 8px;
      padding: 8px 16px;
      color: var(--gold);
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 60px;
    }

    .date-selector-btn:hover {
      background: rgba(197, 158, 107, 0.25);
      border-color: var(--gold);
      transform: translateY(-2px);
    }

    .date-separator {
      color: var(--text-muted);
      font-size: 16px;
    }

    .calendar-container {
      margin-top: 20px;
      position: relative;
      z-index: 1;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .weekday {
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      padding: 8px 0;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      position: relative;
      z-index: 1;
    }

    .calendar-day {
      aspect-ratio: 1;
      background: rgba(37, 37, 37, 0.5);
      border: 1px solid rgba(197, 158, 107, 0.25);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 8px 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      min-height: 60px;
      z-index: 1;
      pointer-events: auto !important;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    .calendar-day * {
      pointer-events: none;
    }

    .calendar-day:hover {
      background: rgba(197, 158, 107, 0.15);
      border-color: var(--gold);
      transform: translateY(-2px);
    }

    .calendar-day.other-month {
      opacity: 0.3;
      background: rgba(37, 37, 37, 0.3);
    }

    .calendar-day.today {
      border-color: var(--gold);
      background: rgba(197, 158, 107, 0.2);
      box-shadow: 0 0 0 2px rgba(197, 158, 107, 0.4);
    }

    .calendar-day.has-articles {
      border-color: var(--gold);
      background: rgba(197, 158, 107, 0.25);
    }

    .calendar-day-number {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    .calendar-day.today .calendar-day-number {
      color: var(--gold);
      font-weight: 700;
    }

    .calendar-day-articles-count {
      font-size: 10px;
      color: var(--gold);
      background: rgba(197, 158, 107, 0.35);
      border-radius: 10px;
      padding: 2px 6px;
      margin-top: 4px;
    }

    /* Year/Month Selector Modal */
    .year-month-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
    }

    .year-month-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .year-month-modal-content {
      background: radial-gradient(circle at top left, #2F2F2F, #252525 55%, #1C1C1C);
      border: 1px solid rgba(197, 158, 107, 0.45);
      border-radius: 20px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .year-month-modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: 1px solid rgba(197, 158, 107, 0.45);
      color: var(--gold);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.2s ease;
    }

    .year-month-modal-close:hover {
      background: rgba(197, 158, 107, 0.15);
      border-color: var(--gold);
    }

    .year-month-modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 20px;
      text-align: center;
    }

    .year-month-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      max-height: 400px;
      overflow-y: auto;
    }

    .year-month-item {
      padding: 12px;
      background: rgba(197, 158, 107, 0.15);
      border: 1px solid rgba(197, 158, 107, 0.3);
      border-radius: 8px;
      color: var(--text-sub);
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .year-month-item:hover {
      background: rgba(197, 158, 107, 0.25);
      border-color: var(--gold);
      color: var(--gold);
      transform: translateY(-2px);
    }

    .year-month-item.selected {
      background: linear-gradient(135deg, rgba(197, 158, 107, 0.35), rgba(197, 158, 107, 0.25));
      border-color: var(--gold);
      color: var(--gold);
      font-weight: 600;
    }

    /* Date Articles Container */
    .date-articles-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }
    
    .date-articles-container .date-articles-inner {
      max-width: 1200px;
      margin: 0 auto;
      background: radial-gradient(circle at top left, #2F2F2F, #252525 55%, #1C1C1C);
      border: 1px solid rgba(197, 158, 107, 0.3);
      border-radius: 12px;
      padding: 24px;
      margin-top: 40px;
      margin-bottom: 40px;
    }

    .date-articles-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(197, 158, 107, 0.25);
    }

    .selected-date-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--gold);
      margin: 0;
    }

    .btn-close-articles {
      width: 32px;
      height: 32px;
      background: transparent;
      border: 1px solid rgba(197, 158, 107, 0.3);
      border-radius: 50%;
      color: var(--gold);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .btn-close-articles:hover {
      background: rgba(197, 158, 107, 0.15);
      border-color: var(--gold);
    }

    .date-articles-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Schedule Section Styles */
    .schedule-section {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid rgba(197, 158, 107, 0.25);
    }

    .schedule-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .schedule-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gold);
      margin: 0;
    }

    .btn-add-schedule {
      background: rgba(197, 158, 107, 0.15);
      border: 1px solid rgba(197, 158, 107, 0.3);
      border-radius: 8px;
      color: var(--gold);
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-add-schedule:hover {
      background: rgba(197, 158, 107, 0.25);
      border-color: var(--gold);
      transform: translateY(-2px);
    }

    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .schedule-item {
      background: rgba(37, 37, 37, 0.7);
      border: 1px solid rgba(197, 158, 107, 0.25);
      border-radius: 8px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      transition: all 0.2s ease;
    }

    .schedule-item:hover {
      border-color: rgba(197, 158, 107, 0.45);
      background: rgba(37, 37, 37, 0.85);
    }

    .schedule-item-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .schedule-item-time {
      font-size: 14px;
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 4px;
    }

    .schedule-item-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-sub);
      margin: 0;
    }

    .schedule-item-description {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.5;
      margin: 0;
    }

    .schedule-item-actions {
      display: flex;
      gap: 8px;
    }

    .schedule-item-btn {
      width: 32px;
      height: 32px;
      background: transparent;
      border: 1px solid rgba(197, 158, 107, 0.3);
      border-radius: 6px;
      color: var(--gold);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .schedule-item-btn:hover {
      background: rgba(197, 158, 107, 0.15);
      border-color: var(--gold);
    }

    .schedule-item-btn.delete-btn {
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.3);
    }

    .schedule-item-btn.delete-btn:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
    }

    .articles-section {
      margin-top: 24px;
    }

    .articles-section-header {
      margin-bottom: 16px;
    }

    .articles-section-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gold);
      margin: 0;
    }

    /* Schedule Edit Modal */
    .schedule-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
    }

    .schedule-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .schedule-modal-content {
      background: radial-gradient(circle at top left, #2F2F2F, #252525 55%, #1C1C1C);
      border: 1px solid rgba(197, 158, 107, 0.45);
      border-radius: 20px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .schedule-modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: 1px solid rgba(197, 158, 107, 0.45);
      color: var(--gold);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.2s ease;
    }

    .schedule-modal-close:hover {
      background: rgba(197, 158, 107, 0.15);
      border-color: var(--gold);
    }

    .schedule-modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 20px;
      padding-right: 40px;
    }

    .schedule-form-group {
      margin-bottom: 16px;
    }

    .schedule-form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-sub);
      margin-bottom: 8px;
    }

    .schedule-form-input {
      width: 100%;
      padding: 12px 14px;
      background: rgba(37, 37, 37, 0.7);
      border: 1px solid rgba(197, 158, 107, 0.3);
      border-radius: 8px;
      color: var(--text-sub);
      font-size: 14px;
      transition: all 0.2s ease;
      box-sizing: border-box;
    }

    .schedule-form-input:focus {
      outline: none;
      border-color: var(--gold);
      background: rgba(37, 37, 37, 0.85);
    }

    .schedule-form-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .schedule-btn-cancel,
    .schedule-btn-save {
      flex: 1;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .schedule-btn-cancel {
      background: transparent;
      border: 1px solid rgba(197, 158, 107, 0.3);
      color: var(--text-sub);
    }

    .schedule-btn-cancel:hover {
      background: rgba(197, 158, 107, 0.15);
      border-color: var(--gold);
      color: var(--gold);
    }

    .schedule-btn-save {
      background: linear-gradient(135deg, rgba(197, 158, 107, 0.35), rgba(197, 158, 107, 0.25));
      border: 1px solid var(--gold);
      color: var(--gold);
    }

    .schedule-btn-save:hover {
      background: linear-gradient(135deg, rgba(197, 158, 107, 0.45), rgba(197, 158, 107, 0.35));
      transform: translateY(-2px);
    }

    /* Hero Story Page - Full Width */
    #hero-story-page {
      width: 100%;
      max-width: 100%;
      padding: 0;
      margin: 0;
    }

    #hero-story-page.active {
      display: block;
    }

    /* Hero Section Layout */
    .hero-section {
      position: relative;
      width: 100%;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    /* Background Visuals Placeholder */
    .hero-background {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(circle at 20% 30%, rgba(197, 158, 107, 0.18), transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(139, 106, 70, 0.15), transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(160, 131, 52, 0.1), transparent 60%),
        var(--bg-black);
      z-index: 0;
    }

    /* Hero Content Block - Centered */
    .hero-content {
      position: relative;
      z-index: 1;
      max-width: 900px;
      width: 100%;
      padding: 60px 40px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
    }

    /* Hero Header */
    .hero-header {
      width: 100%;
    }

    /* Large Title */
    .hero-title {
      font-size: 42px;
      font-weight: 700;
      color: var(--gold);
      margin: 0 0 24px 0;
      letter-spacing: 0.05em;
      line-height: 1.3;
    }

    /* Medium Subtitle Paragraph */
    .hero-subtitle {
      font-size: 18px;
      color: var(--text-sub);
      line-height: 1.8;
      margin: 0;
      letter-spacing: 0.02em;
    }

    /* Hero Actions */
    .hero-actions {
      margin-top: 8px;
    }

    /* Primary CTA Button */
    .hero-cta-primary {
      padding: 16px 40px;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(135deg, #c59e6b, #d4ac6e);
      color: #1C1C1C;
      border: 2px solid rgba(197, 158, 107, 0.6);
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(197, 158, 107, 0.4);
      letter-spacing: 0.05em;
    }

    .hero-cta-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(197, 158, 107, 0.5), 0 0 0 1px rgba(197, 158, 107, 0.6);
      background: linear-gradient(135deg, #d4ac6e, #c59e6b);
    }

    .hero-cta-primary:active {
      transform: translateY(0);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    /* Hero Footer - Optional Small Secondary Text */
    .hero-footer {
      margin-top: 8px;
    }

    .hero-description {
      font-size: 14px;
      color: var(--text-muted);
      margin: 0;
      font-style: italic;
      letter-spacing: 0.01em;
    }

    /* Optional: Cover Illustration Placeholder */
    .hero-illustration {
      margin-top: 24px;
      width: 100%;
      max-width: 600px;
      height: 300px;
      /* Placeholder for cover illustration */
      background: radial-gradient(circle at center, rgba(197, 158, 107, 0.15), transparent 70%);
      border-radius: 16px;
      border: 1px dashed rgba(197, 158, 107, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 14px;
    }

    /* Truth & Dare Game Page */
    #lovense-game-page .app {
      max-width: 100%;
      width: 100%;
    }

    /* Truth & Dare Game Page - Uses same card styles as role draw */

    .lovense-game-container {
      margin-top: 24px;
      width: 100%;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Connection Status */
    .connection-status {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: rgba(37, 37, 37, 0.7);
      border: 1px solid rgba(197, 158, 107, 0.3);
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: all 0.3s ease;
    }

    .status-indicator.connected {
      background: #10b981;
      box-shadow: 0 0 12px rgba(16, 185, 129, 0.5);
    }

    .status-indicator.connecting {
      background: var(--gold);
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    #status-text {
      color: var(--text-sub);
      font-size: 14px;
      font-weight: 500;
    }

    /* Connection Panel */
    .connection-panel {
      background: rgba(37, 37, 37, 0.5);
      border: 1px solid rgba(197, 158, 107, 0.25);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .btn-connect {
      width: 100%;
      padding: 12px 24px;
      background: linear-gradient(135deg, #c59e6b, #d4ac6e);
      color: #111827;
      border: 1px solid rgba(197, 158, 107, 0.6);
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 16px;
    }

    .btn-connect:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(197, 158, 107, 0.4);
    }

    .btn-connect:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Control Panel */
    .control-panel {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .control-section {
      background: rgba(37, 37, 37, 0.5);
      border: 1px solid rgba(197, 158, 107, 0.25);
      border-radius: 12px;
      padding: 24px;
    }

    .control-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--gold);
      margin: 0 0 20px 0;
    }

    .control-group {
      margin-bottom: 20px;
    }

    .control-group label {
      display: block;
      font-size: 14px;
      color: var(--text-sub);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(68, 68, 68, 0.4);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--gold);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(197, 158, 107, 0.5);
      transition: all 0.2s ease;
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 4px 12px rgba(197, 158, 107, 0.7);
    }

    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--gold);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(197, 158, 107, 0.5);
    }

    .control-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .btn-control {
      flex: 1;
      padding: 12px 24px;
      background: rgba(197, 158, 107, 0.15);
      border: 1px solid rgba(197, 158, 107, 0.45);
      border-radius: 8px;
      color: var(--gold);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-control:hover {
      background: rgba(197, 158, 107, 0.25);
      border-color: var(--gold);
      transform: translateY(-2px);
    }

    .btn-control:active {
      transform: translateY(0);
    }

    .btn-control.active {
      background: linear-gradient(135deg, #c59e6b, #d4ac6e);
      color: #111827;
      border-color: var(--gold);
    }

    /* Pattern Grid */
    .pattern-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .pattern-btn {
      padding: 12px 16px;
      background: rgba(197, 158, 107, 0.15);
      border: 1px solid rgba(197, 158, 107, 0.3);
      border-radius: 8px;
      color: var(--text-sub);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .pattern-btn:hover {
      background: rgba(197, 158, 107, 0.25);
      border-color: var(--gold);
      color: var(--gold);
      transform: translateY(-2px);
    }

    .pattern-btn.active {
      background: linear-gradient(135deg, rgba(197, 158, 107, 0.35), rgba(197, 158, 107, 0.25));
      border-color: var(--gold);
      color: var(--gold);
    }

    /* Game Buttons */
    .game-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .game-btn {
      padding: 14px 24px;
      background: rgba(197, 158, 107, 0.15);
      border: 1px solid rgba(197, 158, 107, 0.45);
      border-radius: 8px;
      color: var(--gold);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .game-btn:hover {
      background: rgba(197, 158, 107, 0.25);
      border-color: var(--gold);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(197, 158, 107, 0.3);
    }

    .articles-container {
      margin-top: 24px;
      width: 100%;
    }

    .article-item {
      background: radial-gradient(circle at top left, rgba(197, 158, 107, 0.18), transparent 50%),
        var(--card-black);
      border: 1px solid rgba(197, 158, 107, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .article-item:hover {
      transform: translateY(-2px);
      border-color: var(--gold);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .article-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      gap: 16px;
    }

    .article-item-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gold);
      flex: 1;
      margin: 0;
    }

    .article-item-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .article-item-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid rgba(197, 158, 107, 0.45);
      background: rgba(37, 37, 37, 0.85);
      color: var(--gold);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.2s ease;
      backdrop-filter: blur(4px);
    }

    .article-item-btn:hover {
      background: rgba(197, 158, 107, 0.25);
      border-color: var(--gold);
      transform: scale(1.1);
    }

    .article-item-btn.delete-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
      color: #ef4444;
    }

    .article-item-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .article-item-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .article-item-meta-label {
      color: var(--text-muted);
      font-weight: 500;
    }

    .article-item-meta-value {
      color: var(--text-sub);
    }

    .article-item-content {
      font-size: 14px;
      color: var(--text-sub);
      line-height: 1.7;
      margin-top: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .add-article-btn {
      background: linear-gradient(135deg, rgba(197, 158, 107, 0.25), rgba(197, 158, 107, 0.15));
      border: 2px dashed rgba(197, 158, 107, 0.6);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--gold);
      font-size: 16px;
      font-weight: 600;
      margin-top: 20px;
    }

    .add-article-btn:hover {
      border-color: var(--gold);
      background: rgba(197, 158, 107, 0.2);
      transform: translateY(-2px);
    }

    .add-article-btn::before {
      content: "+";
      display: block;
      font-size: 32px;
      margin-bottom: 8px;
      font-weight: 300;
    }

    .story-card-actions {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 10;
    }

    .story-card-menu-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid rgba(197, 158, 107, 0.3);
      background: rgba(37, 37, 37, 0.85);
      color: var(--gold);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
      backdrop-filter: blur(4px);
      padding: 0;
      line-height: 1;
    }

    .story-card-menu-btn:hover {
      background: rgba(197, 158, 107, 0.15);
      border-color: var(--gold);
      transform: scale(1.05);
    }

    .story-card-menu-btn.active {
      background: rgba(197, 158, 107, 0.25);
      border-color: var(--gold);
    }

    .story-card-menu-dropdown {
      position: absolute;
      top: 40px;
      right: 0;
      background: var(--card-black);
      border: 1px solid rgba(197, 158, 107, 0.4);
      border-radius: 8px;
      padding: 6px;
      min-width: 120px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
      display: none;
      z-index: 20;
      backdrop-filter: blur(8px);
    }

    .story-card-menu-dropdown.show {
      display: block;
      animation: fadeIn 0.2s ease;
    }

    .story-card-menu-item {
      padding: 10px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-sub);
    }

    .story-card-menu-item:hover {
      background: rgba(197, 158, 107, 0.1);
      color: var(--gold);
    }

    .story-card-menu-item.edit {
      border-bottom: 1px solid rgba(197, 158, 107, 0.2);
      margin-bottom: 4px;
      padding-bottom: 10px;
    }

    .story-card-menu-item.delete {
      color: #ef4444;
    }

    .story-card-menu-item.delete:hover {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    /* Floating Action Button for Add Story */
    .add-story-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #c59e6b, #d4ac6e);
      border: 2px solid rgba(197, 158, 107, 0.6);
      color: #111827;
      font-size: 36px;
      font-weight: 300;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(197, 158, 107, 0.4);
      transition: all 0.3s ease;
      z-index: 999;
      line-height: 1;
    }

    .add-story-btn:hover {
      transform: scale(1.1) translateY(-2px);
      box-shadow: 0 12px 32px rgba(197, 158, 107, 0.5), 0 0 0 1px rgba(197, 158, 107, 0.6);
      background: linear-gradient(135deg, #d4ac6e, #c59e6b);
    }

    .add-story-btn:active {
      transform: scale(0.95);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    /* Edit Modal Styles */
    .edit-form {
      padding: 24px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-group label {
      display: block;
      font-size: 15px;
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 10px;
      letter-spacing: 0.02em;
    }

    .form-input,
    .form-textarea {
      width: 100%;
      padding: 14px 16px;
      background: rgba(37, 37, 37, 0.75);
      border: 1px solid rgba(197, 158, 107, 0.3);
      border-radius: 10px;
      color: var(--text-sub);
      font-size: 16px;
      font-family: inherit;
      transition: all 0.2s ease;
      line-height: 1.6;
      box-sizing: border-box;
    }

    .form-input::placeholder,
    .form-textarea::placeholder {
      color: var(--text-muted);
      opacity: 0.6;
    }

    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--gold);
      background: rgba(37, 37, 37, 0.9);
      box-shadow: 0 0 0 3px rgba(197, 158, 107, 0.15);
    }

    .form-input {
      min-height: 48px;
    }

    .form-textarea {
      min-height: 300px;
      resize: vertical;
      line-height: 1.7;
      letter-spacing: 0.01em;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .btn-cancel,
    .btn-save {
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid;
    }

    .btn-cancel {
      background: transparent;
      border-color: rgba(68, 68, 68, 0.5);
      color: var(--text-muted);
    }

    .btn-cancel:hover {
      border-color: var(--text-muted);
      color: var(--text-sub);
    }

    .btn-save {
      background: linear-gradient(135deg, #c59e6b, #d4ac6e);
      border-color: rgba(197, 158, 107, 0.75);
      color: #111827;
    }

    .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(197, 158, 107, 0.4);
    }

    /* Modal for Story Details */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      z-index: 1000;
      padding: 0;
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
    }

    .modal.active {
      display: block;
    }

    .modal-content {
      background: radial-gradient(circle at top left, #2F2F2F, #252525 55%, #1C1C1C);
      border: none;
      border-radius: 0;
      padding: 0;
      min-height: 100vh;
      width: 100%;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .modal-close {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(37, 37, 37, 0.95);
      border: 1px solid rgba(197, 158, 107, 0.6);
      color: var(--gold);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.2s ease;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    .modal-close:hover {
      background: rgba(197, 158, 107, 0.25);
      border-color: var(--gold);
      transform: scale(1.1);
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--gold);
      margin: 0;
      padding: 50px 20px 20px;
      text-align: center;
      border-bottom: 1px solid rgba(197, 158, 107, 0.25);
      background: rgba(197, 158, 107, 0.08);
    }

    .modal-body {
      font-size: 15px;
      color: var(--text-sub);
      line-height: 1.6;
      white-space: pre-line;
      padding: 24px 20px;
      max-width: 700px;
      width: 100%;
      margin: 0 auto;
      letter-spacing: 0.01em;
    }

    /* 文章内容样式 - 大标题 */
    .modal-body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Noto Serif SC", "Noto Serif TC", "Source Han Serif SC", "Source Han Serif TC", serif, system-ui, sans-serif;
    }

    /* 使用CSS来样式化文本内容 */
    .modal-body {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    /* 通过JavaScript处理的样式类 */
    .article-main-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold);
      margin: 20px 0 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(197, 158, 107, 0.4);
      letter-spacing: 0.03em;
      text-align: center;
    }

    .article-main-title:first-child {
      margin-top: 0;
    }

    .article-chapter-title {
      font-size: 17px;
      font-weight: 600;
      color: var(--gold-soft);
      margin: 18px 0 10px;
      padding: 8px 0 8px 10px;
      border-left: 3px solid rgba(197, 158, 107, 0.7);
      background: rgba(197, 158, 107, 0.08);
      letter-spacing: 0.02em;
    }

    .article-theme {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      margin: 12px 0 10px;
      padding: 6px 0 6px 12px;
      border-left: 2px solid rgba(197, 158, 107, 0.4);
      font-style: italic;
      background: rgba(68, 68, 68, 0.2);
    }

    .article-content {
      font-size: 15px;
      color: var(--text-sub);
      line-height: 1.6;
      margin: 6px 0;
      padding: 0 2px;
      letter-spacing: 0.01em;
    }

    .article-role {
      font-size: 15px;
      font-weight: 600;
      color: var(--gold-soft);
      margin: 14px 0 8px;
      padding: 6px 10px;
      background: rgba(197, 158, 107, 0.12);
      border-radius: 5px;
      display: inline-block;
    }

    /* Shuffle Animation */
    @keyframes shuffle {
      0%   { transform: translateX(0) rotate(0deg); }
      25%  { transform: translateX(-6px) rotate(-2deg); }
      50%  { transform: translateX(6px) rotate(2deg); }
      75%  { transform: translateX(-3px) rotate(-1deg); }
      100% { transform: translateX(0) rotate(0deg); }
    }

    .card.shuffling {
      animation: shuffle 0.26s ease-in-out infinite;
    }

    /* Controls */
    .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      margin-top: 20px;
      padding: 0 40px;
    }

    #draw-btn {
      border: none;
      outline: none;
      padding: 12px 32px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(197, 158, 107, 0.95), rgba(197, 158, 107, 0.85));
      color: rgba(28, 28, 28, 0.95);
      font-weight: 700;
      letter-spacing: 0.1em;
      cursor: pointer;
      font-size: 13px;
      box-shadow:
        0 8px 24px rgba(197, 158, 107, 0.4),
        0 0 0 1px rgba(197, 158, 107, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      position: relative;
      overflow: hidden;
    }

    #draw-btn:hover {
      transform: translateY(-2px);
      box-shadow:
        0 12px 32px rgba(197, 158, 107, 0.5),
        0 0 0 1px rgba(197, 158, 107, 0.6);
      background: linear-gradient(135deg, rgba(197, 158, 107, 1), rgba(197, 158, 107, 0.9));
    }

    #draw-btn:active {
      transform: translateY(0px);
      box-shadow:
        0 4px 16px rgba(197, 158, 107, 0.4),
        0 0 0 1px rgba(197, 158, 107, 0.5);
      filter: brightness(0.95);
    }

    #draw-btn:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow:
        0 4px 10px rgba(0, 0, 0, 0.85),
        0 0 0 1px rgba(68, 68, 68, 0.7);
      background: linear-gradient(135deg, #c59e6b, #CCCCCC);
    }

    .result {
      margin-top: 0;
      text-align: center;
      font-size: 13px;
      color: rgba(136, 136, 136, 0.7);
      font-weight: 500;
      letter-spacing: 0.05em;
    }

    .result-highlight {
      margin-top: 12px;
      font-size: 20px;
      font-weight: 700;
      color: rgba(197, 158, 107, 0.95);
      text-align: center;
      line-height: 1.6;
      letter-spacing: 0.02em;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    /* Truth & Dare Result Styles - Uses same styles as role draw */

    .history {
      margin-top: 18px;
      padding: 12px 40px 0;
      border-top: 1px solid rgba(68, 68, 68, 0.5);
    }

    .history-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      font-size: 13px;
      color: var(--text-sub);
    }

    .history-table tbody {
      display: block;
      max-height: 140px;
      overflow-y: auto;
      width: 100%;
    }

    .history-table tr {
      display: table;
      width: 100%;
      table-layout: fixed;
      border-bottom: 1px solid rgba(68, 68, 68, 0.3);
    }

    .history-table tr:first-child {
      border-top: none;
    }

    .history-table tr:last-child {
      border-bottom: none;
    }

    .history-table td {
      padding: 8px 0;
      text-align: left;
      vertical-align: top;
      word-wrap: break-word;
    }

    .history-interaction-label {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.9);
      margin-right: 4px;
    }

    .history-interaction-value {
      font-size: 13px;
      color: rgba(197, 158, 107, 0.95);
      font-weight: 600;
    }

    /* 保留舊的 .history-list 樣式以防其他地方使用 */
    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 140px;
      overflow-y: auto;
      font-size: 13px;
      color: var(--text-sub);
    }

    .history-list li {
      padding: 4px 0;
      border-bottom: 1px dashed rgba(55, 65, 81, 0.7);
    }

    .history-list li:last-child {
      border-bottom: none;
    }

    /* Mobile Responsive */
    @media (max-width: 480px) {
      .nav-tabs {
        gap: 4px;
      }

      .nav-tab {
        font-size: 12px;
        padding: 8px 10px;
        min-width: 0;
      }

      .nav-logo {
        margin: 0 8px;
        padding: 6px;
      }

      .nav-logo svg {
        width: 28px;
        height: 28px;
      }

      .page-container {
        padding: 16px 12px;
      }

      .page-container.story-plots-active {
        padding: 12px 8px;
      }

      .app {
        margin: 0;
        border-radius: 18px;
        padding: 18px 16px 22px;
      }

      .app-title {
        font-size: 20px;
        letter-spacing: 0.14em;
      }

      .card-wrapper {
        padding: 10px 15px !important;
        margin-top: 20px;
        margin-bottom: 12px;
        flex-direction: row !important;
        gap: 10px !important;
        flex-wrap: nowrap !important;
        justify-content: center !important;
        align-items: stretch;
        display: flex !important;
      }

      .card {
        width: calc(50% - 5px) !important;
        max-width: calc(50% - 5px) !important;
        min-width: calc(50% - 5px) !important;
        height: auto;
        min-height: 280px;
        padding: 16px 12px;
        border-radius: 14px;
        flex-shrink: 0 !important;
        flex-grow: 0 !important;
      }

      .card-main {
        font-size: 14px;
        line-height: 1.4;
      }

      .card-title {
        font-size: 8px;
        margin-bottom: 8px;
        letter-spacing: 0.2em;
      }
      
      .card-hint {
        font-size: 9px;
        margin-top: 8px;
      }
      
      .card-role-info {
        gap: 6px;
        margin-top: 8px;
      }
      
      .card-attitude,
      .card-scene {
        font-size: 11px;
        padding: 4px 8px;
      }

      .card-role-info {
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .card-attitude,
      .card-scene {
        font-size: 13px;
        padding: 6px 12px;
      }

      .card-hint {
        margin-top: 12px;
        font-size: 10px;
      }

      .result-attitude,
      .result-scene {
        font-size: 12px;
        padding: 5px 10px;
      }

      .controls {
        padding: 0;
      }

      #draw-btn {
        width: 100%;
        max-width: 260px;
      }

      /* Truth & Dare Mobile Styles - Uses same styles as role draw */
      .history {
        padding: 12px 0 0;
      }

      .game-tabs {
        padding: 0;
        gap: 8px;
        margin-bottom: 20px;
      }

      .game-tab {
        padding: 8px 16px;
        font-size: 13px;
      }

      .nav-tabs {
        gap: 6px;
      }

      .nav-tab {
        padding: 8px 12px;
        font-size: 13px;
      }

      .story-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      #husband-dream-grid,
      #wife-dream-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .story-card {
        padding: 16px;
      }

      .story-card-title {
        font-size: 16px;
      }

      .article-item {
        padding: 16px;
        margin-bottom: 12px;
      }

      .article-item-title {
        font-size: 16px;
      }

      .article-item-header {
        flex-direction: column;
        gap: 12px;
      }

      .article-item-actions {
        align-self: flex-end;
      }

      .article-item-meta {
        flex-direction: column;
        gap: 8px;
        font-size: 12px;
      }

      .article-item-content {
        font-size: 13px;
        margin-top: 10px;
      }

      .add-article-btn {
        padding: 20px;
        font-size: 14px;
      }

      /* Schedule responsive styles */
      .schedule-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .btn-add-schedule {
        width: 100%;
        padding: 10px;
      }

      /* Story card menu responsive */
      .story-card-menu-dropdown {
        min-width: 100px;
        padding: 4px;
      }

      .story-card-menu-item {
        padding: 8px 10px;
        font-size: 13px;
      }

      .schedule-item {
        flex-direction: column;
        gap: 12px;
      }

      .schedule-item-actions {
        align-self: flex-end;
      }

      .schedule-modal-content {
        max-width: 90%;
        padding: 20px;
      }

      .add-story-btn {
        width: 56px;
        height: 56px;
        bottom: 20px;
        right: 20px;
        font-size: 32px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(197, 158, 107, 0.4);
      }

      .add-story-btn:hover {
        transform: scale(1.05) translateY(-2px);
      }

      .hero-content {
        padding: 40px 20px;
        gap: 24px;
      }

      .hero-title {
        font-size: 28px;
        margin-bottom: 20px;
      }

      .hero-subtitle {
        font-size: 16px;
        line-height: 1.7;
      }

      .hero-cta-primary {
        padding: 14px 32px;
        font-size: 15px;
      }

      .hero-description {
        font-size: 13px;
      }

      .hero-illustration {
        height: 200px;
        margin-top: 20px;
      }

      /* Calendar responsive styles for mobile */
      .calendar-header {
        padding: 12px 0;
      }

      .calendar-nav-btn {
        width: 32px;
        height: 32px;
        font-size: 18px;
      }

      .date-selector-btn {
        padding: 6px 10px;
        font-size: 14px;
        min-width: 45px;
      }

      .date-separator {
        font-size: 14px;
      }

      .calendar-day {
        min-height: 45px;
        padding: 4px 2px;
      }

      .calendar-day-number {
        font-size: 11px;
      }

      .calendar-day-articles-count {
        font-size: 8px;
        padding: 1px 3px;
      }

      .year-month-grid {
        grid-template-columns: repeat(3, 1fr);
      }

      .year-month-item {
        padding: 10px;
        font-size: 13px;
      }

      /* Date Articles Container - Mobile */
      .date-articles-container {
        padding: 12px;
      }

      .date-articles-container .date-articles-inner {
        padding: 16px;
        margin-top: 20px;
        margin-bottom: 20px;
      }

      .selected-date-title {
        font-size: 20px;
      }

      .btn-close-articles {
        width: 28px;
        height: 28px;
        font-size: 18px;
      }

      .lovense-game-container {
        padding: 0 8px;
      }

      .connection-panel,
      .control-section {
        padding: 20px 16px;
      }

      .control-title {
        font-size: 16px;
        margin-bottom: 16px;
      }

      .pattern-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .pattern-btn {
        padding: 10px 12px;
        font-size: 13px;
      }

      .control-buttons {
        flex-direction: column;
      }

      .btn-control {
        width: 100%;
      }

      .modal-content {
        padding: 0;
        margin: 0;
        border-radius: 0;
      }

      .modal-title {
        font-size: 20px;
        padding: 50px 16px 16px;
      }

      .modal-body {
        font-size: 14px;
        padding: 20px 16px;
        line-height: 1.5;
      }

      .modal-close {
        top: 12px;
        right: 12px;
        width: 40px;
        height: 40px;
        font-size: 20px;
      }

      .article-main-title {
        font-size: 18px;
        margin: 16px 0 10px;
        padding-bottom: 8px;
      }

      .article-chapter-title {
        font-size: 16px;
        margin: 14px 0 8px;
        padding: 6px 0 6px 8px;
        border-left-width: 2px;
      }

      .article-theme {
        font-size: 13px;
        margin: 10px 0 8px;
        padding: 5px 0 5px 10px;
      }

      .article-content {
        font-size: 14px;
        line-height: 1.5;
        margin: 5px 0;
      }

      .article-role {
        font-size: 14px;
        margin: 12px 0 6px;
        padding: 5px 8px;
      }

      .story-card-actions {
        top: 8px;
        right: 8px;
        gap: 6px;
      }

      .story-card-edit-btn,
      .story-card-delete-btn {
        width: 28px;
        height: 28px;
        font-size: 12px;
      }

      .edit-form {
        padding: 20px 16px;
        max-width: 100%;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        font-size: 14px;
        margin-bottom: 8px;
      }

      .form-input,
      .form-textarea {
        padding: 12px 14px;
        font-size: 16px;
        border-radius: 8px;
        line-height: 1.6;
      }

      .form-input {
        min-height: 44px;
      }

      .form-textarea {
        min-height: 250px;
        line-height: 1.7;
      }

      .form-actions {
        flex-direction: column-reverse;
        gap: 8px;
      }

      .btn-cancel,
      .btn-save {
        width: 100%;
        padding: 12px;
      }
    }

    /* Tablet and Medium Screens */
    @media (min-width: 481px) and (max-width: 768px) {
      .story-grid {
        grid-template-columns: 1fr;
        gap: 14px;
      }

      #husband-dream-grid,
      #wife-dream-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 14px;
      }

      .modal-body {
        max-width: 650px;
        padding: 24px 24px;
      }

      .modal-title {
        font-size: 22px;
        padding: 50px 24px 20px;
      }

      .edit-form {
        padding: 24px 20px;
        max-width: 100%;
      }

      .form-input,
      .form-textarea {
        font-size: 16px;
        padding: 13px 15px;
      }

      .form-textarea {
        min-height: 280px;
      }

      /* Date Articles Container - Tablet */
      .date-articles-container {
        padding: 16px;
      }

      .date-articles-container .date-articles-inner {
        padding: 20px;
        margin-top: 30px;
        margin-bottom: 30px;
      }

      .selected-date-title {
        font-size: 22px;
      }

      /* Calendar responsive styles */
      .calendar-header {
        padding: 16px 0;
      }

      .calendar-nav-btn {
        width: 36px;
        height: 36px;
        font-size: 20px;
      }

      .date-selector-btn {
        padding: 6px 12px;
        font-size: 16px;
        min-width: 50px;
      }

      .calendar-day {
        min-height: 50px;
        padding: 6px 2px;
      }

      .calendar-day-number {
        font-size: 12px;
      }

      .calendar-day-articles-count {
        font-size: 9px;
        padding: 1px 4px;
      }
    }

    /* Large Screens */
    @media (min-width: 769px) {
      /* Life Planning Page - Desktop: Add padding and limit width */
      .page-container:has(#life-planning-page.active),
      .page-container.story-plots-active:has(#life-planning-page.active) {
        max-width: 1400px;
        padding: 40px;
      }

      #life-planning-page .app {
        max-width: 1200px;
        width: 100%;
        margin: 0 auto;
        padding: 0;
      }

      /* Life Goals Page - Desktop: Add padding and limit width */
      .page-container:has(#life-goals-page.active),
      .page-container.story-plots-active:has(#life-goals-page.active) {
        max-width: 1400px;
        padding: 40px;
      }

      #life-goals-page .app {
        max-width: 1200px;
        width: 100%;
        margin: 0 auto;
        padding: 0;
      }

      .story-grid {
        grid-template-columns: 1fr;
        gap: 16px;
        width: 100%;
      }

      /* Dream Grid - Desktop: 3 columns */
      #husband-dream-grid,
      #wife-dream-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }

      .modal-body {
        max-width: 800px;
        padding: 40px 32px;
      }

      .modal-title {
        font-size: 28px;
        padding: 80px 32px 30px;
      }

      .edit-form {
        padding: 32px;
        max-width: 900px;
      }

      .form-input,
      .form-textarea {
        font-size: 16px;
        padding: 14px 16px;
      }

      .form-textarea {
        min-height: 320px;
      }
    }

    /* Scrollbar Styling */
    .history-list::-webkit-scrollbar,
    .history-table::-webkit-scrollbar,
    .modal-content::-webkit-scrollbar {
      width: 6px;
    }

    .history-list::-webkit-scrollbar-track,
    .history-table::-webkit-scrollbar-track,
    .modal-content::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 3px;
    }

    .history-list::-webkit-scrollbar-thumb,
    .history-table::-webkit-scrollbar-thumb,
    .modal-content::-webkit-scrollbar-thumb {
      background: rgba(197, 158, 107, 0.5);
      border-radius: 3px;
    }

    .history-list::-webkit-scrollbar-thumb:hover,
    .history-table::-webkit-scrollbar-thumb:hover,
    .modal-content::-webkit-scrollbar-thumb:hover {
      background: rgba(197, 158, 107, 0.7);
    }

    /* Life Goals Page Styles */
    #life-goals-page .app {
      max-width: 100%;
      width: 100%;
      background: transparent;
      border-radius: 0;
      box-shadow: none;
      border: none;
      padding: 0;
    }

    #life-goals-page.active {
      display: block;
    }

    /* Person Tabs */
    .person-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      padding: 0 40px;
      justify-content: center;
    }

    .person-tab {
      padding: 10px 24px;
      background: rgba(68, 68, 68, 0.3);
      border: 1px solid rgba(68, 68, 68, 0.4);
      border-radius: 12px;
      color: var(--text-sub);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .person-tab:hover {
      background: rgba(68, 68, 68, 0.4);
      border-color: rgba(197, 158, 107, 0.4);
    }

    .person-tab.active {
      background: rgba(197, 158, 107, 0.2);
      border-color: rgba(197, 158, 107, 0.6);
      color: var(--text-main);
    }

    .person-content {
      display: none;
      animation: fadeIn 0.3s ease-in;
    }

    .person-content.active {
      display: block;
    }

    /* Goals Section */
    .goals-section {
      margin-bottom: 32px;
    }

    .goals-section-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(197, 158, 107, 0.3);
    }

    /* Goals List */
    .goals-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .goal-item {
      background: rgba(68, 68, 68, 0.2);
      border: 1px solid rgba(197, 158, 107, 0.2);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s ease;
    }

    .goal-item:hover {
      border-color: rgba(197, 158, 107, 0.4);
      background: rgba(68, 68, 68, 0.3);
    }

    .goal-text {
      font-size: 15px;
      color: var(--text-sub);
      line-height: 1.6;
    }

    /* Monthly Goals Container */
    .monthly-goals-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .monthly-goals-item {
      background: rgba(68, 68, 68, 0.2);
      border: 1px solid rgba(197, 158, 107, 0.2);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s ease;
    }

    .monthly-goals-item:hover {
      border-color: rgba(197, 158, 107, 0.4);
      background: rgba(68, 68, 68, 0.3);
    }

    .month-label {
      font-size: 16px;
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 12px;
    }

    .month-goals-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .month-goals-list .goal-item {
      padding: 12px;
      margin: 0;
    }

    /* Daily Records */
    .daily-records {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .daily-record-item {
      background: rgba(68, 68, 68, 0.2);
      border: 1px solid rgba(197, 158, 107, 0.2);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s ease;
    }

    .daily-record-item:hover {
      border-color: rgba(197, 158, 107, 0.4);
      background: rgba(68, 68, 68, 0.3);
    }

    .record-date {
      font-size: 14px;
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 8px;
    }

    .record-content {
      font-size: 14px;
      color: var(--text-sub);
      line-height: 1.8;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* Responsive Styles for Life Goals Page */
    @media (max-width: 768px) {
      .person-tabs {
        padding: 0;
        gap: 8px;
        margin-bottom: 20px;
      }

      .person-tab {
        padding: 8px 16px;
        font-size: 13px;
      }

      .goals-section-title {
        font-size: 18px;
      }

      .goal-item,
      .monthly-goals-item,
      .daily-record-item {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Tabs -->
  <div class="nav-container">
    <div class="nav-tabs">
      <button class="nav-tab active" data-page="games">遊戲</button>
      <button class="nav-tab" data-page="life-planning">行程安排</button>
      <a href="#" class="nav-logo" id="nav-logo" title="回到首頁">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
          <defs>
            <linearGradient id="nav-gold" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#facc15"/>
              <stop offset="50%" stop-color="#f5d76e"/>
              <stop offset="100%" stop-color="#facc15"/>
            </linearGradient>
          </defs>
          <path d="M35 30 C30 20 20 20 15 30 C15 40 25 50 35 70 C45 50 55 40 55 30 C50 20 40 20 35 30 Z" fill="url(#nav-gold)"/>
          <path d="M65 30 C60 20 50 20 45 30 C45 40 55 50 65 70 C75 50 85 40 85 30 C80 20 70 20 65 30 Z" fill="url(#nav-gold)"/>
          <path d="M50 50 C48 45 45 45 42 50 C42 55 46 60 50 65 C54 60 58 55 58 50 C55 45 52 45 50 50 Z" fill="#facc15" opacity="0.8"/>
        </svg>
      </a>
      <button class="nav-tab" data-page="hero-story">夢想清單</button>
      <button class="nav-tab" data-page="life-goals">人生目標</button>
    </div>
  </div>

  <!-- Page Container -->
  <div class="page-container">
    <!-- Games Page (Role Draw + Truth & Dare) -->
    <div class="page active" id="games-page">
      <div class="app">
        <!-- Game Tabs -->
        <div class="game-tabs">
          <button class="game-tab active" data-game="role-play">角色扮演遊戲</button>
          <button class="game-tab" data-game="truth-dare">真心話大冒險</button>
          <button class="game-tab" data-game="story-plots">故事劇情</button>
        </div>

        <!-- Role Play Game Content -->
        <div class="game-content active" id="role-play-content">
          <div class="app-header">
            <div class="app-title">角色抽籤</div>
            <div class="app-subtitle">抽出今天要扮演的身分與傾向，其餘自己設計劇本</div>
          </div>
          <div class="card-wrapper">
            <div class="card" id="card">
              <div class="card-title">TAP TO DRAW</div>
              <div class="card-main" id="card-main">？</div>
              <div class="card-hint" id="card-hint">點擊卡牌開始洗牌</div>
            </div>
            <div class="card" id="interaction-card">
              <div class="card-title">互動方式抽籤</div>
              <div class="card-main" id="interaction-card-main">？</div>
              <div class="card-hint" id="interaction-card-hint">點擊卡牌開始抽互動方式</div>
            </div>
          </div>
          <div class="history">
            <div class="history-title">歷史紀錄</div>
            <table class="history-table">
              <tbody id="history-list"></tbody>
            </table>
          </div>
        </div>

        <!-- Truth & Dare Game Content -->
        <div class="game-content" id="truth-dare-content">
          <div class="app-header">
            <div class="app-title">真心話大冒險</div>
            <div class="app-subtitle">點擊卡牌或按鈕開始抽卡</div>
          </div>
          <div class="card-wrapper">
            <div class="card" id="truth-dare-card">
              <div class="card-title">TAP TO DRAW</div>
              <div class="card-main" id="truth-dare-card-main">？</div>
              <div class="card-hint" id="truth-dare-card-hint">點擊卡牌或下方按鈕開始洗牌</div>
            </div>
          </div>
          <div class="controls">
            <button id="truth-dare-draw-btn">開始抽卡</button>
            <div class="result">抽到的卡片：</div>
            <div class="result-highlight" id="truth-dare-result">尚未抽籤</div>
          </div>
          <div class="history">
            <div class="history-title">歷史紀錄</div>
            <table class="history-table">
              <tbody id="truth-dare-history-list"></tbody>
            </table>
          </div>
        </div>

        <!-- Story Plots Game Content -->
        <div class="game-content" id="story-plots-content">
          <div class="app-header">
            <div class="app-title">STORY PLOTS</div>
            <div class="app-subtitle">點擊卡片查看完整劇情內容</div>
            <button class="story-plots-add-btn" id="story-plots-add-btn" title="新增故事">+ 新增故事</button>
          </div>
          <div class="story-grid" id="story-grid">
            <!-- Story cards will be generated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Story Plots Page (Legacy - now integrated into games page) -->
    <div class="page" id="story-plots-page" style="display: none;">
      <div class="app">
        <div class="app-header">
          <div class="app-title">STORY PLOTS</div>
          <div class="app-subtitle">點擊卡片查看完整劇情內容</div>
        </div>
        <div class="story-grid" id="story-grid-legacy">
          <!-- Story cards will be generated here -->
        </div>
      </div>
    </div>

    <!-- Life Planning Page -->
    <div class="page" id="life-planning-page">
      <div class="app">
        <div class="app-header">
          <div class="app-title">行程安排</div>
          <div class="app-subtitle">點擊日期新增或查看文章</div>
        </div>
        
        <!-- Calendar Header - Year and Month Selector -->
        <div class="calendar-header">
          <button class="calendar-nav-btn" id="prev-month-btn">‹</button>
          <div class="calendar-date-selector">
            <button class="date-selector-btn" id="year-selector-btn">
              <span id="current-year">2024</span>
            </button>
            <span class="date-separator">年</span>
            <button class="date-selector-btn" id="month-selector-btn">
              <span id="current-month">1</span>
            </button>
            <span class="date-separator">月</span>
          </div>
          <button class="calendar-nav-btn" id="next-month-btn">›</button>
        </div>

        <!-- Calendar Grid -->
        <div class="calendar-container">
          <div class="calendar-weekdays">
            <div class="weekday">日</div>
            <div class="weekday">一</div>
            <div class="weekday">二</div>
            <div class="weekday">三</div>
            <div class="weekday">四</div>
            <div class="weekday">五</div>
            <div class="weekday">六</div>
          </div>
          <div class="calendar-grid" id="calendar-grid">
            <!-- Calendar days will be generated here -->
          </div>
        </div>

        <!-- Articles List for Selected Date -->
        <div class="date-articles-container" id="date-articles-container" style="display: none;">
          <div class="date-articles-inner">
            <div class="date-articles-header">
              <h3 class="selected-date-title" id="selected-date-title"></h3>
              <button class="btn-close-articles" id="btn-close-articles">×</button>
            </div>
            
            <!-- Schedule Section -->
            <div class="schedule-section">
              <div class="schedule-header">
                <h4 class="schedule-title">時程安排</h4>
                <button class="btn-add-schedule" id="btn-add-schedule">+ 新增行程</button>
              </div>
              <div class="schedule-list" id="schedule-list">
                <!-- Schedule items will be generated here -->
              </div>
            </div>
            
            <!-- Articles Section -->
            <div class="articles-section">
              <div class="articles-section-header">
                <h4 class="articles-section-title">文章</h4>
              </div>
              <div class="date-articles-list" id="date-articles-list">
                <!-- Articles for selected date will be shown here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hero Story Page (Dream List) -->
    <div class="page" id="hero-story-page">
      <div class="app">
        <div class="app-header">
          <div class="app-title">夢想清單</div>
          <div class="app-subtitle">點擊卡片查看完整內容</div>
        </div>
        
        <!-- Person Tabs -->
        <div class="person-tabs">
          <button class="person-tab active" data-person="husband">老公</button>
          <button class="person-tab" data-person="wife">老婆</button>
        </div>

        <!-- Husband Dreams Content -->
        <div class="person-content active" id="husband-dreams-content">
          <div class="story-grid" id="husband-dream-grid">
            <!-- Husband dream cards will be generated here -->
          </div>
        </div>

        <!-- Wife Dreams Content -->
        <div class="person-content" id="wife-dreams-content">
          <div class="story-grid" id="wife-dream-grid">
            <!-- Wife dream cards will be generated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Life Goals Page (人生目標) -->
    <div class="page" id="life-goals-page">
      <div class="app">
        <div class="app-header">
          <div class="app-title">人生目標</div>
          <div class="app-subtitle">記錄與追蹤個人目標達成情況</div>
        </div>
        
        <!-- Person Tabs -->
        <div class="person-tabs">
          <button class="person-tab active" data-person="husband">老公</button>
          <button class="person-tab" data-person="wife">老婆</button>
        </div>

        <!-- Husband Content -->
        <div class="person-content active" id="husband-content">
          <!-- Yearly Goals -->
          <div class="goals-section">
            <h3 class="goals-section-title">今年目標</h3>
            <div class="goals-list" id="husband-yearly-goals">
              <div class="goal-item">
                <div class="goal-text">完成工作專案並獲得升遷機會</div>
              </div>
              <div class="goal-item">
                <div class="goal-text">每週至少運動三次，維持健康體態</div>
              </div>
              <div class="goal-item">
                <div class="goal-text">學習新技能，提升專業能力</div>
              </div>
              <div class="goal-item">
                <div class="goal-text">儲蓄目標：存下50萬元</div>
              </div>
            </div>
          </div>

          <!-- Monthly Goals -->
          <div class="goals-section">
            <h3 class="goals-section-title">每月目標</h3>
            <div class="monthly-goals-container" id="husband-monthly-goals">
              <div class="monthly-goals-item">
                <div class="month-label">一月</div>
                <div class="month-goals-list">
                  <div class="goal-item">完成工作報告</div>
                  <div class="goal-item">開始健身計劃</div>
                  <div class="goal-item">閱讀兩本書</div>
                </div>
              </div>
              <div class="monthly-goals-item">
                <div class="month-label">二月</div>
                <div class="month-goals-list">
                  <div class="goal-item">持續運動習慣</div>
                  <div class="goal-item">完成專案第一階段</div>
                  <div class="goal-item">學習新程式語言基礎</div>
                </div>
              </div>
              <div class="monthly-goals-item">
                <div class="month-label">三月</div>
                <div class="month-goals-list">
                  <div class="goal-item">參加專業培訓課程</div>
                  <div class="goal-item">開始投資理財規劃</div>
                  <div class="goal-item">完成專案第二階段</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Daily Records -->
          <div class="goals-section">
            <h3 class="goals-section-title">每日記錄</h3>
            <div class="daily-records" id="husband-daily-records">
              <div class="daily-record-item">
                <div class="record-date">2024年1月15日</div>
                <div class="record-content">今天完成了工作報告的第一部分，雖然遇到一些困難，但最終還是順利解決了。晚上去健身房運動了45分鐘，感覺身體狀態不錯。</div>
              </div>
              <div class="daily-record-item">
                <div class="record-date">2024年1月14日</div>
                <div class="record-content">閱讀了《深度工作》的前兩章，學到了很多關於專注力的技巧。工作上和同事討論了專案進度，制定了接下來一週的計劃。</div>
              </div>
              <div class="daily-record-item">
                <div class="record-date">2024年1月13日</div>
                <div class="record-content">今天開始了新的健身計劃，做了力量訓練和跑步。雖然有點累，但很有成就感。晚上開始學習新的程式語言，進度不錯。</div>
              </div>
              <div class="daily-record-item">
                <div class="record-date">2024年1月12日</div>
                <div class="record-content">完成了專案的第一階段測試，結果比預期好。中午和同事一起去健身房，互相督促的感覺很好。晚上繼續學習，感覺每天都在進步。</div>
              </div>
              <div class="daily-record-item">
                <div class="record-date">2024年1月11日</div>
                <div class="record-content">今天花了整個上午在圖書館看書，讀完了《原子習慣》。下午整理了工作資料，規劃了接下來一個月的目標。運動方面，今天做了瑜伽放鬆。</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Wife Content -->
        <div class="person-content" id="wife-content">
          <!-- Yearly Goals -->
          <div class="goals-section">
            <h3 class="goals-section-title">今年目標</h3>
            <div class="goals-list" id="wife-yearly-goals">
              <div class="goal-item">
                <div class="goal-text">提升工作效率，達到更好的工作生活平衡</div>
              </div>
              <div class="goal-item">
                <div class="goal-text">培養新的興趣愛好，豐富生活</div>
              </div>
              <div class="goal-item">
                <div class="goal-text">改善睡眠品質，建立規律作息</div>
              </div>
              <div class="goal-item">
                <div class="goal-text">學習理財知識，管理個人財務</div>
              </div>
            </div>
          </div>

          <!-- Monthly Goals -->
          <div class="goals-section">
            <h3 class="goals-section-title">每月目標</h3>
            <div class="monthly-goals-container" id="wife-monthly-goals">
              <div class="monthly-goals-item">
                <div class="month-label">一月</div>
                <div class="month-goals-list">
                  <div class="goal-item">建立規律作息時間表</div>
                  <div class="goal-item">開始學習新的興趣技能</div>
                  <div class="goal-item">完成工作專案規劃</div>
                </div>
              </div>
              <div class="monthly-goals-item">
                <div class="month-label">二月</div>
                <div class="month-goals-list">
                  <div class="goal-item">持續培養興趣愛好</div>
                  <div class="goal-item">改善飲食習慣</div>
                  <div class="goal-item">開始學習理財知識</div>
                </div>
              </div>
              <div class="monthly-goals-item">
                <div class="month-label">三月</div>
                <div class="month-goals-list">
                  <div class="goal-item">參加興趣相關的社群活動</div>
                  <div class="goal-item">建立理財預算計劃</div>
                  <div class="goal-item">優化工作流程</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Daily Records -->
          <div class="goals-section">
            <h3 class="goals-section-title">每日記錄</h3>
            <div class="daily-records" id="wife-daily-records">
              <div class="daily-record-item">
                <div class="record-date">2024年1月15日</div>
                <div class="record-content">今天開始學習水彩畫，雖然第一次嘗試，但感覺很有趣。工作上完成了一個重要的報告，得到了主管的肯定。晚上早早就休息了，睡眠品質有改善。</div>
              </div>
              <div class="daily-record-item">
                <div class="record-date">2024年1月14日</div>
                <div class="record-content">今天開始建立新的作息時間表，早上7點起床，晚上11點睡覺。中午學習了理財基礎知識，了解了投資的基本概念。下午完成了工作任務，效率不錯。</div>
              </div>
              <div class="daily-record-item">
                <div class="record-date">2024年1月13日</div>
                <div class="record-content">今天去參加了一個興趣社團的活動，認識了新朋友，很開心。工作上優化了工作流程，節省了不少時間。晚上做了瑜伽，身心都很放鬆。</div>
              </div>
              <div class="daily-record-item">
                <div class="record-date">2024年1月12日</div>
                <div class="record-content">今天開始學習新的興趣技能，選擇了攝影作為開始。看了很多教學影片，感覺很有收穫。工作上也完成了一些任務，整體來說是充實的一天。</div>
              </div>
              <div class="daily-record-item">
                <div class="record-date">2024年1月11日</div>
                <div class="record-content">今天開始改善飲食習慣，準備了營養均衡的餐點。學習了理財知識，制定了初步的預算計劃。工作上也很順利，完成了所有任務。感覺生活更有規律了。</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Story Detail Modal -->
  <div class="modal" id="story-modal">
    <div class="modal-content">
      <button class="modal-close" id="modal-close">&times;</button>
      <div class="modal-title" id="modal-title"></div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <!-- Edit/Add Story Modal -->
  <div class="modal" id="edit-story-modal">
    <div class="modal-content">
      <button class="modal-close" id="edit-modal-close">&times;</button>
      <div class="modal-title" id="edit-modal-title">新增故事</div>
      <div class="edit-form">
        <div class="form-group">
          <label for="edit-story-title">標題</label>
          <input type="text" id="edit-story-title" class="form-input" placeholder="輸入故事標題">
        </div>
        <div class="form-group">
          <label for="edit-story-preview">預覽文字</label>
          <textarea id="edit-story-preview" class="form-textarea" rows="2" placeholder="輸入預覽文字（會顯示在卡片上）"></textarea>
        </div>
        <div class="form-group">
          <label for="edit-story-content">完整內容</label>
          <textarea id="edit-story-content" class="form-textarea" rows="15" placeholder="輸入完整故事內容"></textarea>
        </div>
        <div class="form-actions">
          <button class="btn-cancel" id="btn-cancel">取消</button>
          <button class="btn-save" id="btn-save">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button for Add Story -->
  <button class="add-story-btn" id="floating-add-story-btn" title="新增故事">+</button>

  <!-- Dream Detail Modal -->
  <div class="modal" id="dream-modal">
    <div class="modal-content">
      <button class="modal-close" id="dream-modal-close">&times;</button>
      <div class="modal-title" id="dream-modal-title"></div>
      <div class="modal-body" id="dream-modal-body"></div>
    </div>
  </div>

  <!-- Edit/Add Dream Modal -->
  <div class="modal" id="edit-dream-modal">
    <div class="modal-content">
      <button class="modal-close" id="edit-dream-modal-close">&times;</button>
      <div class="modal-title" id="edit-dream-modal-title">新增夢想</div>
      <div class="edit-form">
        <div class="form-group">
          <label for="edit-dream-person">人物</label>
          <select id="edit-dream-person" class="form-input">
            <option value="husband">老公</option>
            <option value="wife">老婆</option>
          </select>
        </div>
        <div class="form-group">
          <label for="edit-dream-title">標題</label>
          <input type="text" id="edit-dream-title" class="form-input" placeholder="輸入夢想標題">
        </div>
        <div class="form-group">
          <label for="edit-dream-preview">預覽文字</label>
          <textarea id="edit-dream-preview" class="form-textarea" rows="2" placeholder="輸入預覽文字（會顯示在卡片上）"></textarea>
        </div>
        <div class="form-group">
          <label for="edit-dream-content">完整內容</label>
          <textarea id="edit-dream-content" class="form-textarea" rows="15" placeholder="輸入完整夢想內容"></textarea>
        </div>
        <div class="form-actions">
          <button class="btn-cancel" id="btn-dream-cancel">取消</button>
          <button class="btn-save" id="btn-dream-save">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit/Add Article Modal -->
  <div class="modal" id="edit-article-modal">
    <div class="modal-content">
      <button class="modal-close" id="edit-article-modal-close">&times;</button>
      <div class="modal-title" id="edit-article-modal-title">新增文章</div>
      <div class="edit-form">
        <div class="form-group">
          <label for="edit-article-title">標題</label>
          <input type="text" id="edit-article-title" class="form-input" placeholder="輸入文章標題">
        </div>
        <div class="form-group">
          <label for="edit-article-author">作者</label>
          <input type="text" id="edit-article-author" class="form-input" placeholder="輸入作者名稱">
        </div>
        <div class="form-group">
          <label for="edit-article-content">內容</label>
          <textarea id="edit-article-content" class="form-textarea" rows="15" placeholder="輸入文章內容"></textarea>
        </div>
        <div class="form-actions">
          <button class="btn-cancel" id="btn-article-cancel">取消</button>
          <button class="btn-save" id="btn-article-save">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Year/Month Selector Modal -->
  <div class="year-month-modal" id="year-month-modal">
    <div class="year-month-modal-content">
      <button class="year-month-modal-close" id="year-month-modal-close">&times;</button>
      <div class="year-month-modal-title" id="year-month-modal-title">選擇年份</div>
      <div class="year-month-grid" id="year-month-grid">
        <!-- Year/Month items will be generated here -->
      </div>
    </div>
  </div>

  <!-- Schedule Edit/Add Modal -->
  <div class="schedule-modal" id="schedule-modal">
    <div class="schedule-modal-content">
      <button class="schedule-modal-close" id="schedule-modal-close">&times;</button>
      <div class="schedule-modal-title" id="schedule-modal-title">新增行程</div>
      <div class="schedule-form">
        <div class="schedule-form-group">
          <label for="schedule-time">時間</label>
          <input type="time" id="schedule-time" class="schedule-form-input" required>
        </div>
        <div class="schedule-form-group">
          <label for="schedule-title">標題</label>
          <input type="text" id="schedule-title" class="schedule-form-input" placeholder="輸入行程標題" required>
        </div>
        <div class="schedule-form-group">
          <label for="schedule-description">描述</label>
          <textarea id="schedule-description" class="schedule-form-input" rows="4" placeholder="輸入行程描述（選填）"></textarea>
        </div>
        <div class="schedule-form-actions">
          <button class="schedule-btn-cancel" id="schedule-btn-cancel">取消</button>
          <button class="schedule-btn-save" id="schedule-btn-save">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize Supabase
    const SUPABASE_URL = 'https://olqgjmuadoohbkplvhhd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9scWdqbXVhZG9vaGJrcGx2aGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MDgxNDcsImV4cCI6MjA4MDQ4NDE0N30.QOVguUcqG_h7l-ZTE6U9qOT9DejGOr6pdnEMBoBqxbo';
    
    let supabase = null;
    try {
      if (window.supabase) {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase 连接成功');
      } else {
        console.error('Supabase 库未加载');
      }
    } catch (error) {
      console.error('Supabase 初始化失败:', error);
    }

    // Navigation System
    const navTabs = document.querySelectorAll('.nav-tab');
    const pages = document.querySelectorAll('.page');
    const navLogo = document.getElementById('nav-logo');

    const pageContainer = document.querySelector('.page-container');
    
    // Logo click handler - go to homepage (games page)
    if (navLogo) {
      navLogo.addEventListener('click', (e) => {
        e.preventDefault();
        // Find and click the games tab
        const gamesTab = document.querySelector('.nav-tab[data-page="games"]');
        if (gamesTab) {
          gamesTab.click();
        }
      });
    }
    
    // Initialize games-active class if games page is active on load
    const gamesPage = document.getElementById('games-page');
    if (gamesPage && gamesPage.classList.contains('active')) {
      pageContainer.classList.add('games-active');
    }
    
    navTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const targetPage = tab.getAttribute('data-page');
        
        // Update active tab
        navTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update active page
        pages.forEach(p => p.classList.remove('active'));
        document.getElementById(`${targetPage}-page`).classList.add('active');
        
        // Update page container for story-plots, life-planning, hero-story, life-goals pages (full width)
        if (targetPage === 'story-plots' || targetPage === 'life-planning' || targetPage === 'hero-story' || targetPage === 'life-goals') {
          pageContainer.classList.add('story-plots-active');
        } else {
          pageContainer.classList.remove('story-plots-active');
        }
        
        // Games page should align to top
        if (targetPage === 'games') {
          pageContainer.classList.add('games-active');
          pageContainer.classList.remove('story-plots-active');
        } else {
          pageContainer.classList.remove('games-active');
        }
        
        // Remove special padding handling for hero-story page (now uses same layout as story-plots)
        pageContainer.classList.remove('hero-story-active');
        
        // Initialize articles when switching to life-planning page
        if (targetPage === 'life-planning') {
          // Wait a bit for the page to be visible, then render calendar
          setTimeout(async () => {
            // Check if calendar grid exists
            const calendarGrid = document.getElementById('calendar-grid');
            if (calendarGrid) {
              // Load data and render
              await initArticles();
              // Force re-render to ensure events are bound
              renderCalendar();
            } else {
              console.error('Calendar grid not found when switching to life-planning page');
              // Try again after longer delay
              setTimeout(async () => {
                await initArticles();
                renderCalendar();
              }, 200);
            }
          }, 100);
        }
        
        // Initialize games when switching to games page
        if (targetPage === 'games') {
          // Initialize Truth & Dare game
          setTimeout(() => {
            initTruthDareGame();
          }, 100);
          
          // Check if story-plots tab is active
          const storyPlotsTab = document.querySelector('.game-tab[data-game="story-plots"]');
          if (storyPlotsTab && storyPlotsTab.classList.contains('active')) {
            setTimeout(async () => {
              stories = await loadStories();
              renderStories();
            }, 100);
          }
        }
        
        // Hide floating add story button (now using inline button in story plots)
        const floatingBtn = document.getElementById('floating-add-story-btn');
        if (floatingBtn) {
          floatingBtn.style.display = 'none';
        }
        
        // Initialize dreams when switching to hero-story page
        if (targetPage === 'hero-story') {
          setTimeout(async () => {
            await initDreams();
          }, 100);
        }
      });
    });

    // Game Tab Switching
    document.querySelectorAll('.game-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const gameType = tab.getAttribute('data-game');
        
        // Update tab active state
        document.querySelectorAll('.game-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update content visibility
        document.querySelectorAll('.game-content').forEach(content => {
          content.classList.remove('active');
        });
        
        if (gameType === 'role-play') {
          document.getElementById('role-play-content').classList.add('active');
        } else if (gameType === 'truth-dare') {
          document.getElementById('truth-dare-content').classList.add('active');
          // Initialize Truth & Dare game when switching to it
          setTimeout(() => {
            initTruthDareGame();
          }, 100);
        } else if (gameType === 'story-plots') {
          document.getElementById('story-plots-content').classList.add('active');
          // Initialize stories when switching to story plots
          setTimeout(async () => {
            stories = await loadStories();
            renderStories();
          }, 100);
          
          // Button is now inline in the header, no need to show floating button
        } else {
          // Hide floating add button when switching away from story plots
          const floatingBtn = document.getElementById('floating-add-story-btn');
          if (floatingBtn) {
            floatingBtn.style.display = 'none';
          }
        }
      });
    });

    // Person Tab Switching (for Life Goals Page and Hero Story Page)
    document.querySelectorAll('.person-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const personType = tab.getAttribute('data-person');
        const heroStoryPage = document.getElementById('hero-story-page');
        const lifeGoalsPage = document.getElementById('life-goals-page');
        const isHeroStoryActive = heroStoryPage && heroStoryPage.classList.contains('active');
        
        // Update tab active state - only for tabs in the same page
        const pageTabs = isHeroStoryActive 
          ? heroStoryPage.querySelectorAll('.person-tab')
          : lifeGoalsPage ? lifeGoalsPage.querySelectorAll('.person-tab') : [];
        
        pageTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        if (isHeroStoryActive) {
          // Hero Story Page (Dreams) Tab Switching
          currentDreamPerson = personType;
          
          // Update content visibility
          const husbandContent = document.getElementById('husband-dreams-content');
          const wifeContent = document.getElementById('wife-dreams-content');
          
          if (husbandContent) husbandContent.classList.remove('active');
          if (wifeContent) wifeContent.classList.remove('active');
          
          if (personType === 'husband' && husbandContent) {
            husbandContent.classList.add('active');
          } else if (personType === 'wife' && wifeContent) {
            wifeContent.classList.add('active');
          }
        } else {
          // Life Goals Page Tab Switching
          document.querySelectorAll('.person-content').forEach(content => {
            content.classList.remove('active');
          });
          
          if (personType === 'husband') {
            document.getElementById('husband-content').classList.add('active');
          } else if (personType === 'wife') {
            document.getElementById('wife-content').classList.add('active');
          }
        }
      });
    });

    // Role Draw System
    const jobs = [
     "餐廳服務生", "性高潮專家", "泌尿/婦產科醫生", "心理諮商師",
      "造型師",   "服飾店員", "模特兒",
      "SM 調教專家", "房仲業務", "情趣用品業務", "清潔人員",
      "情趣用品店老闆", "鄰居", "秘書", "情趣用品開發專員", "空服員", "性愛按摩師",
      "小學生", "國中生", "高中生", "大學生",
      "幼教老師", "小學老師", "國中老師", "高中老師", "大學教授", "補習班老師", "家教", "健身教練",
      "演員", "攝影師", "導演",
      "行銷人員", "客服", "人資", "行政助理", 
      "超商店員", "精品專櫃店員", 
      "飯店櫃檯", "導遊", 
      "社工",
      "醫生", "護士", "性成癮治療師"
    ];

    const roles = ["S", "M"];
    const attitudes = [
      "冷靜理性",
      "衝動火爆",
      "樂觀",
      "無所謂",
      "煩躁",
      "憤世紀俗",
      "厭惡",
      "自我中心"
    ];
    
    // 職業專屬場景映射
    const jobScenes = {
      "導遊": ["戶外公園", "商店", "遊覽車上", "餐廳", "旅館", "觀光景點", "海邊", "山區", "博物館", "紀念品店"],
      "心理諮商師": ["醫院診間", "醫院廁所", "諮商室", "醫院休息室"],
      "社工": ["客廳", "書房", "臥室", "廁所", "公車", "捷運", "公園", "餐廳", "咖啡廳", "辦公室", "社區中心"],
      "餐廳服務生": ["餐廳", "廚房", "儲藏室", "員工休息室", "餐廳廁所", "包廂"],
      "性高潮專家": ["臥室", "客廳", "浴室", "按摩室", "私人工作室", "飯店房間"],
      "泌尿/婦產科醫生": ["醫院診間", "檢查室", "手術室", "醫院廁所", "醫生休息室"],
      "造型師": ["髮廊", "化妝間", "更衣室", "工作室", "攝影棚"],
      "服飾店員": ["服飾店", "試衣間", "倉庫", "員工休息室"],
      "模特兒": ["攝影棚", "更衣室", "化妝間", "伸展台", "外拍現場", "飯店房間"],
      "SM 調教專家": ["私人工作室", "地下室", "專用房間", "飯店房間", "私人會所"],
      "房仲業務": ["樣品屋", "空屋", "辦公室", "車上", "咖啡廳", "客戶家中"],
      "情趣用品業務": ["辦公室", "展示間", "倉庫", "客戶家中", "車上"],
      "清潔人員": ["辦公室", "廁所", "儲藏室", "飯店房間", "更衣室", "地下室"],
      "情趣用品店老闆": ["店內", "倉庫", "辦公室", "試用間"],
      "鄰居": ["家中客廳", "家中臥室", "家中浴室", "樓梯間", "電梯", "陽台", "頂樓"],
      "秘書": ["辦公室", "會議室", "茶水間", "電梯", "停車場", "車上"],
      "情趣用品開發專員": ["實驗室", "辦公室", "測試間", "會議室"],
      "空服員": ["飛機上", "機艙", "休息室", "飯店房間", "機場貴賓室"],
      "性愛按摩師": ["按摩室", "SPA室", "私人工作室", "飯店房間"],
      "小學生": ["教室", "操場", "廁所", "圖書館", "音樂教室", "體育館", "保健室"],
      "國中生": ["教室", "廁所", "圖書館", "體育館", "音樂教室", "頂樓", "樓梯間"],
      "高中生": ["教室", "廁所", "圖書館", "體育館", "音樂教室", "頂樓", "樓梯間", "車上"],
      "大學生": ["教室", "圖書館", "宿舍", "廁所", "實驗室", "社團辦公室", "車上", "租屋處"],
      "幼教老師": ["教室", "遊戲室", "廁所", "辦公室", "保健室"],
      "小學老師": ["教室", "辦公室", "圖書館", "體育館", "廁所"],
      "國中老師": ["教室", "辦公室", "圖書館", "實驗室", "廁所"],
      "高中老師": ["教室", "辦公室", "圖書館", "實驗室", "廁所", "車上"],
      "大學教授": ["教室", "辦公室", "研究室", "圖書館", "實驗室", "會議室"],
      "補習班老師": ["教室", "辦公室", "廁所", "儲藏室"],
      "家教": ["學生家中", "書房", "臥室", "客廳", "咖啡廳"],
      "健身教練": ["健身房", "更衣室", "淋浴間", "辦公室", "私人訓練室"],
      "演員": ["攝影棚", "更衣室", "化妝間", "休息室", "飯店房間", "車上"],
      "攝影師": ["攝影棚", "外拍現場", "工作室", "更衣室", "車上"],
      "導演": ["攝影棚", "辦公室", "休息室", "飯店房間", "車上"],
      "行銷人員": ["辦公室", "會議室", "咖啡廳", "客戶公司", "車上"],
      "客服": ["辦公室", "客服中心", "休息室", "廁所"],
      "人資": ["辦公室", "會議室", "面試室", "休息室"],
      "行政助理": ["辦公室", "茶水間", "儲藏室", "會議室", "廁所"],
      "超商店員": ["便利商店", "倉庫", "員工休息室", "廁所"],
      "精品專櫃店員": ["專櫃", "試衣間", "倉庫", "員工休息室"],
      "飯店櫃檯": ["櫃檯", "辦公室", "休息室", "飯店房間", "儲藏室"],
      "醫生": ["醫院診間", "檢查室", "手術室", "醫生休息室", "醫院廁所"],
      "護士": ["醫院診間", "護理站", "休息室", "醫院廁所", "更衣室", "值班室"],
      "性成癮治療師": ["治療室", "諮商室", "醫院診間", "休息室"]
    };

    // 場景中文到韓文翻譯映射
    const sceneTranslations = {
      "戶外公園": { ko: "야외공원", koRoman: "yaoe gongwon" },
      "商店": { ko: "상점", koRoman: "sangjeom" },
      "遊覽車上": { ko: "관광버스", koRoman: "gwangwang beoseu" },
      "餐廳": { ko: "식당", koRoman: "sikdang" },
      "旅館": { ko: "여관", koRoman: "yeogwan" },
      "觀光景點": { ko: "관광지", koRoman: "gwangwangji" },
      "海邊": { ko: "해변", koRoman: "haebyeon" },
      "山區": { ko: "산지", koRoman: "sanji" },
      "博物館": { ko: "박물관", koRoman: "bangmulgwan" },
      "紀念品店": { ko: "기념품점", koRoman: "ginyeom pumjeom" },
      "醫院診間": { ko: "병원진찰실", koRoman: "byeongwon jinchalsil" },
      "醫院廁所": { ko: "병원화장실", koRoman: "byeongwon hwajangsil" },
      "諮商室": { ko: "상담실", koRoman: "sangdamsil" },
      "醫院休息室": { ko: "병원휴게실", koRoman: "byeongwon hyugesil" },
      "客廳": { ko: "거실", koRoman: "geosil" },
      "書房": { ko: "서재", koRoman: "seojae" },
      "臥室": { ko: "침실", koRoman: "chimsil" },
      "廁所": { ko: "화장실", koRoman: "hwajangsil" },
      "公車": { ko: "버스", koRoman: "beoseu" },
      "捷運": { ko: "지하철", koRoman: "jihacheol" },
      "公園": { ko: "공원", koRoman: "gongwon" },
      "咖啡廳": { ko: "카페", koRoman: "kape" },
      "辦公室": { ko: "사무실", koRoman: "samusil" },
      "社區中心": { ko: "커뮤니티센터", koRoman: "keomyuniti senteo" },
      "廚房": { ko: "부엌", koRoman: "bueok" },
      "儲藏室": { ko: "창고", koRoman: "changgo" },
      "員工休息室": { ko: "직원휴게실", koRoman: "jigwon hyugesil" },
      "餐廳廁所": { ko: "식당화장실", koRoman: "sikdang hwajangsil" },
      "包廂": { ko: "개인실", koRoman: "gaeinsil" },
      "浴室": { ko: "욕실", koRoman: "yoksil" },
      "按摩室": { ko: "마사지실", koRoman: "masajisil" },
      "私人工作室": { ko: "사무실", koRoman: "sagongjangsil" },
      "飯店房間": { ko: "호텔방", koRoman: "hotel bang" },
      "檢查室": { ko: "검사실", koRoman: "geomsasil" },
      "手術室": { ko: "수술실", koRoman: "susulsil" },
      "醫生休息室": { ko: "의사휴게실", koRoman: "uisa hyugesil" },
      "髮廊": { ko: "미용실", koRoman: "miyongsil" },
      "化妝間": { ko: "화장실", koRoman: "hwajangsil" },
      "更衣室": { ko: "탈의실", koRoman: "taruisil" },
      "工作室": { ko: "작업실", koRoman: "jageopsil" },
      "攝影棚": { ko: "촬영장", koRoman: "chwaryeongjang" },
      "服飾店": { ko: "의류점", koRoman: "uiryujeom" },
      "試衣間": { ko: "탈의실", koRoman: "taruisil" },
      "倉庫": { ko: "창고", koRoman: "changgo" },
      "伸展台": { ko: "런웨이", koRoman: "reon wei" },
      "外拍現場": { ko: "야외촬영장", koRoman: "yaoe chwaryeongjang" },
      "地下室": { ko: "지하실", koRoman: "jihasil" },
      "專用房間": { ko: "전용방", koRoman: "jeonyong bang" },
      "私人會所": { ko: "프라이빗클럽", koRoman: "peuraibit keulleop" },
      "樣品屋": { ko: "모델하우스", koRoman: "model hauseu" },
      "空屋": { ko: "빈집", koRoman: "binjip" },
      "車上": { ko: "차안", koRoman: "chaan" },
      "客戶家中": { ko: "고객집", koRoman: "gogaek jip" },
      "展示間": { ko: "전시실", koRoman: "jeonsisil" },
      "店內": { ko: "매장", koRoman: "maejang" },
      "試用間": { ko: "체험실", koRoman: "cheheomsil" },
      "家中客廳": { ko: "집거실", koRoman: "jip geosil" },
      "家中臥室": { ko: "집침실", koRoman: "jip chimsil" },
      "家中浴室": { ko: "집욕실", koRoman: "jip yoksil" },
      "樓梯間": { ko: "계단실", koRoman: "gyedansil" },
      "電梯": { ko: "엘리베이터", koRoman: "ellibeiteo" },
      "陽台": { ko: "발코니", koRoman: "balkoni" },
      "頂樓": { ko: "옥상", koRoman: "oksang" },
      "會議室": { ko: "회의실", koRoman: "hoeuuisil" },
      "茶水間": { ko: "다방", koRoman: "dabang" },
      "停車場": { ko: "주차장", koRoman: "juchajang" },
      "實驗室": { ko: "실험실", koRoman: "silheomsil" },
      "測試間": { ko: "테스트룸", koRoman: "teseuteu rum" },
      "飛機上": { ko: "비행기안", koRoman: "bihaenggi an" },
      "機艙": { ko: "기내", koRoman: "ginae" },
      "休息室": { ko: "휴게실", koRoman: "hyugesil" },
      "機場貴賓室": { ko: "공항라운지", koRoman: "gonghang raunji" },
      "SPA室": { ko: "스파실", koRoman: "seupa sil" },
      "教室": { ko: "교실", koRoman: "gyosil" },
      "操場": { ko: "운동장", koRoman: "undongjang" },
      "圖書館": { ko: "도서관", koRoman: "doseogwan" },
      "音樂教室": { ko: "음악실", koRoman: "eumaksil" },
      "體育館": { ko: "체육관", koRoman: "cheyukgwan" },
      "保健室": { ko: "보건실", koRoman: "bogeonsil" },
      "宿舍": { ko: "기숙사", koRoman: "gisuksa" },
      "社團辦公室": { ko: "동아리방", koRoman: "dongari bang" },
      "租屋處": { ko: "하숙집", koRoman: "hasuk jip" },
      "遊戲室": { ko: "놀이방", koRoman: "nori bang" },
      "研究室": { ko: "연구실", koRoman: "yeongusil" },
      "學生家中": { ko: "학생집", koRoman: "haksaeng jip" },
      "健身房": { ko: "헬스장", koRoman: "helseu jang" },
      "淋浴間": { ko: "샤워실", koRoman: "syawo sil" },
      "私人訓練室": { ko: "개인트레이닝실", koRoman: "gaein teureining sil" },
      "客戶公司": { ko: "고객사", koRoman: "gogaek sa" },
      "客服中心": { ko: "고객센터", koRoman: "gogaek senteo" },
      "面試室": { ko: "면접실", koRoman: "myeonjeopsil" },
      "便利商店": { ko: "편의점", koRoman: "pyeonuijeom" },
      "專櫃": { ko: "매장", koRoman: "maejang" },
      "櫃檯": { ko: "카운터", koRoman: "kaunteo" },
      "護理站": { ko: "간호실", koRoman: "ganho sil" },
      "值班室": { ko: "당직실", koRoman: "dangjiksil" },
      "治療室": { ko: "치료실", koRoman: "chiryosil" },
      "家中": { ko: "집", koRoman: "jip" },
      "戶外": { ko: "야외", koRoman: "yaoe" },
      "公共場所": { ko: "공공장소", koRoman: "gonggong jangso" }
    };
    
    // 獲取場景的韓文翻譯
    function getSceneKorean(scene) {
      const translation = sceneTranslations[scene];
      if (translation) {
        return translation;
      }
      // 如果沒有找到翻譯，返回默認值
      return { ko: scene, koRoman: "" };
    }
    
    // 互動方式卡牌組
    const interactionModes = [
      "S對M有不合理的要求，M必須表現反抗但是身體順從",
      "S對M直接言語或是肢體性騷擾，M不能有任何反應",
      "S要浪漫的挑逗M，M要好好扮演好角色",
      "S跟M互相偷吃的劇情",
      "S強暴M的劇情",
      "S用權力壓迫M，M必須服從但內心抗拒",
      "S和M是陌生人，S強制對M進行性行為",
      "S是M的上司，利用職權對M進行性騷擾",
      "S和M是敵對關係，S用暴力征服M",
      "S是M的債主，M用身體償還債務"
    ];

    const card = document.getElementById("card");
    const cardMain = document.getElementById("card-main");
    const cardHint = document.getElementById("card-hint");
    const historyList = document.getElementById("history-list");
    
    const interactionCard = document.getElementById("interaction-card");
    const interactionCardMain = document.getElementById("interaction-card-main");
    const interactionCardHint = document.getElementById("interaction-card-hint");
    
    let isDrawing = false;
    let isDrawingInteraction = false;
    let currentJob = null;
    let currentRole = null;
    let currentAttitude = null;
    let currentScene = null;
    let currentInteraction = null;
    let hasDrawnRole = false;
    let hasDrawnScene = false;
    let hasDrawnInteraction = false;

    function randomSM() {
      return roles[Math.floor(Math.random() * roles.length)];
    }

    function randomAttitude() {
      return attitudes[Math.floor(Math.random() * attitudes.length)];
    }

      function drawCard() {
      if (isDrawing) return;
      isDrawing = true;
      card.classList.add("shuffling");
      cardMain.innerHTML = "…";
      cardHint.textContent = "洗牌中";

      const shuffleDuration = 900;
      const intervalTime = 90;
      let elapsed = 0;

      const shuffleTimer = setInterval(() => {
        const randomJob = jobs[Math.floor(Math.random() * jobs.length)];
        const tempRole = randomSM();
        const tempAttitude = randomAttitude();
        cardMain.innerHTML = `${randomJob}（${tempRole}）<div class="card-role-info"><span class="card-attitude">${tempAttitude}</span></div>`;
        elapsed += intervalTime;

        if (elapsed >= shuffleDuration) {
          clearInterval(shuffleTimer);
          const chosenJob = jobs[Math.floor(Math.random() * jobs.length)];
          const chosenRole = randomSM();
          const chosenAttitude = randomAttitude();
          
          // 保存抽到的角色信息
          currentJob = chosenJob;
          currentRole = chosenRole;
          currentAttitude = chosenAttitude;
          currentScene = null;
          hasDrawnRole = true;
          hasDrawnScene = false;
          
          const displayText = `${chosenJob}（${chosenRole}）`;

          setTimeout(() => {
            card.classList.remove("shuffling");
            cardMain.innerHTML = `${displayText}<div class="card-role-info"><span class="card-attitude">${chosenAttitude}</span></div>`;
            cardHint.textContent = "角色已抽出，點擊抽場景";
            isDrawing = false;
          }, 130);
        }
      }, intervalTime);
    }
    
    function drawScene() {
      if (isDrawing || !hasDrawnRole || !currentJob) return;
      
      // 檢查該職業是否有專屬場景，如果沒有則使用通用場景
      const availableScenes = jobScenes[currentJob] || ["辦公室", "家中", "戶外", "車上", "公共場所"];
      
      isDrawing = true;
      card.classList.add("shuffling");
      cardHint.textContent = "抽場景中";

      const shuffleDuration = 600;
      const intervalTime = 80;
      let elapsed = 0;

      const shuffleTimer = setInterval(() => {
        const randomScene = availableScenes[Math.floor(Math.random() * availableScenes.length)];
        const displayText = `${currentJob}（${currentRole}）`;
        cardMain.innerHTML = `${displayText}<div class="card-role-info"><span class="card-attitude">${currentAttitude}</span><span class="card-scene">${randomScene}</span></div>`;
        elapsed += intervalTime;

        if (elapsed >= shuffleDuration) {
          clearInterval(shuffleTimer);
          const chosenScene = availableScenes[Math.floor(Math.random() * availableScenes.length)];
          currentScene = chosenScene;
          hasDrawnScene = true;
          
          const displayText = `${currentJob}（${currentRole}）`;

          setTimeout(() => {
            card.classList.remove("shuffling");
            cardMain.innerHTML = `${displayText}<div class="card-role-info"><span class="card-attitude">${currentAttitude}</span><span class="card-scene">${chosenScene}</span></div>`;
            cardHint.textContent = "完整角色已抽出";
            
            // 記錄到歷史 - 使用簡單的表格格式（包含互動方式）
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            let historyText = `${displayText} - <span class="result-attitude">${currentAttitude}</span> - <span class="result-scene">${chosenScene}</span>`;
            if (currentInteraction) {
              historyText += ` - <span class="history-interaction-label">互動方式：</span><span class="history-interaction-value">${currentInteraction}</span>`;
            }
            td.innerHTML = historyText;
            tr.appendChild(td);
            historyList.prepend(tr);
            
            isDrawing = false;
            
            // 重置狀態（可選：如果需要重新開始）
            // hasDrawnRole = false;
            // hasDrawnScene = false;
          }, 130);
        }
      }, intervalTime);
    }
    
    function handleDrawClick() {
      if (!hasDrawnRole) {
        drawCard();
      } else if (hasDrawnRole && !hasDrawnScene) {
        drawScene();
      } else {
        // 重新開始
        currentJob = null;
        currentRole = null;
        currentAttitude = null;
        currentScene = null;
        currentInteraction = null;
        hasDrawnRole = false;
        hasDrawnScene = false;
        hasDrawnInteraction = false;
        cardMain.innerHTML = "？";
        cardHint.textContent = "點擊卡牌或下方按鈕開始洗牌";
        interactionCardMain.innerHTML = "？";
        interactionCardHint.textContent = "點擊卡牌開始抽互動方式";
        drawCard();
      }
    }

    // 互動方式抽籤函數
    function drawInteraction() {
      if (isDrawingInteraction) return;
      isDrawingInteraction = true;
      interactionCard.classList.add("shuffling");
      interactionCardMain.innerHTML = "…";
      interactionCardHint.textContent = "抽互動方式中";

      const shuffleDuration = 900;
      const intervalTime = 90;
      let elapsed = 0;

      const shuffleTimer = setInterval(() => {
        const randomInteraction = interactionModes[Math.floor(Math.random() * interactionModes.length)];
        interactionCardMain.innerHTML = randomInteraction;
        elapsed += intervalTime;

        if (elapsed >= shuffleDuration) {
          clearInterval(shuffleTimer);
          const chosenInteraction = interactionModes[Math.floor(Math.random() * interactionModes.length)];
          currentInteraction = chosenInteraction;
          hasDrawnInteraction = true;

          setTimeout(() => {
            interactionCard.classList.remove("shuffling");
            interactionCardMain.innerHTML = chosenInteraction;
            interactionCardHint.textContent = "互動方式已抽出";
            
            
            isDrawingInteraction = false;
          }, 130);
        }
      }, intervalTime);
    }

    card.addEventListener("click", () => {
      if (!hasDrawnRole) {
        drawCard();
      } else if (hasDrawnRole && !hasDrawnScene) {
        drawScene();
      } else {
        // 重新開始
        currentJob = null;
        currentRole = null;
        currentAttitude = null;
        currentScene = null;
        currentInteraction = null;
        hasDrawnRole = false;
        hasDrawnScene = false;
        hasDrawnInteraction = false;
        cardMain.innerHTML = "？";
        cardHint.textContent = "點擊卡牌開始洗牌";
        interactionCardMain.innerHTML = "？";
        interactionCardHint.textContent = "點擊卡牌開始抽互動方式";
        drawCard();
      }
    });
    
    if (interactionCard) {
      interactionCard.addEventListener("click", drawInteraction);
    }

    // Story Plots System
    // Stories array - will be loaded from Supabase
    let stories = [];

    // Supabase CRUD Functions
    async function loadStories() {
      if (!supabase) {
        console.warn('Supabase 未初始化，返回空数组');
        return [];
      }
      
      try {
        const { data, error } = await supabase
          .from('stories')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('加载故事失败:', error);
          // Don't show error alert, just log it
          return [];
        }
        return data || [];
      } catch (error) {
        console.error('加载故事异常:', error);
        return [];
      }
    }

    async function addStory(title, preview, content) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法新增故事');
        return null;
      }
      
      try {
        const { data, error } = await supabase
          .from('stories')
          .insert([
            { title, preview, content }
          ])
          .select();
        
        if (error) {
          console.error('新增故事失败:', error);
          console.error('錯誤詳情:', JSON.stringify(error, null, 2));
          return null;
        }
        return data[0];
      } catch (error) {
        console.error('新增故事异常:', error);
        return null;
      }
    }

    async function updateStory(id, title, preview, content) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法更新故事');
        return null;
      }
      
      try {
        const { data, error } = await supabase
          .from('stories')
          .update({ 
            title, 
            preview, 
            content, 
            updated_at: new Date().toISOString() 
          })
          .eq('id', id)
          .select();
        
        if (error) {
          console.error('更新故事失败:', error);
          console.error('錯誤詳情:', JSON.stringify(error, null, 2));
          return null;
        }
        return data[0];
      } catch (error) {
        console.error('更新故事异常:', error);
        return null;
      }
    }

    async function deleteStory(id) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法删除故事');
        return false;
      }
      
      try {
        const { error } = await supabase
          .from('stories')
          .delete()
          .eq('id', id);
        
        if (error) {
          console.error('删除故事失败:', error);
          return false;
        }
        return true;
      } catch (error) {
        console.error('删除故事异常:', error);
        return false;
      }
    }

    function showError(message) {
      alert('错误: ' + message);
      // 可以替换为更美观的提示组件
    }

    // Life Planning Articles CRUD Functions
    let articles = [];
    
    // Schedules CRUD Functions
    let schedules = [];

    async function loadArticles() {
      if (!supabase) {
        console.warn('Supabase 未初始化，返回空数组');
        return [];
      }
      
      try {
        const { data, error } = await supabase
          .from('life_planning_articles')
          .select('*')
          .order('updated_at', { ascending: false });
        
        if (error) {
          console.error('加载文章失败:', error);
          return [];
        }
        return data || [];
      } catch (error) {
        console.error('加载文章异常:', error);
        return [];
      }
    }

    async function addArticle(title, author, content, date) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法新增文章');
        return null;
      }
      
      try {
        // Convert date string (YYYY-MM-DD) to ISO string
        const dateISO = date ? new Date(date + 'T00:00:00').toISOString() : new Date().toISOString();
        
        const { data, error } = await supabase
          .from('life_planning_articles')
          .insert([
            { title, author, content, date: dateISO }
          ])
          .select();
        
        if (error) {
          console.error('新增文章失败:', error);
          return null;
        }
        return data[0];
      } catch (error) {
        console.error('新增文章异常:', error);
        return null;
      }
    }

    async function updateArticle(id, title, author, content, date) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法更新文章');
        return null;
      }
      
      try {
        // Convert date string (YYYY-MM-DD) to ISO string
        const dateISO = date ? new Date(date + 'T00:00:00').toISOString() : new Date().toISOString();
        
        const { data, error } = await supabase
          .from('life_planning_articles')
          .update({ 
            title, 
            author,
            content,
            date: dateISO,
            updated_at: new Date().toISOString() 
          })
          .eq('id', id)
          .select();
        
        if (error) {
          console.error('更新文章失败:', error);
          return null;
        }
        return data[0];
      } catch (error) {
        console.error('更新文章异常:', error);
        return null;
      }
    }

    async function deleteArticle(id) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法删除文章');
        return false;
      }
      
      try {
        const { error } = await supabase
          .from('life_planning_articles')
          .delete()
          .eq('id', id);
        
        if (error) {
          console.error('删除文章失败:', error);
          return false;
        }
        return true;
      } catch (error) {
        console.error('删除文章异常:', error);
        return false;
      }
    }

    function formatDateTime(dateString) {
      if (!dateString) return '未知';
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    // Schedules CRUD Functions
    async function loadSchedules() {
      if (!supabase) {
        console.warn('Supabase 未初始化，返回空数组');
        return [];
      }
      
      try {
        const { data, error } = await supabase
          .from('life_planning_schedules')
          .select('*')
          .order('time', { ascending: true });
        
        if (error) {
          console.error('加载时程安排失败:', error);
          return [];
        }
        return data || [];
      } catch (error) {
        console.error('加载时程安排异常:', error);
        return [];
      }
    }

    async function addSchedule(date, time, title, description) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法新增时程安排');
        return null;
      }
      
      try {
        // Convert date string (YYYY-MM-DD) to ISO string
        const dateISO = date ? new Date(date + 'T00:00:00').toISOString() : new Date().toISOString();
        
        const { data, error } = await supabase
          .from('life_planning_schedules')
          .insert([
            { date: dateISO, time, title, description: description || '' }
          ])
          .select();
        
        if (error) {
          console.error('新增时程安排失败:', error);
          return null;
        }
        return data[0];
      } catch (error) {
        console.error('新增时程安排异常:', error);
        return null;
      }
    }

    async function updateSchedule(id, date, time, title, description) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法更新时程安排');
        return null;
      }
      
      try {
        // Convert date string (YYYY-MM-DD) to ISO string
        const dateISO = date ? new Date(date + 'T00:00:00').toISOString() : new Date().toISOString();
        
        const { data, error } = await supabase
          .from('life_planning_schedules')
          .update({ 
            date: dateISO,
            time,
            title,
            description: description || '',
            updated_at: new Date().toISOString() 
          })
          .eq('id', id)
          .select();
        
        if (error) {
          console.error('更新时程安排失败:', error);
          return null;
        }
        return data[0];
      } catch (error) {
        console.error('更新时程安排异常:', error);
        return null;
      }
    }

    async function deleteSchedule(id) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法删除时程安排');
        return false;
      }
      
      try {
        const { error } = await supabase
          .from('life_planning_schedules')
          .delete()
          .eq('id', id);
        
        if (error) {
          console.error('删除时程安排失败:', error);
          return false;
        }
        return true;
      } catch (error) {
        console.error('删除时程安排异常:', error);
        return false;
      }
    }

    // Calendar state
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1; // 1-12
    let selectedDate = null;

    // Calendar functions
    function renderCalendar() {
      const calendarGrid = document.getElementById('calendar-grid');
      if (!calendarGrid) {
        console.warn('Calendar grid not found, calendar may not be visible yet');
        // Try again after a short delay
        setTimeout(() => {
          const retryGrid = document.getElementById('calendar-grid');
          if (retryGrid) {
            console.log('Retrying calendar render...');
            renderCalendar();
          }
        }, 100);
        return;
      }
      
      console.log('Rendering calendar for', currentYear, '年', currentMonth, '月');
      
      calendarGrid.innerHTML = '';
      
      // Update header
      document.getElementById('current-year').textContent = currentYear;
      document.getElementById('current-month').textContent = currentMonth;
      
      // Get first day of month and number of days
      const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
      const daysInPrevMonth = new Date(currentYear, currentMonth - 1, 0).getDate();
      
      // Get today's date
      const today = new Date();
      const isCurrentMonth = today.getFullYear() === currentYear && today.getMonth() + 1 === currentMonth;
      const todayDate = today.getDate();
      
      // Group articles by date
      const articlesByDate = {};
      articles.forEach(article => {
        const articleDate = new Date(article.date || article.created_at);
        const dateKey = `${articleDate.getFullYear()}-${String(articleDate.getMonth() + 1).padStart(2, '0')}-${String(articleDate.getDate()).padStart(2, '0')}`;
        if (!articlesByDate[dateKey]) {
          articlesByDate[dateKey] = [];
        }
        articlesByDate[dateKey].push(article);
      });
      
      // Previous month days
      for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        const dayElement = createCalendarDay(day, true, null, currentYear, currentMonth - 1);
        calendarGrid.appendChild(dayElement);
      }
      
      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayArticles = articlesByDate[dateKey] || [];
        const isToday = isCurrentMonth && day === todayDate;
        const dayElement = createCalendarDay(day, false, dayArticles, currentYear, currentMonth);
        if (isToday) {
          dayElement.classList.add('today');
        }
        if (dayArticles.length > 0) {
          dayElement.classList.add('has-articles');
        }
        calendarGrid.appendChild(dayElement);
      }
      
      // Next month days (fill remaining cells)
      const totalCells = calendarGrid.children.length;
      const remainingCells = 42 - totalCells; // 6 rows * 7 days
      for (let day = 1; day <= remainingCells; day++) {
        const dayElement = createCalendarDay(day, true, null, currentYear, currentMonth + 1);
        calendarGrid.appendChild(dayElement);
      }
      
      // Debug: Log calendar rendering status
      const clickableDays = calendarGrid.querySelectorAll('.calendar-day:not(.other-month)');
      console.log(`Calendar rendered: ${clickableDays.length} clickable days created`);
      
      // Test: Verify event listeners are attached
      if (clickableDays.length > 0) {
        const firstDay = clickableDays[0];
        const dateAttr = firstDay.getAttribute('data-date');
        console.log('First clickable day:', dateAttr, 'Has click handler:', firstDay.onclick !== null || firstDay.hasAttribute('data-date'));
      }
    }
    
    function createCalendarDay(day, isOtherMonth, dayArticles, year, month) {
      const dayElement = document.createElement('div');
      dayElement.className = 'calendar-day';
      if (isOtherMonth) {
        dayElement.classList.add('other-month');
      }
      
      // 创建内部元素
      const dayNumber = document.createElement('div');
      dayNumber.className = 'calendar-day-number';
      dayNumber.textContent = day;
      dayElement.appendChild(dayNumber);
      
      if (dayArticles && dayArticles.length > 0) {
        const articlesCount = document.createElement('div');
        articlesCount.className = 'calendar-day-articles-count';
        articlesCount.textContent = dayArticles.length;
        dayElement.appendChild(articlesCount);
      }
      
      if (!isOtherMonth) {
        const dateKey = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // 确保可以点击 - 设置样式
        dayElement.style.cursor = 'pointer';
        dayElement.style.pointerEvents = 'auto';
        dayElement.style.userSelect = 'none';
        dayElement.setAttribute('data-date', dateKey);
        dayElement.setAttribute('role', 'button');
        dayElement.setAttribute('tabindex', '0');
        
        // 点击事件
        const clickHandler = (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('Date clicked:', dateKey, 'Element:', dayElement);
          handleDateClick(dateKey, dayArticles || []);
        };
        
        dayElement.addEventListener('click', clickHandler);
        
        // 键盘事件支持
        dayElement.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            clickHandler(e);
          }
        });
        
        // 触摸事件支持（移动设备）
        dayElement.addEventListener('touchend', (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('Date touched:', dateKey);
          handleDateClick(dateKey, dayArticles || []);
        });
        
        // 防止内部元素阻止点击
        dayNumber.style.pointerEvents = 'none';
        if (dayElement.querySelector('.calendar-day-articles-count')) {
          dayElement.querySelector('.calendar-day-articles-count').style.pointerEvents = 'none';
        }
      }
      
      return dayElement;
    }
    
    function handleDateClick(dateKey, dateArticles) {
      try {
        console.log('handleDateClick called with:', dateKey);
        selectedDate = dateKey;
        const [year, month, day] = dateKey.split('-');
        const dateTitle = `${year}年${parseInt(month)}月${parseInt(day)}日`;
        
        // Re-filter articles for this date to ensure we have the latest list
        const filteredArticles = (articles || []).filter(article => {
          try {
            const articleDate = new Date(article.date || article.created_at);
            const articleDateKey = `${articleDate.getFullYear()}-${String(articleDate.getMonth() + 1).padStart(2, '0')}-${String(articleDate.getDate()).padStart(2, '0')}`;
            return articleDateKey === dateKey;
          } catch (e) {
            console.error('Error filtering article:', e);
            return false;
          }
        });
        
        // Filter schedules for this date
        const filteredSchedules = (schedules || []).filter(schedule => {
          try {
            if (!schedule || !schedule.date) return false;
            const scheduleDate = new Date(schedule.date);
            const scheduleDateKey = `${scheduleDate.getFullYear()}-${String(scheduleDate.getMonth() + 1).padStart(2, '0')}-${String(scheduleDate.getDate()).padStart(2, '0')}`;
            return scheduleDateKey === dateKey;
          } catch (e) {
            console.error('Error filtering schedule:', e);
            return false;
          }
        });
        
        const dateTitleEl = document.getElementById('selected-date-title');
        const dateContainerEl = document.getElementById('date-articles-container');
        
        if (!dateTitleEl || !dateContainerEl) {
          console.error('Required elements not found:', { dateTitleEl, dateContainerEl });
          alert('無法找到必要的元素，請刷新頁面重試');
          return;
        }
        
        dateTitleEl.textContent = dateTitle;
        renderSchedules(filteredSchedules);
        renderDateArticles(filteredArticles);
        dateContainerEl.style.display = 'block';
        
        // Scroll to the container
        dateContainerEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        console.log('Date clicked successfully:', dateTitle);
      } catch (error) {
        console.error('Error in handleDateClick:', error);
        alert('點擊日期時發生錯誤：' + error.message);
      }
    }
    
    function renderSchedules(dateSchedules) {
      const scheduleList = document.getElementById('schedule-list');
      if (!scheduleList) return;
      
      scheduleList.innerHTML = '';
      
      if (dateSchedules.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.style.textAlign = 'center';
        emptyMsg.style.color = 'var(--text-muted)';
        emptyMsg.style.padding = '20px';
        emptyMsg.textContent = '尚無時程安排';
        scheduleList.appendChild(emptyMsg);
      } else {
        // Sort schedules by time
        const sortedSchedules = [...dateSchedules].sort((a, b) => {
          if (a.time < b.time) return -1;
          if (a.time > b.time) return 1;
          return 0;
        });
        
        sortedSchedules.forEach((schedule) => {
          const scheduleIndex = schedules.findIndex(s => s.id === schedule.id);
          const scheduleItem = document.createElement('div');
          scheduleItem.className = 'schedule-item';
          
          scheduleItem.innerHTML = `
            <div class="schedule-item-content">
              <div class="schedule-item-time">${schedule.time || '未設定'}</div>
              <h5 class="schedule-item-title">${schedule.title || '無標題'}</h5>
              ${schedule.description ? `<p class="schedule-item-description">${schedule.description}</p>` : ''}
            </div>
            <div class="schedule-item-actions">
              <button class="schedule-item-btn edit-schedule-btn" data-index="${scheduleIndex}" title="編輯">✎</button>
              <button class="schedule-item-btn delete-schedule-btn delete-btn" data-index="${scheduleIndex}" title="刪除">×</button>
            </div>
          `;
          
          // Edit button
          const editBtn = scheduleItem.querySelector('.edit-schedule-btn');
          editBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openEditScheduleModal(scheduleIndex);
          });
          
          // Delete button
          const deleteBtn = scheduleItem.querySelector('.delete-schedule-btn');
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm(`確定要刪除「${schedule.title}」嗎？`)) {
              deleteScheduleById(schedule.id, scheduleIndex);
            }
          });
          
          scheduleList.appendChild(scheduleItem);
        });
      }
    }
    
    function renderDateArticles(dateArticles) {
      const articlesList = document.getElementById('date-articles-list');
      if (!articlesList) return;
      
      articlesList.innerHTML = '';
      
      if (dateArticles.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.style.textAlign = 'center';
        emptyMsg.style.color = 'var(--text-muted)';
        emptyMsg.style.padding = '20px';
        emptyMsg.innerHTML = '<p>此日期尚無文章</p><button class="btn-save" style="margin-top: 12px;" id="btn-add-article-to-date">新增文章</button>';
        articlesList.appendChild(emptyMsg);
        
        const addBtn = document.getElementById('btn-add-article-to-date');
        if (addBtn) {
          addBtn.addEventListener('click', () => {
            openEditArticleModal(-1, selectedDate);
          });
        }
      } else {
        dateArticles.forEach((article, index) => {
          const articleIndex = articles.findIndex(a => a.id === article.id);
          const articleItem = document.createElement('div');
          articleItem.className = 'article-item';
          
          const updatedAt = formatDateTime(article.updated_at || article.created_at);
          
          articleItem.innerHTML = `
            <div class="article-item-header">
              <h3 class="article-item-title">${article.title || '無標題'}</h3>
              <div class="article-item-actions">
                <button class="article-item-btn edit-article-btn" data-index="${articleIndex}" title="編輯">✎</button>
                <button class="article-item-btn delete-article-btn delete-btn" data-index="${articleIndex}" title="刪除">×</button>
              </div>
            </div>
            <div class="article-item-meta">
              <div class="article-item-meta-item">
                <span class="article-item-meta-label">作者：</span>
                <span class="article-item-meta-value">${article.author || '未知'}</span>
              </div>
              <div class="article-item-meta-item">
                <span class="article-item-meta-label">最後修改：</span>
                <span class="article-item-meta-value">${updatedAt}</span>
              </div>
            </div>
            <div class="article-item-content">${article.content || ''}</div>
          `;
          
          // 編輯按鈕
          const editBtn = articleItem.querySelector('.edit-article-btn');
          editBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openEditArticleModal(articleIndex);
          });
          
          // 刪除按鈕
          const deleteBtn = articleItem.querySelector('.delete-article-btn');
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm(`確定要刪除「${article.title}」嗎？`)) {
              deleteArticleById(article.id, articleIndex);
            }
          });
          
          articlesList.appendChild(articleItem);
        });
        
        // Add button to add more articles
        const addBtn = document.createElement('div');
        addBtn.className = 'add-article-btn';
        addBtn.textContent = '新增文章';
        addBtn.addEventListener('click', () => openEditArticleModal(-1, selectedDate));
        articlesList.appendChild(addBtn);
      }
    }
    
    // Schedule Edit Modal Functions
    let currentScheduleEditIndex = -1;

    function openEditScheduleModal(index) {
      currentScheduleEditIndex = index;
      const modal = document.getElementById('schedule-modal');
      const title = document.getElementById('schedule-modal-title');
      const timeInput = document.getElementById('schedule-time');
      const titleInput = document.getElementById('schedule-title');
      const descriptionInput = document.getElementById('schedule-description');
      
      if (index === -1) {
        // 新增模式
        title.textContent = '新增行程';
        timeInput.value = '';
        timeInput.disabled = false;
        titleInput.value = '';
        descriptionInput.value = '';
      } else {
        // 編輯模式
        title.textContent = '編輯行程';
        const schedule = schedules[index];
        
        // 确保时间字段可以编辑
        timeInput.disabled = false;
        
        // 处理时间格式 - HTML time input需要HH:MM格式
        let timeValue = schedule.time || '';
        // 如果时间格式不是HH:MM，尝试转换
        if (timeValue && !/^\d{2}:\d{2}$/.test(timeValue)) {
          // 尝试从其他格式转换
          if (timeValue.includes(':')) {
            const parts = timeValue.split(':');
            if (parts.length >= 2) {
              timeValue = `${String(parts[0]).padStart(2, '0')}:${String(parts[1]).padStart(2, '0')}`;
            }
          } else if (timeValue.length === 4) {
            // 假设是HHMM格式
            timeValue = `${timeValue.substring(0, 2)}:${timeValue.substring(2, 4)}`;
          }
        }
        
        timeInput.value = timeValue;
        titleInput.value = schedule.title || '';
        descriptionInput.value = schedule.description || '';
        
        console.log('Editing schedule:', schedule, 'Time value:', timeValue);
      }
      
      modal.classList.add('active');
      // 聚焦到时间输入框，方便用户直接修改
      setTimeout(() => {
        timeInput.focus();
        timeInput.select();
      }, 100);
    }

    function closeEditScheduleModal() {
      const modal = document.getElementById('schedule-modal');
      const timeInput = document.getElementById('schedule-time');
      const titleInput = document.getElementById('schedule-title');
      const descriptionInput = document.getElementById('schedule-description');
      
      // 确保所有字段都可用
      if (timeInput) {
        timeInput.disabled = false;
      }
      
      modal.classList.remove('active');
      currentScheduleEditIndex = -1;
      
      // 清空表单（可选，根据需求决定）
      // if (timeInput) timeInput.value = '';
      // if (titleInput) titleInput.value = '';
      // if (descriptionInput) descriptionInput.value = '';
    }

    async function saveSchedule() {
      const timeInput = document.getElementById('schedule-time');
      const titleInput = document.getElementById('schedule-title');
      const descriptionInput = document.getElementById('schedule-description');
      
      if (!timeInput || !titleInput) {
        console.error('Schedule form inputs not found');
        alert('表單元素未找到，請刷新頁面重試');
        return;
      }
      
      // 确保时间输入框没有被禁用
      if (timeInput.disabled) {
        timeInput.disabled = false;
      }
      
      const time = timeInput.value.trim();
      const title = titleInput.value.trim();
      const description = descriptionInput.value.trim();
      
      console.log('Saving schedule:', { time, title, description, isEdit: currentScheduleEditIndex !== -1 });
      
      if (!time || !title) {
        alert('請填寫時間和標題');
        return;
      }
      
      // 验证时间格式 (HH:MM)
      if (!/^\d{2}:\d{2}$/.test(time)) {
        alert('時間格式不正確，請使用 HH:MM 格式（例如：14:30）');
        timeInput.focus();
        return;
      }
      
      // Use selected date or current date
      let scheduleDate = selectedDate;
      if (!scheduleDate) {
        const today = new Date();
        scheduleDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      }
      
      if (currentScheduleEditIndex === -1) {
        // 新增
        const newSchedule = await addSchedule(scheduleDate, time, title, description);
        if (newSchedule) {
          schedules.push(newSchedule);
          if (selectedDate) {
            const filteredSchedules = schedules.filter(schedule => {
              const scheduleDate = new Date(schedule.date);
              const scheduleDateKey = `${scheduleDate.getFullYear()}-${String(scheduleDate.getMonth() + 1).padStart(2, '0')}-${String(scheduleDate.getDate()).padStart(2, '0')}`;
              return scheduleDateKey === selectedDate;
            });
            renderSchedules(filteredSchedules);
          }
          closeEditScheduleModal();
        }
      } else {
        // 編輯
        const schedule = schedules[currentScheduleEditIndex];
        console.log('Updating schedule:', schedule.id, 'with time:', time);
        const updated = await updateSchedule(schedule.id, scheduleDate, time, title, description);
        if (updated) {
          console.log('Schedule updated successfully:', updated);
          schedules[currentScheduleEditIndex] = updated;
          if (selectedDate) {
            const filteredSchedules = schedules.filter(schedule => {
              const scheduleDate = new Date(schedule.date);
              const scheduleDateKey = `${scheduleDate.getFullYear()}-${String(scheduleDate.getMonth() + 1).padStart(2, '0')}-${String(scheduleDate.getDate()).padStart(2, '0')}`;
              return scheduleDateKey === selectedDate;
            });
            renderSchedules(filteredSchedules);
          }
          closeEditScheduleModal();
        } else {
          alert('更新失敗，請檢查控制台錯誤信息');
        }
      }
    }

    async function deleteScheduleById(id, index) {
      const success = await deleteSchedule(id);
      if (success) {
        schedules.splice(index, 1);
        if (selectedDate) {
          const filteredSchedules = schedules.filter(schedule => {
            const scheduleDate = new Date(schedule.date);
            const scheduleDateKey = `${scheduleDate.getFullYear()}-${String(scheduleDate.getMonth() + 1).padStart(2, '0')}-${String(scheduleDate.getDate()).padStart(2, '0')}`;
            return scheduleDateKey === selectedDate;
          });
          renderSchedules(filteredSchedules);
        }
      }
    }
    
    function prevMonth() {
      currentMonth--;
      if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
      }
      renderCalendar();
    }
    
    function nextMonth() {
      currentMonth++;
      if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
      }
      renderCalendar();
    }
    
    function openYearMonthSelector(type) {
      const modal = document.getElementById('year-month-modal');
      const title = document.getElementById('year-month-modal-title');
      const grid = document.getElementById('year-month-grid');
      
      if (type === 'year') {
        title.textContent = '選擇年份';
        grid.innerHTML = '';
        const currentYearValue = currentYear;
        const startYear = currentYearValue - 10;
        const endYear = currentYearValue + 10;
        
        for (let year = startYear; year <= endYear; year++) {
          const item = document.createElement('div');
          item.className = 'year-month-item';
          if (year === currentYearValue) {
            item.classList.add('selected');
          }
          item.textContent = year;
          item.addEventListener('click', () => {
            currentYear = year;
            renderCalendar();
            closeYearMonthSelector();
          });
          grid.appendChild(item);
        }
      } else if (type === 'month') {
        title.textContent = '選擇月份';
        grid.innerHTML = '';
        const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
        
        monthNames.forEach((monthName, index) => {
          const item = document.createElement('div');
          item.className = 'year-month-item';
          if (index + 1 === currentMonth) {
            item.classList.add('selected');
          }
          item.textContent = monthName;
          item.addEventListener('click', () => {
            currentMonth = index + 1;
            renderCalendar();
            closeYearMonthSelector();
          });
          grid.appendChild(item);
        });
      }
      
      modal.classList.add('active');
    }
    
    function closeYearMonthSelector() {
      const modal = document.getElementById('year-month-modal');
      modal.classList.remove('active');
    }

    async function deleteArticleById(id, index) {
      const success = await deleteArticle(id);
      if (success) {
        articles.splice(index, 1);
        renderCalendar();
        if (selectedDate) {
          const dateArticles = articles.filter(a => {
            const aDate = new Date(a.date || a.created_at);
            const dateKey = `${aDate.getFullYear()}-${String(aDate.getMonth() + 1).padStart(2, '0')}-${String(aDate.getDate()).padStart(2, '0')}`;
            return dateKey === selectedDate;
          });
          renderDateArticles(dateArticles);
        }
      }
    }

    async function initArticles() {
      articles = await loadArticles();
      schedules = await loadSchedules();
      renderCalendar();
    }

    // Article Edit Modal Functions
    let currentArticleEditIndex = -1;
    let currentArticleDate = null;

    function openEditArticleModal(index, date = null) {
      currentArticleEditIndex = index;
      currentArticleDate = date || selectedDate;
      const editModal = document.getElementById('edit-article-modal');
      const editTitle = document.getElementById('edit-article-modal-title');
      const titleInput = document.getElementById('edit-article-title');
      const authorInput = document.getElementById('edit-article-author');
      const contentInput = document.getElementById('edit-article-content');
      
      if (index === -1) {
        // 新增模式
        editTitle.textContent = currentArticleDate ? `新增文章 - ${currentArticleDate}` : '新增文章';
        titleInput.value = '';
        authorInput.value = '';
        contentInput.value = '';
      } else {
        // 編輯模式
        editTitle.textContent = '編輯文章';
        const article = articles[index];
        titleInput.value = article.title || '';
        authorInput.value = article.author || '';
        contentInput.value = article.content || '';
        currentArticleDate = article.date || currentArticleDate;
      }
      
      editModal.classList.add('active');
      titleInput.focus();
    }

    function closeEditArticleModal() {
      const editModal = document.getElementById('edit-article-modal');
      editModal.classList.remove('active');
      currentArticleEditIndex = -1;
      currentArticleDate = null;
    }

    async function saveArticle() {
      const titleInput = document.getElementById('edit-article-title');
      const authorInput = document.getElementById('edit-article-author');
      const contentInput = document.getElementById('edit-article-content');
      
      const title = titleInput.value.trim();
      const author = authorInput.value.trim();
      const content = contentInput.value.trim();
      
      if (!title || !content) {
        alert('請填寫標題和內容');
        return;
      }
      
      // Use selected date or current date
      let articleDate = currentArticleDate;
      if (!articleDate) {
        const today = new Date();
        articleDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      }
      
      if (currentArticleEditIndex === -1) {
        // 新增
        const newArticle = await addArticle(title, author, content, articleDate);
        if (newArticle) {
          articles.push(newArticle);
          renderCalendar();
          if (selectedDate === articleDate) {
            const dateArticles = articles.filter(a => {
              const aDate = new Date(a.date || a.created_at);
              const dateKey = `${aDate.getFullYear()}-${String(aDate.getMonth() + 1).padStart(2, '0')}-${String(aDate.getDate()).padStart(2, '0')}`;
              return dateKey === articleDate;
            });
            renderDateArticles(dateArticles);
          }
          closeEditArticleModal();
        }
      } else {
        // 編輯
        const article = articles[currentArticleEditIndex];
        const updated = await updateArticle(article.id, title, author, content, articleDate);
        if (updated) {
          articles[currentArticleEditIndex] = updated;
          renderCalendar();
          if (selectedDate === articleDate) {
            const dateArticles = articles.filter(a => {
              const aDate = new Date(a.date || a.created_at);
              const dateKey = `${aDate.getFullYear()}-${String(aDate.getMonth() + 1).padStart(2, '0')}-${String(aDate.getDate()).padStart(2, '0')}`;
              return dateKey === articleDate;
            });
            renderDateArticles(dateArticles);
          }
          closeEditArticleModal();
        }
      }
    }

    // Initial stories data (for migration - can be removed after importing to Supabase)
    const initialStories = [
      {
        title: "健康教育課",
        preview: "程老師來到學生家中進行一對一家教，但今天的課程內容並非一般學科。她將以專業冷靜的態度，教導學生關於性交與自慰的知識與實作...",
        content: `[角色扮演遊戲]

程老師:專業冷靜的家教老師
瑄瑄:需要健康教育的學生

第一章｜基礎知識教學

主題：性教育的理論基礎

程老師來到瑄瑄家中，拿出準備好的教材。她態度冷靜專業，如同教授任何一門學科般開始講解。

她讓瑄瑄詳細了解身體構造、生理反應、敏感區域與基本的性知識。

在她的筆記本上，「健康教育」四個字被劃下粗黑線。

程老師以毫無情緒的口吻說明每個部位的功能、反應機制與注意事項。

第二章｜自我探索實作

主題：自慰技巧的實作教學

程老師開始對瑄瑄進行「自我探索實作訓練」。

瑄瑄必須在老師的監督下，對自己進行身體敏感區域的探索與刺激。

每一段探索都有時間限制、強度限制，並強制「不得過度」。

程老師在旁以專業教學的口吻記錄他的生理變化、呼吸節奏、肌肉反射、意識狀態。

當瑄瑄接近臨界點時，老師會立刻喊停，讓他學習控制與延遲的技巧。

這整個訓練的目的，就是讓瑄瑄對自己的身體產生清楚的認知與控制能力。

久而久之，瑄瑄對自己的身體反應產生一種理性的理解。

第三章｜互動式性交教學

主題：他人互動模式下的實作觀察

程老師允許瑄瑄使用她的身體進行實際的性交教學。

她全程保持冷靜與專業距離感，像在進行教學示範，不帶任何情緒。

瑄瑄的反應變得比第一階段更強烈，他逐漸理解理論與實作之間的差異。

程老師一邊讓他「接近臨界」，一邊記錄其中的生理反應模式，例如：

被刺激後的身體變化
實際接觸他人後，慾望與反應的強度
對老師本人的信任感與依賴感上升

教學過程中，程老師會在瑄瑄最無法控制的瞬間停止動作，使他再次學習自我控制。

第四章｜合：完整實作測驗

主題：完整流程的實踐與驗收

最終測驗分成兩段：

完整自慰：讓瑄瑄完整進行自慰流程，展示所學技巧。

完整性交：進行完整的性交過程，從開始到結束，必須全程保持理性與控制，直到完全結束教學才完成。`
      },
      {
        title: "新婚夫妻",
        preview: "程小姐與瑄瑄剛結婚，興奮地討論未來的生活規劃。他們談論國內外旅遊、理想的生活方式，過程中持續不斷地進行性接觸...",
        content: `[角色扮演遊戲]

程小姐:剛結婚的新娘
瑄瑄:剛結婚的新郎

第一章｜未來生活的規劃討論

主題：興奮地討論理想生活

程小姐與瑄瑄剛結婚，兩人興奮地躺在床上討論未來的生活規劃。

程小姐態度興奮而充滿期待，她讓瑄瑄詳細描述他想要的生活、理想的居住環境、以及最想一起做的事情。

在她的心中，「未來」兩個字充滿無限可能。

她以充滿興奮的口吻詢問他的夢想、旅遊計劃、生活方式與最期待的時刻。

過程中，兩人的手不斷在彼此身上游移，輕撫、擁抱、親吻，性接觸持續不斷。

第二章｜國內外旅遊的夢想清單

主題：規劃旅行中的持續親密

程小姐開始與瑄瑄討論「國內外旅遊計劃」。

瑄瑄必須在討論的同時，持續撫摸妻子的身體，探索她身體的每一個敏感區域。

每一段討論都伴隨著持續的性接觸、溫柔的觸碰，並強制「不得停止」。

程小姐在討論旅遊地點時，一邊感受他的觸碰、呼吸節奏、身體反應、意識狀態。

當瑄瑄提到特別興奮的旅遊計劃時，妻子會更加熱情地回應，讓性接觸變得更加激烈。

這整個討論的目的，就是讓兩人在規劃未來的同時，持續享受彼此的親密接觸。

久而久之，兩人對未來生活的期待與當下的性愛產生一種完美的融合。

第三章｜理想生活方式的深入交流

主題：討論與性愛的完美結合

程小姐與瑄瑄進行更深層的生活規劃討論，包括居住環境、工作安排、家庭計劃。

她全程保持興奮與親密感，像在共同創造未來，充滿期待與愛意。

瑄瑄的反應變得比第一階段更強烈，他逐漸理解討論未來與享受當下之間的完美平衡。

程小姐一邊讓他「接近臨界」，一邊繼續討論理想生活，例如：

討論居住環境時，持續撫摸與親吻
規劃工作安排時，身體接觸不斷加深
談論家庭計劃時，性愛交流達到高峰

交流過程中，程小姐會在瑄瑄最興奮的瞬間更加熱情地配合，使討論與性愛完美結合。

第四章｜合：未來與當下的完整融合

主題：完整規劃與完整釋放

最終討論分成兩段：

完整規劃：讓瑄瑄完整討論所有未來計劃，從旅遊到生活，過程中持續不斷的性接觸。

完整釋放：進行完整的性愛過程，從開始到結束，必須全程保持對未來的討論與興奮，直到完全釋放並確認彼此對未來的承諾才完成。`
      },
      {
        title: "花藝研究學院",
        preview: "程小姐與瑄瑄是花藝研究學院的學生，兩人一起研究花藝的學問、手法與各種花的知識。在研究過程中，持續不斷地進行性接觸...",
        content: `[角色扮演遊戲]

程小姐:花藝研究學院的學生
瑄瑄:花藝研究學院的學生

第一章｜花藝學問的深入研究

主題：學習花藝理論中的持續親密

程小姐與瑄瑄是花藝研究學院的學生，兩人一起在工作室中研究花藝的學問。

程小姐態度認真而充滿熱情，她讓瑄瑄詳細描述各種花的特性、花語、生長環境、以及插花的基本理論。

在她的筆記本上，「花藝研究」四個字被劃下重點標記。

她以充滿求知慾的口吻詢問他對花藝的理解、各種花材的知識、插花技巧與最想學習的領域。

過程中，兩人的手不斷在彼此身上游移，輕撫、擁抱、親吻，性接觸持續不斷，同時繼續討論花藝知識。

第二章｜插花手法的實作練習

主題：練習技巧中的身體接觸

程小姐開始與瑄瑄進行「插花手法實作練習」。

瑄瑄必須在練習插花的同時，持續撫摸程小姐的身體，探索她身體的每一個敏感區域。

每一段練習都伴隨著持續的性接觸、溫柔的觸碰，並強制「不得停止」。

程小姐在示範插花技巧時，一邊感受他的觸碰、呼吸節奏、身體反應、意識狀態。

當瑄瑄掌握特別難的插花技巧時，程小姐會更加熱情地回應，讓性接觸變得更加激烈。

這整個練習的目的，就是讓兩人在學習花藝技巧的同時，持續享受彼此的親密接觸。

久而久之，兩人對花藝的熱愛與當下的性愛產生一種完美的融合。

第三章｜各種花材知識的深入探討

主題：花材研究與性愛的完美結合

程小姐與瑄瑄進行更深層的花材知識探討，包括玫瑰、百合、鬱金香、向日葵等各種花的特性與應用。

她全程保持專注與親密感，像在共同探索花的世界，充滿熱情與求知慾。

瑄瑄的反應變得比第一階段更強烈，他逐漸理解學習花藝與享受當下之間的完美平衡。

程小姐一邊讓他「接近臨界」，一邊繼續討論各種花材，例如：

討論玫瑰的品種時，持續撫摸與親吻
研究百合的插法時，身體接觸不斷加深
探討鬱金香的特性時，性愛交流達到高峰

探討過程中，程小姐會在瑄瑄最興奮的瞬間更加熱情地配合，使花藝研究與性愛完美結合。

第四章｜合：花藝知識與身體的完整融合

主題：完整學習與完整釋放

最終研究分成兩段：

完整學習：讓瑄瑄完整學習所有花藝知識，從理論到實作，過程中持續不斷的性接觸。

完整釋放：進行完整的性愛過程，從開始到結束，必須全程保持對花藝的討論與學習，直到完全釋放並確認彼此對花藝的熱愛才完成。`
      },
      {
        title: "特殊職缺面試",
        preview: "程小姐來到面試現場，原本以為是一般秘書職務，然而瑄瑄翻到下一頁後，空氣變得不尋常。超出常規的職缺說明，包含特殊的情緒管理與身心調節服務...",
        content: `[角色扮演遊戲]

程小姐：冷靜理性的求職者
瑄瑄：制度離譜的老闆

第一章｜奇特的職缺說明

主題：超出常規的秘書需求

程小姐來到面試現場時，先看到的是一般秘書職務內容：行程管理、文件整理、客戶協調。然而瑄瑄翻到下一頁後，空氣變得不尋常。

他平靜、像在念公司手冊般說明：「本職缺包含主管情緒管理、壓力緩衝與身心調節服務，是本公司的重要績效項目。」

薪資制度：

個人「高潮」達成一次，加薪 2000。

協助主管達成「高潮」一次，加薪 1000。

程小姐看著這段描述，卻沒有露出驚訝，像是早習慣這種隱晦制度的地下行業。她只是點頭，示意繼續。

瑄瑄在履歷上寫下一句重點：「需具備高承受度與高開放度。」

第二章｜情慾開放度測試

主題：針對性開放尺度的問題

Q:接受隨時被撫摸乳房嗎?

Q:接受隨時被玩弄小穴嗎?

Q:接受隨時帶著玩具被控制嗎?

Q:自己跟主管報告時可以自己自慰並且高潮嗎?

Q:能否在高壓的同時，接受身體被玩弄?

Q:在被玩弄時，能否保持專業形象跟語氣，持續認真工作?

第三章｜互動感測實作

主題：身體敏感度測試還有性開放測試

程小姐在接受瑄瑄對於她身體的各種玩弄表現出從容不迫的樣子

第四章｜最終確認：制度是否能被承受

主題：認可與宣示

接下來是宣示測試，必須念出以下文字，評斷程小姐是否有熱情並且願意完全付出於工作上

1.我願意隨時被玩弄，我的身體是宣宣的。

2.性慾是理所當然的事情，我願意隨時隨地發生性愛。

3.瑄瑄口渴時，我必須用我小穴的水來幫瑄瑄止渴。

4.在辦公室被玩弄時，我仍然會保持專業形象，進行工作。

最後內射做為結束。`
      },
      {
        title: "性慾成癮的治療",
        preview: "瑄瑄因為性慾過度影響生活、工作、專注力，來到程醫生診間。程醫生态度冷靜，問診如同分析機械故障。開始進行一系列自我刺激抑制訓練...",
        content: `[角色扮演遊戲]

程醫生:專業冷靜的醫生
瑄瑄:性慾成癮的病人

第一章｜過度旺盛的病人

主題：慾望失控的自白

瑄瑄因為性慾過度影響生活、工作、專注力，來到程醫生診間。程醫生态度冷靜，問診如同分析機械故障。她讓瑄瑄詳細描述發作頻率、慾望狀態、身體反應與最痛苦的時段。

在她的筆記本上，「性慾成癮」四個字被劃下粗黑線。

第二章｜自我刺激抑制訓練

主題：慾望壓抑的自我控制技術

程醫生開始對瑄瑄進行「自我刺激抑制訓練」。

瑄瑄必須在醫生的監督下，對自己進行高度敏感區域的刺激測試。

每一段刺激都有時間限制、強度限制，並強制「不得越界」。

程醫生在旁以毫無情緒的口吻記錄他的生理變化、呼吸節奏、肌肉反射、意識模糊程度。

當瑄瑄接近臨界點時，醫生會立刻喊停，讓他經歷最痛苦的「被卡住」狀態。

這整個訓練的目的，就是讓瑄瑄的慾望高度被反覆升起→掐斷→升起→掐斷。

久而久之，瑄瑄對自己的欲望產生一種扭曲的清醒。

第三章｜醫生介入的高階刺激治療

主題：他人刺激模式下的心理失衡觀察

程醫生允許瑄瑄使用她的身體部分接觸來替代自我刺激。

她全程保持冷靜與距離感，像在做醫學實驗，不帶任何情緒。

瑄瑄的反應變得比第一階段更失控，他逐漸分不清刺激與壓抑之間的心理落差。

程醫生一邊讓他「接近失控」，一邊記錄其中的變態衝動模式，例如：

被壓抑後反而更興奮被准許接觸他人後，慾望幾乎瞬間暴衝

對醫生本人的依附感上升

治療過程中，程醫生會在瑄瑄最無法忍耐的瞬間抽離刺激，使他再次被迫壓抑。

第四章｜合：最後一次療程

主題：峰值與釋放

最終療程分成兩段：

最大誘發：讓瑄瑄發狂的使用自己的肉體。

完整釋放：射精完成後不准停止刺激，必續持續射精到完全沒力療程才結束`
      }
    ];

    // Lovense Interactive Game Functions
    let lovenseWebhookUrl = '';
    let lovenseToken = '';
    let isConnected = false;
    let currentVibration = null;

    // Update connection status
    function updateConnectionStatus(connected, connecting = false) {
      const statusIndicator = document.getElementById('status-indicator');
      const statusText = document.getElementById('status-text');
      const controlPanel = document.getElementById('control-panel');
      
      if (statusIndicator && statusText) {
        statusIndicator.className = 'status-indicator';
        if (connected) {
          statusIndicator.classList.add('connected');
          statusText.textContent = '已連接';
          isConnected = true;
          if (controlPanel) controlPanel.style.display = 'flex';
        } else if (connecting) {
          statusIndicator.classList.add('connecting');
          statusText.textContent = '連接中...';
          isConnected = false;
        } else {
          statusText.textContent = '未連接';
          isConnected = false;
          if (controlPanel) controlPanel.style.display = 'none';
        }
      }
    }

    // Send vibration command via webhook
    async function sendVibrationCommand(command) {
      if (!lovenseWebhookUrl) {
        alert('請先設定 Webhook URL');
        return false;
      }

      try {
        const payload = {
          action: 'vibrate',
          intensity: command.intensity || 50,
          duration: command.duration || 3,
          pattern: command.pattern || 'constant',
          token: lovenseToken || undefined,
          timestamp: new Date().toISOString()
        };

        const response = await fetch(lovenseWebhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Vibration command sent:', data);
        return true;
      } catch (error) {
        console.error('Failed to send vibration command:', error);
        alert('發送振動命令失敗: ' + error.message);
        return false;
      }
    }

    // Connect to Lovense
    function connectLovense() {
      const webhookUrl = document.getElementById('webhook-url')?.value.trim();
      const token = document.getElementById('device-token')?.value.trim();

      if (!webhookUrl) {
        alert('請輸入 Webhook URL');
        return;
      }

      lovenseWebhookUrl = webhookUrl;
      lovenseToken = token || '';

      updateConnectionStatus(false, true);

      // Test connection
      setTimeout(() => {
        // Simulate connection test
        updateConnectionStatus(true);
      }, 1000);
    }

    // Stop vibration
    async function stopVibration() {
      if (!isConnected) return;

      try {
        const payload = {
          action: 'stop',
          token: lovenseToken || undefined,
          timestamp: new Date().toISOString()
        };

        await fetch(lovenseWebhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        if (currentVibration) {
          clearInterval(currentVibration);
          currentVibration = null;
        }
      } catch (error) {
        console.error('Failed to stop vibration:', error);
      }
    }

    // Start vibration
    async function startVibration() {
      if (!isConnected) {
        alert('請先連接設備');
        return;
      }

      const intensity = parseInt(document.getElementById('vibration-intensity')?.value || 50);
      const duration = parseInt(document.getElementById('vibration-duration')?.value || 3);

      await sendVibrationCommand({
        intensity: intensity,
        duration: duration,
        pattern: 'constant'
      });
    }

    // Pattern functions
    const patterns = {
      gentle: { intensity: 20, duration: 5, pattern: 'wave' },
      medium: { intensity: 50, duration: 5, pattern: 'wave' },
      strong: { intensity: 80, duration: 5, pattern: 'constant' },
      wave: { intensity: 60, duration: 10, pattern: 'wave' },
      pulse: { intensity: 70, duration: 8, pattern: 'pulse' },
      random: { intensity: Math.floor(Math.random() * 100), duration: 5, pattern: 'random' }
    };

    // Game functions
    function startRhythmGame() {
      if (!isConnected) {
        alert('請先連接設備');
        return;
      }

      let beatCount = 0;
      const rhythm = setInterval(() => {
        beatCount++;
        const intensity = 30 + (beatCount % 4) * 20;
        sendVibrationCommand({
          intensity: intensity,
          duration: 0.5,
          pattern: 'pulse'
        });

        if (beatCount >= 20) {
          clearInterval(rhythm);
          alert('節奏遊戲結束！');
        }
      }, 1000);
    }

    function startReactionTest() {
      if (!isConnected) {
        alert('請先連接設備');
        return;
      }

      const randomDelay = Math.random() * 3000 + 2000; // 2-5 seconds
      
      setTimeout(() => {
        sendVibrationCommand({
          intensity: 80,
          duration: 1,
          pattern: 'constant'
        });
        alert('反應測試開始！');
      }, randomDelay);
    }

    function startRandomStimulation() {
      if (!isConnected) {
        alert('請先連接設備');
        return;
      }

      const randomInterval = setInterval(() => {
        const intensity = Math.floor(Math.random() * 100);
        const duration = Math.random() * 3 + 1;
        
        sendVibrationCommand({
          intensity: intensity,
          duration: duration,
          pattern: 'random'
        });
      }, 3000);

      // Stop after 30 seconds
      setTimeout(() => {
        clearInterval(randomInterval);
        stopVibration();
      }, 30000);
    }

    // Initialize Lovense controls
    // Truth & Dare Card Game - 性開放議題版本
    const truthDareCards = [
      // 能不能接受一邊xx一邊xx類型（日常生活場景性行為）
      { en: "", zh: "能不能接受一邊講電話一邊被舔私處？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊做家事一邊被插入？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊辦公一邊被舔？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊煮飯一邊被玩弄？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊開會一邊被口交？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊洗澡一邊做愛？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊看電視一邊被插入？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊打掃一邊被舔私處？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊化妝一邊被玩弄？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊開車一邊被口交？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊購物一邊被插入？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊吃飯一邊被舔？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊運動一邊做愛？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊閱讀一邊被玩弄私處？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊聽音樂一邊被插入？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊寫字一邊被口交？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊玩手機一邊被舔？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊整理房間一邊被插入？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊看書一邊被玩弄？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊泡茶一邊被口交？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊敷面膜一邊被舔私處？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊做瑜伽一邊被插入？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊工作一邊被玩弄？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊聊天一邊被口交？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊學習一邊被舔？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊洗衣服一邊被插入？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊做作業一邊被玩弄私處？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊刷牙一邊被口交？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊看電影一邊被插入？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊打遊戲一邊被舔？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊洗碗一邊被玩弄？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊敷臉一邊被口交？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊整理衣櫃一邊被插入？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊聽演講一邊被舔私處？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊做手工一邊被玩弄？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊上網一邊被口交？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊照顧寵物一邊被插入？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊寫報告一邊被舔？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊做菜一邊被玩弄私處？", ko: "", koRoman: "" },
      { en: "", zh: "能不能接受一邊聽音樂會一邊被口交？", ko: "", koRoman: "" },
      
      // 扮演xx命令xx類型（猥褻命令）
      { en: "", zh: "扮演我的性奴，完全服從我的所有命令", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的調教對象，讓我對你為所欲為", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性玩具，讓我任意玩弄你的身體", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的寵物，用嘴為我服務直到我滿意", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性奴隸，讓我強制你達到高潮", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的調教對象，讓我用各種方式羞辱你", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性服務員，用你的身體為我服務", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性玩具，讓我插入你的所有部位", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的寵物，讓我綁住你並為所欲為", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性奴，讓我拍攝你最淫蕩的樣子", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的調教對象，讓我強制你服從各種變態指令", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性玩具，讓我用各種道具玩弄你", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的寵物，讓我完全控制你的身體", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性奴隸，讓我強制你達到連續高潮", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的調教對象，讓我對你進行最變態的調教", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性服務員，用你的嘴為我深喉服務", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性玩具，讓我插入你的前庭和後庭", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的寵物，讓我用各種方式羞辱和調教你", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性奴，讓我強制你服從最淫蕩的命令", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的調教對象，讓我拍攝你被調教的過程", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性玩具，讓我用性玩具玩弄你的所有部位", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的寵物，讓我強制你達到高潮並繼續玩弄", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性奴隸，讓我完全控制你並為所欲為", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的調教對象，讓我對你進行最極端的性愛調教", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性服務員，用你的身體為我服務直到我滿意", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性玩具，讓我插入並強制你達到高潮", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的寵物，讓我用各種變態方式玩弄你", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性奴，讓我強制你服從所有變態指令", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的調教對象，讓我拍攝你最淫蕩的性愛畫面", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性玩具，讓我用各種方式強制你高潮", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的寵物，讓我完全控制你的身體並為所欲為", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性奴隸，讓我強制你達到連續高潮並繼續玩弄", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的調教對象，讓我對你進行最變態的性愛調教和羞辱", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性服務員，用你的嘴和身體為我服務直到我射精", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性玩具，讓我插入你的所有部位並強制高潮", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的寵物，讓我用各種變態方式完全控制你", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性奴，讓我強制你服從最淫蕩的變態指令", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的調教對象，讓我拍攝你被最變態方式調教的過程", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性玩具，讓我用性玩具強制你達到連續高潮", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的寵物，讓我完全控制你的身體並強制你服從", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性奴隸，讓我對你為所欲為並強制達到高潮", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的調教對象，讓我用最變態的方式調教和羞辱你", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性服務員，用你的身體為我服務並完全服從", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的性玩具，讓我插入並強制你達到最極端的高潮", ko: "", koRoman: "" },
      { en: "", zh: "扮演我的寵物，讓我用各種變態方式完全控制並玩弄你", ko: "", koRoman: "" }
    ];

    function initTruthDareGame() {
      // Truth & Dare Card Game
      const truthDareCard = document.getElementById('truth-dare-card');
      const truthDareCardMain = document.getElementById('truth-dare-card-main');
      const truthDareCardHint = document.getElementById('truth-dare-card-hint');
      const truthDareDrawBtn = document.getElementById('truth-dare-draw-btn');
      const truthDareResult = document.getElementById('truth-dare-result');
      const truthDareHistoryList = document.getElementById('truth-dare-history-list');
      let isDrawingTruthDare = false;

      function drawTruthDareCard() {
        if (isDrawingTruthDare) return;
        isDrawingTruthDare = true;
        truthDareDrawBtn.disabled = true;
        truthDareCard.classList.add('shuffling');
        truthDareCardMain.innerHTML = '…';
        truthDareCardHint.textContent = '洗牌中';

        const shuffleDuration = 900;
        const intervalTime = 90;
        let elapsed = 0;

        const shuffleTimer = setInterval(() => {
          const randomCard = truthDareCards[Math.floor(Math.random() * truthDareCards.length)];
          truthDareCardMain.innerHTML = `${randomCard.zh}`;
          elapsed += intervalTime;

          if (elapsed >= shuffleDuration) {
            clearInterval(shuffleTimer);
            const chosenCard = truthDareCards[Math.floor(Math.random() * truthDareCards.length)];

            setTimeout(() => {
              truthDareCard.classList.remove('shuffling');
              truthDareCardMain.innerHTML = `${chosenCard.zh}`;
              truthDareCardHint.textContent = '今天抽到的卡片';
              truthDareResult.innerHTML = `${chosenCard.zh}`;

              const tr = document.createElement('tr');
              const td = document.createElement('td');
              td.innerHTML = `${chosenCard.zh}`;
              tr.appendChild(td);
              truthDareHistoryList.prepend(tr);

              isDrawingTruthDare = false;
              truthDareDrawBtn.disabled = false;
            }, 130);
          }
        }, intervalTime);
      }

      if (truthDareCard) {
        truthDareCard.addEventListener('click', drawTruthDareCard);
      }
      if (truthDareDrawBtn) {
        truthDareDrawBtn.addEventListener('click', drawTruthDareCard);
      }
    }

    // Load stories from Supabase on page load
    async function initStories() {
      try {
        const loadedStories = await loadStories();
        if (loadedStories.length > 0) {
          // Database has stories, use them
          stories = loadedStories;
          renderStories();
        } else {
          // Database is empty, import initial stories
          console.log('数据库为空，正在导入初始故事...');
          stories = [];
          renderStories(); // Show empty state first
          
          // Import all initial stories to Supabase
          let importSuccess = true;
          for (const story of initialStories) {
            const newStory = await addStory(story.title, story.preview, story.content);
            if (!newStory) {
              importSuccess = false;
              console.warn('导入故事失败:', story.title);
            }
            // Small delay to avoid rate limiting
            await new Promise(resolve => setTimeout(resolve, 100));
          }
          
          if (importSuccess) {
            // Reload from database to get all stories with IDs
            const reloadedStories = await loadStories();
            if (reloadedStories.length > 0) {
              stories = reloadedStories;
            }
            console.log('初始故事导入完成！');
          } else {
            // If import failed, use initial stories as fallback
            console.warn('部分故事导入失败，使用本地数据');
            stories = initialStories;
          }
          renderStories();
        }
      } catch (error) {
        // If Supabase connection fails, use initial stories as fallback
        console.error('加载故事时发生错误，使用本地数据:', error);
        stories = initialStories;
        renderStories();
      }
    }

    function getStoryGrid() {
      // Check if story-plots-content is active (in games page)
      const storyPlotsContent = document.getElementById("story-plots-content");
      if (storyPlotsContent && storyPlotsContent.classList.contains("active")) {
        return storyPlotsContent.querySelector(".story-grid");
      }
      // Fallback to story-plots-page (legacy)
      const storyPlotsPage = document.getElementById("story-plots-page");
      if (storyPlotsPage) {
        return storyPlotsPage.querySelector(".story-grid");
      }
      // Last resort: get by id
      return document.getElementById("story-grid");
    }

    function renderStories() {
      const storyGrid = getStoryGrid();
      if (!storyGrid) return;
      
      storyGrid.innerHTML = "";
      stories.forEach((story, index) => {
        const storyCard = document.createElement("div");
        storyCard.className = "story-card";
        storyCard.innerHTML = `
          <div class="story-card-actions">
            <button class="story-card-menu-btn" data-index="${index}" title="選項">⋯</button>
            <div class="story-card-menu-dropdown">
              <div class="story-card-menu-item edit" data-action="edit" data-index="${index}">
                <span>✎</span>
                <span>編輯</span>
              </div>
              <div class="story-card-menu-item delete" data-action="delete" data-index="${index}">
                <span>×</span>
                <span>刪除</span>
              </div>
            </div>
          </div>
          <div class="story-card-title">${story.title}</div>
          <div class="story-card-preview">${story.preview}</div>
          <div class="story-card-meta">點擊查看完整劇情 →</div>
        `;
        
        // 點擊卡片查看內容
        storyCard.addEventListener("click", (e) => {
          if (!e.target.closest('.story-card-actions')) {
            openStoryModal(story);
          }
        });
        
        // 三點按鈕點擊
        const menuBtn = storyCard.querySelector('.story-card-menu-btn');
        const dropdown = storyCard.querySelector('.story-card-menu-dropdown');
        
        menuBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          // 關閉其他打開的菜單
          document.querySelectorAll('.story-card-menu-dropdown.show').forEach(menu => {
            if (menu !== dropdown) {
              menu.classList.remove('show');
              menu.closest('.story-card-actions').querySelector('.story-card-menu-btn').classList.remove('active');
            }
          });
          
          // 切換當前菜單
          dropdown.classList.toggle('show');
          menuBtn.classList.toggle('active');
        });
        
        // 編輯選項
        const editItem = storyCard.querySelector('.story-card-menu-item.edit');
        editItem.addEventListener("click", (e) => {
          e.stopPropagation();
          dropdown.classList.remove('show');
          menuBtn.classList.remove('active');
          openEditModal(index);
        });
        
        // 刪除選項
        const deleteItem = storyCard.querySelector('.story-card-menu-item.delete');
        deleteItem.addEventListener("click", async (e) => {
          e.stopPropagation();
          dropdown.classList.remove('show');
          menuBtn.classList.remove('active');
          if (confirm(`確定要刪除「${story.title}」嗎？`)) {
            const success = await deleteStory(story.id);
            if (success) {
              stories.splice(index, 1);
              renderStories();
            }
          }
        });
        
        // 點擊外部關閉菜單
        document.addEventListener('click', (e) => {
          if (!storyCard.contains(e.target)) {
            dropdown.classList.remove('show');
            menuBtn.classList.remove('active');
          }
        });
        
        storyGrid.appendChild(storyCard);
      });
    }

    function parseStoryContent(content) {
      const lines = content.split('\n');
      let html = '';
      let prevWasMainTitle = false;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        if (!line) {
          // 減少空行的間距，只添加一個小的間距
          html += '<div style="height: 4px;"></div>';
          continue;
        }
        
        // 主标题 [角色扮演遊戲]
        if (line.startsWith('[') && line.endsWith(']')) {
          html += `<div class="article-main-title">${line}</div>`;
          prevWasMainTitle = true;
        }
        // 角色设定行（紧跟在主标题后，包含冒号的短行）
        else if (prevWasMainTitle && line.includes(':') && line.length < 30) {
          html += `<div class="article-role">${line}</div>`;
          prevWasMainTitle = false;
        }
        // 章节标题（包含"第X章｜"或"第四章｜合："）
        else if (/第[一二三四五六七八九十\d]+章｜/.test(line) || /第四章｜合：/.test(line)) {
          html += `<div class="article-chapter-title">${line}</div>`;
          prevWasMainTitle = false;
        }
        // 主题行（包含"主題："）
        else if (line.includes('主題：')) {
          html += `<div class="article-theme">${line}</div>`;
          prevWasMainTitle = false;
        }
        // 普通正文
        else {
          html += `<div class="article-content">${line}</div>`;
          prevWasMainTitle = false;
        }
      }
      
      return html;
    }

    function openStoryModal(story) {
      const modal = document.getElementById("story-modal");
      const modalTitle = document.getElementById("modal-title");
      const modalBody = document.getElementById("modal-body");
      
      modalTitle.textContent = story.title;
      modalBody.innerHTML = parseStoryContent(story.content);
      modal.classList.add("active");
    }

    function closeStoryModal() {
      const modal = document.getElementById("story-modal");
      modal.classList.remove("active");
    }

    // Edit Modal Functions
    let currentEditIndex = -1;

    function openEditModal(index) {
      currentEditIndex = index;
      const editModal = document.getElementById("edit-story-modal");
      const editTitle = document.getElementById("edit-modal-title");
      const titleInput = document.getElementById("edit-story-title");
      const previewInput = document.getElementById("edit-story-preview");
      const contentInput = document.getElementById("edit-story-content");
      
      if (index === -1) {
        // 新增模式
        editTitle.textContent = "新增故事";
        titleInput.value = "";
        previewInput.value = "";
        contentInput.value = "";
      } else {
        // 編輯模式
        editTitle.textContent = "編輯故事";
        const story = stories[index];
        titleInput.value = story.title;
        previewInput.value = story.preview;
        contentInput.value = story.content;
      }
      
      editModal.classList.add("active");
      titleInput.focus();
    }

    function closeEditModal() {
      const editModal = document.getElementById("edit-story-modal");
      editModal.classList.remove("active");
      currentEditIndex = -1;
    }

    async function saveStory() {
      const titleInput = document.getElementById("edit-story-title");
      const previewInput = document.getElementById("edit-story-preview");
      const contentInput = document.getElementById("edit-story-content");
      
      if (!titleInput || !previewInput || !contentInput) {
        console.error('找不到輸入欄位');
        alert("系統錯誤：找不到輸入欄位");
        return;
      }
      
      const title = titleInput.value.trim();
      const preview = previewInput.value.trim();
      const content = contentInput.value.trim();
      
      if (!title || !preview || !content) {
        alert("請填寫所有欄位");
        return;
      }
      
      if (currentEditIndex === -1) {
        // 新增
        let savedStory = null;
        let dbSaveSuccess = false;
        
        if (supabase) {
          // 嘗試保存到資料庫
          savedStory = await addStory(title, preview, content);
          if (savedStory) {
            dbSaveSuccess = true;
          }
        }
        
        // 如果資料庫保存失敗或未連接，保存到本地
        if (!dbSaveSuccess) {
          savedStory = {
            id: `local_${Date.now()}`,
            title,
            preview,
            content,
            created_at: new Date().toISOString()
          };
        }
        
        stories.push(savedStory);
        renderStories();
        closeEditModal();
        
        if (!dbSaveSuccess && supabase) {
          alert("已保存到本地（資料庫連接失敗，資料僅在當前頁面有效）");
        } else if (!supabase) {
          alert("已保存到本地（Supabase 未連接，資料僅在當前頁面有效）");
        }
      } else {
        // 編輯
        const story = stories[currentEditIndex];
        if (!story) {
          alert("找不到要編輯的故事");
          return;
        }
        
        let updatedStory = null;
        let dbUpdateSuccess = false;
        
        if (story.id && supabase && !story.id.toString().startsWith('local_')) {
          // 有資料庫 ID，嘗試更新到資料庫
          updatedStory = await updateStory(story.id, title, preview, content);
          if (updatedStory) {
            dbUpdateSuccess = true;
          }
        }
        
        // 如果資料庫更新失敗或沒有 ID，更新本地資料
        if (!dbUpdateSuccess) {
          updatedStory = {
            ...story,
            title,
            preview,
            content,
            updated_at: new Date().toISOString()
          };
        }
        
        stories[currentEditIndex] = updatedStory;
        renderStories();
        closeEditModal();
        
        if (!dbUpdateSuccess && story.id && supabase && !story.id.toString().startsWith('local_')) {
          alert("已保存到本地（資料庫更新失敗，資料僅在當前頁面有效）");
        }
      }
    }

    // Modal Controls
    document.getElementById("modal-close").addEventListener("click", closeStoryModal);
    document.getElementById("story-modal").addEventListener("click", (e) => {
      if (e.target.id === "story-modal") {
        closeStoryModal();
      }
    });

    // Edit Modal Controls
    const editModalClose = document.getElementById("edit-modal-close");
    const editStoryModal = document.getElementById("edit-story-modal");
    const btnCancel = document.getElementById("btn-cancel");
    const btnSave = document.getElementById("btn-save");
    
    if (editModalClose) {
      editModalClose.addEventListener("click", closeEditModal);
    }
    
    if (editStoryModal) {
      editStoryModal.addEventListener("click", (e) => {
        if (e.target.id === "edit-story-modal") {
          closeEditModal();
        }
      });
    }
    
    if (btnCancel) {
      btnCancel.addEventListener("click", closeEditModal);
    }
    
    if (btnSave) {
      btnSave.addEventListener("click", saveStory);
    } else {
      console.error('找不到 btn-save 按鈕');
    }

    // Dream List System (same structure as Story Plots)
    let dreams = [];

    // Mockup data for dreams
    const initialDreams = [
      // Husband dreams (3 items)
      {
        title: "每天玩弄老婆的身體",
        preview: "每天可以舔小穴，做愛，舔奶頭，喝小穴的水",
        content: "每天玩弄老婆的身體\n\n每天可以：\n- 舔小穴\n- 做愛\n- 舔奶頭\n- 喝小穴的水",
        person: "husband"
      },
      {
        title: "收入穩定",
        preview: "不用為錢擔心生活",
        content: "收入穩定，不用為錢擔心生活\n\n目標：\n- 有穩定的收入來源\n- 財務規劃完善\n- 生活無憂",
        person: "husband"
      },
      {
        title: "每天保持情色變態的愉悅",
        preview: "可以跟老婆每天保持情色變態的愉悅",
        content: "可以跟老婆每天保持情色變態的愉悅\n\n希望能夠：\n- 每天與老婆保持親密關係\n- 探索各種情色玩法\n- 享受變態帶來的愉悅",
        person: "husband"
      },
      // Wife dreams (3 items)
      {
        title: "開一家咖啡廳",
        preview: "打造屬於自己的咖啡空間",
        content: "夢想開一家溫馨的咖啡廳，提供優質的咖啡和甜點。\n\n理念：\n- 創造舒適的環境\n- 使用優質的咖啡豆\n- 提供美味的輕食",
        person: "wife"
      },
      {
        title: "學習攝影",
        preview: "用鏡頭記錄美好時刻",
        content: "想要學習攝影，用鏡頭記錄生活中的美好時刻。\n\n目標：\n- 掌握基本的攝影技巧\n- 學習後期處理\n- 舉辦個人攝影展",
        person: "wife"
      },
      {
        title: "學會做甜點",
        preview: "成為甜點達人",
        content: "學習製作各種精美的甜點，成為甜點達人。\n\n計劃：\n- 學習法式甜點製作\n- 嘗試各種創新口味\n- 分享給親朋好友",
        person: "wife"
      }
    ];

    // Supabase CRUD Functions for Dreams
    async function loadDreams() {
      if (!supabase) {
        console.warn('Supabase 未初始化，返回空数组');
        return [];
      }
      
      try {
        const { data, error } = await supabase
          .from('dreams')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('加载梦想失败:', error);
          return [];
        }
        return data || [];
      } catch (error) {
        console.error('加载梦想异常:', error);
        return [];
      }
    }

    async function addDream(title, preview, content, person = 'husband') {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法新增梦想');
        return null;
      }
      
      try {
        const { data, error } = await supabase
          .from('dreams')
          .insert([
            { title, preview, content, person }
          ])
          .select();
        
        if (error) {
          console.error('新增梦想失败:', error);
          return null;
        }
        return data[0];
      } catch (error) {
        console.error('新增梦想异常:', error);
        return null;
      }
    }

    async function updateDream(id, title, preview, content, person = 'husband') {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法更新梦想');
        return null;
      }
      
      try {
        const { data, error } = await supabase
          .from('dreams')
          .update({ 
            title, 
            preview, 
            content,
            person,
            updated_at: new Date().toISOString() 
          })
          .eq('id', id)
          .select();
        
        if (error) {
          console.error('更新梦想失败:', error);
          return null;
        }
        return data[0];
      } catch (error) {
        console.error('更新梦想异常:', error);
        return null;
      }
    }

    async function deleteDream(id) {
      if (!supabase) {
        console.warn('Supabase 未初始化，无法删除梦想');
        return false;
      }
      
      try {
        const { error } = await supabase
          .from('dreams')
          .delete()
          .eq('id', id);
        
        if (error) {
          console.error('删除梦想失败:', error);
          return false;
        }
        return true;
      } catch (error) {
        console.error('删除梦想异常:', error);
        return false;
      }
    }

    let currentDreamPerson = 'husband'; // Track current selected person for dreams

    function getDreamGrid() {
      if (currentDreamPerson === 'husband') {
        return document.getElementById("husband-dream-grid");
      } else {
        return document.getElementById("wife-dream-grid");
      }
    }

    function renderDreams() {
      const husbandGrid = document.getElementById("husband-dream-grid");
      const wifeGrid = document.getElementById("wife-dream-grid");
      
      if (husbandGrid) husbandGrid.innerHTML = "";
      if (wifeGrid) wifeGrid.innerHTML = "";
      
      dreams.forEach((dream, index) => {
        const person = dream.person || 'husband'; // Default to husband if not specified
        const targetGrid = person === 'husband' ? husbandGrid : wifeGrid;
        
        if (!targetGrid) return;
        
        const dreamCard = document.createElement("div");
        dreamCard.className = "story-card";
        dreamCard.innerHTML = `
          <div class="story-card-actions">
            <button class="story-card-menu-btn" data-index="${index}" title="選項">⋯</button>
            <div class="story-card-menu-dropdown">
              <div class="story-card-menu-item edit" data-action="edit" data-index="${index}">
                <span>✎</span>
                <span>編輯</span>
              </div>
              <div class="story-card-menu-item delete" data-action="delete" data-index="${index}">
                <span>×</span>
                <span>刪除</span>
              </div>
            </div>
          </div>
          <div class="story-card-title">${dream.title}</div>
          <div class="story-card-preview">${dream.preview}</div>
          <div class="story-card-meta">點擊查看完整內容 →</div>
        `;
        
        // 點擊卡片查看內容
        dreamCard.addEventListener("click", (e) => {
          if (!e.target.closest('.story-card-actions')) {
            openDreamModal(dream);
          }
        });
        
        // 三點按鈕點擊
        const menuBtn = dreamCard.querySelector('.story-card-menu-btn');
        const dropdown = dreamCard.querySelector('.story-card-menu-dropdown');
        
        menuBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          // 關閉其他打開的菜單
          document.querySelectorAll('.story-card-menu-dropdown.show').forEach(menu => {
            if (menu !== dropdown) {
              menu.classList.remove('show');
              menu.closest('.story-card-actions').querySelector('.story-card-menu-btn').classList.remove('active');
            }
          });
          
          // 切換當前菜單
          dropdown.classList.toggle('show');
          menuBtn.classList.toggle('active');
        });
        
        // 編輯選項
        const editItem = dreamCard.querySelector('.story-card-menu-item.edit');
        editItem.addEventListener("click", (e) => {
          e.stopPropagation();
          dropdown.classList.remove('show');
          menuBtn.classList.remove('active');
          openEditDreamModal(index);
        });
        
        // 刪除選項
        const deleteItem = dreamCard.querySelector('.story-card-menu-item.delete');
        deleteItem.addEventListener("click", async (e) => {
          e.stopPropagation();
          dropdown.classList.remove('show');
          menuBtn.classList.remove('active');
          if (confirm(`確定要刪除「${dream.title}」嗎？`)) {
            if (dream.id) {
              // If dream has id, delete from database
              const success = await deleteDream(dream.id);
              if (success) {
                dreams.splice(index, 1);
                renderDreams();
              }
            } else {
              // Mockup data, just remove from array
              dreams.splice(index, 1);
              renderDreams();
            }
          }
        });
        
        // 點擊外部關閉菜單
        document.addEventListener('click', (e) => {
          if (!dreamCard.contains(e.target)) {
            dropdown.classList.remove('show');
            menuBtn.classList.remove('active');
          }
        });
        
        targetGrid.appendChild(dreamCard);
      });
    }

    function parseDreamContent(content) {
      const lines = content.split('\n');
      let html = '';
      let prevWasMainTitle = false;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        if (!line) {
          // 減少空行的間距，只添加一個小的間距
          html += '<div style="height: 4px;"></div>';
          continue;
        }
        
        // 主标题 [角色扮演遊戲]
        if (line.startsWith('[') && line.endsWith(']')) {
          html += `<div class="article-main-title">${line}</div>`;
          prevWasMainTitle = true;
        }
        // 角色设定行（紧跟在主标题后，包含冒号的短行）
        else if (prevWasMainTitle && line.includes(':') && line.length < 30) {
          html += `<div class="article-role">${line}</div>`;
          prevWasMainTitle = false;
        }
        // 章节标题（包含"第X章｜"或"第四章｜合："）
        else if (/第[一二三四五六七八九十\d]+章｜/.test(line) || /第四章｜合：/.test(line)) {
          html += `<div class="article-chapter-title">${line}</div>`;
          prevWasMainTitle = false;
        }
        // 主题行（包含"主題："）
        else if (line.includes('主題：')) {
          html += `<div class="article-theme">${line}</div>`;
          prevWasMainTitle = false;
        }
        // 普通正文
        else {
          html += `<div class="article-content">${line}</div>`;
          prevWasMainTitle = false;
        }
      }
      
      return html;
    }

    function openDreamModal(dream) {
      // Use the same modal as story plots
      const modal = document.getElementById("story-modal");
      const modalTitle = document.getElementById("modal-title");
      const modalBody = document.getElementById("modal-body");
      
      modalTitle.textContent = dream.title;
      modalBody.innerHTML = parseStoryContent(dream.content);
      modal.classList.add("active");
    }

    function closeDreamModal() {
      // Use the same modal as story plots
      const modal = document.getElementById("story-modal");
      modal.classList.remove("active");
    }

    // Edit Dream Modal Functions
    let currentEditDreamIndex = -1;

    function openEditDreamModal(index) {
      currentEditDreamIndex = index;
      const editModal = document.getElementById("edit-dream-modal");
      const editTitle = document.getElementById("edit-dream-modal-title");
      const titleInput = document.getElementById("edit-dream-title");
      const previewInput = document.getElementById("edit-dream-preview");
      const contentInput = document.getElementById("edit-dream-content");
      const personSelect = document.getElementById("edit-dream-person");
      
      if (index === -1) {
        // 新增模式 - 使用當前選中的人物
        editTitle.textContent = "新增夢想";
        titleInput.value = "";
        previewInput.value = "";
        contentInput.value = "";
        if (personSelect) {
          personSelect.value = currentDreamPerson;
        }
      } else {
        // 編輯模式 - 使用夢想原有的人物
        editTitle.textContent = "編輯夢想";
        const dream = dreams[index];
        titleInput.value = dream.title;
        previewInput.value = dream.preview;
        contentInput.value = dream.content;
        if (personSelect) {
          personSelect.value = dream.person || 'husband';
        }
      }
      
      editModal.classList.add("active");
      titleInput.focus();
    }

    function closeEditDreamModal() {
      const editModal = document.getElementById("edit-dream-modal");
      editModal.classList.remove("active");
      currentEditDreamIndex = -1;
    }

    async function saveDream() {
      const titleInput = document.getElementById("edit-dream-title");
      const previewInput = document.getElementById("edit-dream-preview");
      const contentInput = document.getElementById("edit-dream-content");
      const personSelect = document.getElementById("edit-dream-person");
      
      const title = titleInput.value.trim();
      const preview = previewInput.value.trim();
      const content = contentInput.value.trim();
      const person = personSelect ? personSelect.value : currentDreamPerson;
      
      if (!title || !preview || !content) {
        alert("請填寫所有欄位");
        return;
      }
      
      if (currentEditDreamIndex === -1) {
        // 新增
        const newDream = await addDream(title, preview, content, person);
        if (newDream) {
          dreams.push(newDream);
          renderDreams();
          closeEditDreamModal();
        }
      } else {
        // 編輯
        const dream = dreams[currentEditDreamIndex];
        const updated = await updateDream(dream.id, title, preview, content, person);
        if (updated) {
          dreams[currentEditDreamIndex] = updated;
          renderDreams();
          closeEditDreamModal();
        }
      }
    }

    async function initDreams() {
      try {
        const loadedDreams = await loadDreams();
        if (loadedDreams.length > 0) {
          // Database has dreams, use them
          dreams = loadedDreams;
          renderDreams();
        } else {
          // Database is empty, use mockup data
          console.log('数据库为空，使用mockup数据');
          dreams = initialDreams;
          renderDreams();
          
          // Optionally import mockup data to database
          // for (const dream of initialDreams) {
          //   await addDream(dream.title, dream.preview, dream.content, dream.person);
          // }
        }
      } catch (error) {
        console.error('加载梦想时发生错误，使用mockup数据:', error);
        dreams = initialDreams;
        renderDreams();
      }
    }

    // Dream Modal Controls - use story modal (shared)
    // Modal controls are already set up for story-modal

    // Edit Dream Modal Controls
    const editDreamModalClose = document.getElementById("edit-dream-modal-close");
    if (editDreamModalClose) {
      editDreamModalClose.addEventListener("click", closeEditDreamModal);
    }
    const editDreamModal = document.getElementById("edit-dream-modal");
    if (editDreamModal) {
      editDreamModal.addEventListener("click", (e) => {
        if (e.target.id === "edit-dream-modal") {
          closeEditDreamModal();
        }
      });
    }
    const btnDreamCancel = document.getElementById("btn-dream-cancel");
    if (btnDreamCancel) {
      btnDreamCancel.addEventListener("click", closeEditDreamModal);
    }
    const btnDreamSave = document.getElementById("btn-dream-save");
    if (btnDreamSave) {
      btnDreamSave.addEventListener("click", saveDream);
    }

    // Article Edit Modal Controls
    document.getElementById("edit-article-modal-close").addEventListener("click", closeEditArticleModal);
    document.getElementById("edit-article-modal").addEventListener("click", (e) => {
      if (e.target.id === "edit-article-modal") {
        closeEditArticleModal();
      }
    });
    document.getElementById("btn-article-cancel").addEventListener("click", closeEditArticleModal);
    document.getElementById("btn-article-save").addEventListener("click", saveArticle);

    // Calendar Controls
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');
    const yearSelectorBtn = document.getElementById('year-selector-btn');
    const monthSelectorBtn = document.getElementById('month-selector-btn');
    const yearMonthModal = document.getElementById('year-month-modal');
    const yearMonthModalClose = document.getElementById('year-month-modal-close');
    const btnCloseArticles = document.getElementById('btn-close-articles');
    
    if (prevMonthBtn) {
      prevMonthBtn.addEventListener('click', prevMonth);
    }
    if (nextMonthBtn) {
      nextMonthBtn.addEventListener('click', nextMonth);
    }
    if (yearSelectorBtn) {
      yearSelectorBtn.addEventListener('click', () => openYearMonthSelector('year'));
    }
    if (monthSelectorBtn) {
      monthSelectorBtn.addEventListener('click', () => openYearMonthSelector('month'));
    }
    if (yearMonthModalClose) {
      yearMonthModalClose.addEventListener('click', closeYearMonthSelector);
    }
    if (yearMonthModal) {
      yearMonthModal.addEventListener('click', (e) => {
        if (e.target.id === 'year-month-modal') {
          closeYearMonthSelector();
        }
      });
    }
    if (btnCloseArticles) {
      btnCloseArticles.addEventListener('click', () => {
        document.getElementById('date-articles-container').style.display = 'none';
        selectedDate = null;
      });
    }
    
    // Close date articles container when clicking on background
    const dateArticlesContainer = document.getElementById('date-articles-container');
    if (dateArticlesContainer) {
      dateArticlesContainer.addEventListener('click', (e) => {
        // Only close if clicking directly on the container background, not on inner content
        if (e.target === dateArticlesContainer || e.target.classList.contains('date-articles-container')) {
          dateArticlesContainer.style.display = 'none';
          selectedDate = null;
        }
      });
      
      // Prevent closing when clicking on inner content
      const dateArticlesInner = dateArticlesContainer.querySelector('.date-articles-inner');
      if (dateArticlesInner) {
        dateArticlesInner.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }
    }

    // Schedule Controls
    const btnAddSchedule = document.getElementById('btn-add-schedule');
    const scheduleModal = document.getElementById('schedule-modal');
    const scheduleModalClose = document.getElementById('schedule-modal-close');
    const scheduleBtnCancel = document.getElementById('schedule-btn-cancel');
    const scheduleBtnSave = document.getElementById('schedule-btn-save');
    
    if (btnAddSchedule) {
      btnAddSchedule.addEventListener('click', () => {
        if (!selectedDate) {
          alert('請先選擇日期');
          return;
        }
        openEditScheduleModal(-1);
      });
    }
    
    if (scheduleModalClose) {
      scheduleModalClose.addEventListener('click', closeEditScheduleModal);
    }
    
    if (scheduleModal) {
      scheduleModal.addEventListener('click', (e) => {
        if (e.target.id === 'schedule-modal') {
          closeEditScheduleModal();
        }
      });
    }
    
    if (scheduleBtnCancel) {
      scheduleBtnCancel.addEventListener('click', closeEditScheduleModal);
    }
    
    if (scheduleBtnSave) {
      scheduleBtnSave.addEventListener('click', saveSchedule);
    }

    // Keyboard support for modals (ESC key)
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const storyModal = document.getElementById("story-modal");
        const editModal = document.getElementById("edit-story-modal");
        const editDreamModal = document.getElementById("edit-dream-modal");
        const articleModal = document.getElementById("edit-article-modal");
        const yearMonthModal = document.getElementById("year-month-modal");
        const scheduleModal = document.getElementById("schedule-modal");
        const dateArticlesContainer = document.getElementById("date-articles-container");
        
        if (storyModal && storyModal.classList.contains("active")) {
          closeStoryModal();
        } else if (editModal && editModal.classList.contains("active")) {
          closeEditModal();
        } else if (editDreamModal && editDreamModal.classList.contains("active")) {
          closeEditDreamModal();
        } else if (articleModal && articleModal.classList.contains("active")) {
          closeEditArticleModal();
        } else if (yearMonthModal && yearMonthModal.classList.contains("active")) {
          closeYearMonthSelector();
        } else if (scheduleModal && scheduleModal.classList.contains("active")) {
          closeEditScheduleModal();
        } else if (dateArticlesContainer && dateArticlesContainer.style.display !== 'none') {
          dateArticlesContainer.style.display = 'none';
          selectedDate = null;
        }
      }
    });

    // Floating Add Story/Dream Button
    const floatingAddBtn = document.getElementById('floating-add-story-btn');
    if (floatingAddBtn) {
      // Floating button is no longer used for story plots - using inline button instead
      // Keep the handler for backward compatibility, but it won't be visible
      floatingAddBtn.addEventListener('click', () => {
        // This should not be triggered anymore, but kept for safety
      });
      
      // Hide floating button - using inline button in story plots header instead
      floatingAddBtn.style.display = 'none';
      
      // Add click handler for inline story plots add button
      const storyPlotsAddBtn = document.getElementById('story-plots-add-btn');
      if (storyPlotsAddBtn) {
        storyPlotsAddBtn.addEventListener('click', () => {
          openEditModal(-1);
        });
      }
    }


    // Initialize - Load stories from Supabase
    // Wait for DOM and Supabase library to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        // Wait a bit for Supabase library to load
        setTimeout(() => {
          if (!supabase && window.supabase) {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase 连接成功（延迟初始化）');
          }
          initStories();
          initDreams();
          initArticles();
          initTruthDareGame();
        }, 100);
      });
    } else {
      // DOM already loaded
      setTimeout(() => {
        if (!supabase && window.supabase) {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log('Supabase 连接成功（延迟初始化）');
        }
        initStories();
        initDreams();
        initArticles();
        initTruthDareGame();
      }, 100);
    }
  </script>
</body>
</html>
